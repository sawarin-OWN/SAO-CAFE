<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SAO CAFE APP</title>
    
    <link rel="icon" href="https://storage.googleapis.com/glide-prod.appspot.com/uploads-v2/ZPQ1QSrzcL0RxpekC12M/pub/iHel4QU56KUUXyOtzaCo.png">
    <link rel="apple-touch-icon" href="https://storage.googleapis.com/glide-prod.appspot.com/uploads-v2/ZPQ1QSrzcL0RxpekC12M/pub/LfolY3an8LNo51RM9Ilo.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
      body { 
          font-family: 'Prompt', sans-serif; 
          background-color: #f3f4f6; 
          -webkit-tap-highlight-color: transparent;
          overscroll-behavior-y: none;
      }
      .h-dvh { height: 100vh; height: 100dvh; }
      ::-webkit-scrollbar { width: 4px; height: 4px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .fade-in { animation: fadeIn 0.3s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
      .slide-up-modal { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
      @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
      .sidebar-active { background-color: #374151; border-left: 4px solid #ffffff; color: white !important; font-weight: 600; }
      .sidebar-item { transition: all 0.2s ease; border-left: 4px solid transparent; }
      .sidebar-item:hover { background-color: #1f2937; color: white; }
      
      /* Safe Area for Mobile */
      .pt-safe { padding-top: env(safe-area-inset-top); }
      .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
      
      /* Hide browser default password toggle */
      input[type="password"]::-webkit-credentials-auto-fill-button,
      input[type="password"]::-webkit-strong-password-auto-fill-button {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }
      
      /* Hide Edge password reveal button */
      input[type="password"]::-ms-reveal {
        display: none !important;
      }
      
      @media print {
        @page { size: auto; margin: 10mm; }
        body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        body * { visibility: hidden; }
        #print-section, #print-section * { visibility: visible; }
        #print-section { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; z-index: 9999; }
        #root { display: none; }
      }
      
      /* Loading Screen Animations */
      @keyframes float {
        0%, 100% { transform: translateY(0px) scale(1); }
        50% { transform: translateY(-20px) scale(1.05); }
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(0.95); }
      }
      
      @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        25% { transform: translateY(-10px); }
        50% { transform: translateY(0); }
        75% { transform: translateY(-5px); }
      }
      
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      
      @keyframes dotPulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.5); opacity: 0.7; }
      }
      
      @keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      
      .loading-float {
        animation: float 3s ease-in-out infinite;
      }
      
      .loading-pulse {
        animation: pulse 2s ease-in-out infinite;
      }
      
      .loading-bounce {
        animation: bounce 2s ease-in-out infinite;
      }
      
      .loading-spin {
        animation: spin 1s linear infinite;
      }
      
      .loading-dot {
        animation: dotPulse 1.4s ease-in-out infinite;
      }
      
      .loading-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      
      .loading-dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      
      .gradient-bg {
        background: linear-gradient(-45deg, #1f2937, #374151, #4b5563, #6b7280);
        background-size: 400% 400%;
        animation: gradient 8s ease infinite;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <div id="print-section"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useCallback } = React;
      
      // --- Constants ---
      // ** Updated API URL (Latest 25/12/2025) **
      const API_URL = "https://script.google.com/macros/s/AKfycbyI90Z35-5FhH48L1cWSpnjhX91aiIDBnVZrXoEonppKpkn7B5ZWzlJW_dA1pFQbiUl/exec"; 
      const THEME_COLOR = '#16a34a'; // สีเขียว (green-600)
      const LOGO_URL = "https://storage.googleapis.com/glide-prod.appspot.com/uploads-v2/ZPQ1QSrzcL0RxpekC12M/pub/AJVIBB1tCHPDCBonCFs4.png";
      
      const SHOP_INFO = {
          name: "บริษัท ไชยจันลา จำกัด (สำนักงานใหญ่)",
          address: "966 ถนนประชาราษฎร์1 แขวงบางซื่อ เขตบางซื่อ กรุงเทพมหานคร 10800 \nโทร. 061-732-1346",
          taxId: "0105567121929",
          signature: "https://storage.googleapis.com/glide-prod.appspot.com/uploads-v2/ZPQ1QSrzcL0RxpekC12M/pub/kbZT6vI8ZsnJaJWsYzmP.png"
      };

      const SHOP_ADDRESS_TEXT = `บริษัท ไชยจันลา จำกัด (สำนักงานใหญ่) 
966 ถนนประชาราษฎร์1 แขวงบางซื่อ เขตบางซื่อ กรุงเทพ 10800 
โทร. 061-732-1346 
เลขประจำตัวผู้เสียภาษี 0105567121929`;

       // --- Helper Functions ---
      const Icon = ({ icon, className }) => <i className={`fas ${icon} ${className || ''}`}></i>;

      const parseThaiDate = (dateStr) => {
        if (!dateStr) return null;
        try {
          const parts = dateStr.split(' ')[0].split('/');
          if (parts.length !== 3) return null;
          let year = parseInt(parts[2], 10);
          if (year > 2400) year -= 543; 
          const date = new Date(year, parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
          // Normalize เวลาเป็น 00:00:00 เพื่อการเปรียบเทียบที่ถูกต้อง
          date.setHours(0, 0, 0, 0);
          return date;
        } catch (e) { return null; }
      };

      // Helper function สำหรับแปลงวันที่จาก ISO format (YYYY-MM-DD) เป็น Date object และ normalize เวลา
      const parseISODate = (dateStr) => {
        if (!dateStr) return null;
        try {
          const date = new Date(dateStr + 'T00:00:00'); // ใส่เวลา 00:00:00 เพื่อหลีกเลี่ยง timezone issues
          date.setHours(0, 0, 0, 0); // Normalize เวลาเป็น 00:00:00
          return date;
        } catch (e) { return null; }
      };

      async function callAPI(payload) {
        try {
            const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
            return await res.json();
        } catch (e) { 
            console.error("API Error:", e); 
            return { success: false, message: "Connection Failed" }; 
        }
      }

      // --- Pagination ---
      const Pagination = ({ totalItems, itemsPerPage, currentPage, onPageChange }) => {
         const totalPages = Math.ceil(totalItems / itemsPerPage);
         if (totalItems === 0) return null;
         return (
            <div className="flex flex-col sm:flex-row justify-between items-center gap-4 mt-6 px-2 pb-8 border-t border-gray-200 pt-4 text-gray-500">
               <div className="text-xs">แสดง {Math.min((currentPage - 1) * itemsPerPage + 1, totalItems)} - {Math.min(currentPage * itemsPerPage, totalItems)} จาก {totalItems} รายการ</div>
               <div className="flex items-center gap-2">
                  <button onClick={() => onPageChange(Math.max(1, currentPage - 1))} disabled={currentPage === 1} className="p-2 rounded hover:bg-gray-100 disabled:opacity-30"><Icon icon="fa-chevron-left"/></button>
                  <span className="px-3 py-1 text-sm bg-white border rounded flex items-center">{currentPage} / {totalPages}</span>
                  <button onClick={() => onPageChange(Math.min(totalPages, currentPage + 1))} disabled={currentPage === totalPages} className="p-2 rounded hover:bg-gray-100 disabled:opacity-30"><Icon icon="fa-chevron-right"/></button>
               </div>
            </div>
         );
      };

      const App = () => {
        const [page, setPage] = useState('login');
        const [user, setUser] = useState(null);
        const [cart, setCart] = useState([]);
        const [products, setProducts] = useState([]);
        const [orders, setOrders] = useState([]); 
        const [allOrders, setAllOrders] = useState([]); 
        const [purchaseOrders, setPurchaseOrders] = useState([]);
        const [isLoading, setIsLoading] = useState(false);
        const [isInitialLoading, setIsInitialLoading] = useState(true);
        
        // Frontend Caching (Phase 1)
        const [productsCache, setProductsCache] = useState(null);
        const [productsCacheTimestamp, setProductsCacheTimestamp] = useState(null);
        const [ordersCache, setOrdersCache] = useState(null);
        const [ordersCacheTimestamp, setOrdersCacheTimestamp] = useState(null);
        const [allOrdersCache, setAllOrdersCache] = useState(null);
        const [allOrdersCacheTimestamp, setAllOrdersCacheTimestamp] = useState(null);
        const [purchaseOrdersCache, setPurchaseOrdersCache] = useState(null);
        const [purchaseOrdersCacheTimestamp, setPurchaseOrdersCacheTimestamp] = useState(null);
        const [franchiseStockCache, setFranchiseStockCache] = useState(null);
        const [franchiseStockCacheTimestamp, setFranchiseStockCacheTimestamp] = useState(null);
        const CACHE_DURATION = 5 * 60 * 1000; // 5 นาที
        const [isSidebarOpen, setIsSidebarOpen] = useState(false);
        const [isCartOpen, setIsCartOpen] = useState(false); 
        const [isCheckoutOpen, setIsCheckoutOpen] = useState(false);
        const [isEditModalOpen, setIsEditModalOpen] = useState(false);
        const [editingOrder, setEditingOrder] = useState(null);
        const [editingOrderDiff, setEditingOrderDiff] = useState(0); 
        const [isPOModalOpen, setIsPOModalOpen] = useState(false);
        const [isReceivePOModalOpen, setIsReceivePOModalOpen] = useState(false);
        const [isAddProductModalOpen, setIsAddProductModalOpen] = useState(false);
        const [isEditProductModalOpen, setIsEditProductModalOpen] = useState(false);
        const [editingProduct, setEditingProduct] = useState(null);
        const [selectedPO, setSelectedPO] = useState(null);
        const [poItems, setPoItems] = useState([]);
        const [poSupplier, setPoSupplier] = useState('');
        const [poExpectedDate, setPoExpectedDate] = useState('');
        const [poNotes, setPoNotes] = useState('');
        const [poStatusFilter, setPoStatusFilter] = useState('All');
        const [poProductSearch, setPoProductSearch] = useState('');
        const [stockAlertSearch, setStockAlertSearch] = useState('');
        const [franchiseStockAlertSearch, setFranchiseStockAlertSearch] = useState('');
        const [poSearchTerm, setPoSearchTerm] = useState(''); 

        // Dashboard state
        const [dashboardData, setDashboardData] = useState({
            totalSales: 0,
            totalOrders: 0,
            topProducts: [],
            topUsers: []
        });
        const [dashboardStartDate, setDashboardStartDate] = useState('');
        const [dashboardEndDate, setDashboardEndDate] = useState('');
        const [isDashboardLoading, setIsDashboardLoading] = useState(false);

        // Bulk shipping state
        const [selectedOrdersForShipping, setSelectedOrdersForShipping] = useState([]);
        const [trackingNumbers, setTrackingNumbers] = useState({}); // { orderId: trackingNumber }
        const [isBulkShippingModalOpen, setIsBulkShippingModalOpen] = useState(false);

        // Franchise state
        const [franchiseStock, setFranchiseStock] = useState([]);
        const [franchisePOs, setFranchisePOs] = useState([]);
        const [franchiseStockLog, setFranchiseStockLog] = useState([]);
        const [franchiseStockSearchTerm, setFranchiseStockSearchTerm] = useState('');
        const [franchiseStockLogStartDate, setFranchiseStockLogStartDate] = useState('');
        const [franchiseStockLogEndDate, setFranchiseStockLogEndDate] = useState('');
        const [isAddFranchiseProductModalOpen, setIsAddFranchiseProductModalOpen] = useState(false);
        const [isImportFromOrderModalOpen, setIsImportFromOrderModalOpen] = useState(false);
        const [availableProducts, setAvailableProducts] = useState([]);
        const [isBulkEditModalOpen, setIsBulkEditModalOpen] = useState(false);
        const [bulkEditItems, setBulkEditItems] = useState([]);
        const [ordersWithImportStatus, setOrdersWithImportStatus] = useState([]);
        const [selectedProductsForBulkEdit, setSelectedProductsForBulkEdit] = useState([]);
        const [franchiseProductForm, setFranchiseProductForm] = useState({
            productId: '',
            name: '',
            image: '',
            price: 0,
            stock: 0,
            category: '',
            detail: '',
            supplier: '',
            unit: 'ชิ้น',
            weight: 0,
            minStock: 5,
            franchisePrice: 0
        });

        // Password visibility state
        const [showPassword, setShowPassword] = useState(false);

        const [searchTerm, setSearchTerm] = useState('');
        const [stockSearchTerm, setStockSearchTerm] = useState(''); 
        const [searchResults, setSearchResults] = useState([]);
        const [isSearching, setIsSearching] = useState(false);
        const [searchTimeout, setSearchTimeout] = useState(null);
        const [stockSearchResults, setStockSearchResults] = useState([]);
        const [isStockSearching, setIsStockSearching] = useState(false);
        const [stockSearchTimeout, setStockSearchTimeout] = useState(null); 
        const [selectedCategory, setSelectedCategory] = useState('All');
        const [selectedSupplier, setSelectedSupplier] = useState('All'); 
        
        const [discountAmount, setDiscountAmount] = useState(0);
        const [appliedCoupon, setAppliedCoupon] = useState(null);
        const [loginForm, setLoginForm] = useState({ email: '', password: '' });
        const [slipFile, setSlipFile] = useState(null);
        const [shippingCost, setShippingCost] = useState(0);
        
        const [promoImage, setPromoImage] = useState('');
        const [currentPage, setCurrentPage] = useState(1);
        const [stockManagementPage, setStockManagementPage] = useState(1);
        const [stockAlertPage, setStockAlertPage] = useState(1);
        const [franchiseStockPage, setFranchiseStockPage] = useState(1);
        const [franchiseStockAlertPage, setFranchiseStockAlertPage] = useState(1);
        const itemsPerPage = 50;

        const [dateStart, setDateStart] = useState('');
        const [dateEnd, setDateEnd] = useState('');
        const [dateStartInput, setDateStartInput] = useState(''); // สำหรับเก็บค่าที่เลือก (รอกดปุ่มค้นหา)
        const [dateEndInput, setDateEndInput] = useState(''); // สำหรับเก็บค่าที่เลือก (รอกดปุ่มค้นหา)
        const [adminStatusFilter, setAdminStatusFilter] = useState('All');
        const [orderSearchTerm, setOrderSearchTerm] = useState(''); // ค้นหาแบบ real-time (ไม่ต้องกดปุ่ม)
        const [franchiseStockLogSearchTerm, setFranchiseStockLogSearchTerm] = useState(''); // ค้นหาแบบ real-time (ไม่ต้องกดปุ่ม)

        const [profileForm, setProfileForm] = useState({ username: '', phone: '', address: '' });
        const [taxForm, setTaxForm] = useState({ taxName: '', taxId: '', taxAddr: '' });
        
        // Tax Invoice Modal state (for admin)
        const [isTaxInvoiceModalOpen, setIsTaxInvoiceModalOpen] = useState(false);
        const [editingOrderForTax, setEditingOrderForTax] = useState(null);
        const [taxInvoiceForm, setTaxInvoiceForm] = useState({
            taxName: '',
            taxId: '',
            taxAddress: '',
            items: [],
            subtotal: 0,
            discount: 0,
            shipping: 0,
            total: 0,
            vat: 0,
            preVat: 0
        });
        const [taxInvoiceRecordedStatus, setTaxInvoiceRecordedStatus] = useState({}); // { orderId: { recorded: boolean, data: {...} } }

        const showError = (text) => Swal.fire({ icon: 'error', title: 'แจ้งเตือน', text, confirmButtonColor: '#d33' });
        const showSuccess = (title, text) => Swal.fire({ icon: 'success', title, text, confirmButtonColor: THEME_COLOR });
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
        

        // --- Fetch Data ---
        const fetchProducts = useCallback(async (forceRefresh = false) => { 
            try {
                // ตรวจสอบ cache
                if (!forceRefresh && productsCache && productsCacheTimestamp) {
                    const now = Date.now();
                    if (now - productsCacheTimestamp < CACHE_DURATION) {
                        console.log('Using cached products');
                        setProducts(productsCache);
                        return { success: true, products: productsCache };
                    }
                }
                
                // ดึงข้อมูลใหม่
                const res = await callAPI({ action: 'getProducts', userEmail: user?.email || null }); 
                if (res && res.success) {
                    setProductsCache(res.products || []);
                    setProductsCacheTimestamp(Date.now());
                    setProducts(res.products || []);
                }
                return res || { success: false };
            } catch (error) {
                console.error('Error fetching products:', error);
                return { success: false, message: error.message || 'Unknown error' };
            }
        }, [user, productsCache, productsCacheTimestamp]);

        const fetchHistory = useCallback(async (silent=false, forceRefresh = false) => {
            // ตรวจสอบ cache
            if (!forceRefresh && ordersCache && ordersCacheTimestamp) {
                const now = Date.now();
                if (now - ordersCacheTimestamp < CACHE_DURATION) {
                    console.log('Using cached orders');
                    setOrders(ordersCache);
                    return { success: true, orders: ordersCache };
                }
            }
            
            if(!silent) Swal.fire({ title: 'กำลังโหลด...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            const res = await callAPI({ action: 'getMyOrders', email: user?.email });
            if(!silent) Swal.close();
            if (res.success) {
                setOrdersCache(res.orders);
                setOrdersCacheTimestamp(Date.now());
                setOrders(res.orders);
            }
            return res;
        }, [user, ordersCache, ordersCacheTimestamp]);
        
        const fetchAllOrders = useCallback(async (silent=false, forceRefresh = false) => {
            // ตรวจสอบ cache
            if (!forceRefresh && allOrdersCache && allOrdersCacheTimestamp) {
                const now = Date.now();
                if (now - allOrdersCacheTimestamp < CACHE_DURATION) {
                    console.log('Using cached all orders');
                    setAllOrders(allOrdersCache);
                    return { success: true, orders: allOrdersCache };
                }
            }
            
            if(!silent) Swal.fire({ title: 'กำลังดึงข้อมูล...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            const res = await callAPI({ action: 'getAllOrders' });
            if(!silent) Swal.close();
            if (res.success) {
                setAllOrdersCache(res.orders);
                setAllOrdersCacheTimestamp(Date.now());
                setAllOrders(res.orders);
            }
            return res;
        }, [allOrdersCache, allOrdersCacheTimestamp]);

        const fetchPOs = useCallback(async (silent=false, forceRefresh = false) => {
            // ตรวจสอบ cache
            if (!forceRefresh && purchaseOrdersCache && purchaseOrdersCacheTimestamp) {
                const now = Date.now();
                if (now - purchaseOrdersCacheTimestamp < CACHE_DURATION) {
                    console.log('Using cached purchase orders');
                    setPurchaseOrders(purchaseOrdersCache);
                    return { success: true, pos: purchaseOrdersCache };
                }
            }
            
            if(!silent) Swal.fire({ title: 'กำลังดึงข้อมูล...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            const res = await callAPI({ action: 'getPOs' });
            if(!silent) Swal.close();
            if (res.success) {
                setPurchaseOrdersCache(res.pos);
                setPurchaseOrdersCacheTimestamp(Date.now());
                setPurchaseOrders(res.pos);
            }
            return res;
        }, [purchaseOrdersCache, purchaseOrdersCacheTimestamp]);

        const fetchFranchiseStock = useCallback(async (silent=false, forceRefresh = false) => {
            if (!user?.email) return { success: false, message: 'User not logged in' };
            
            // ตรวจสอบ cache
            if (!forceRefresh && franchiseStockCache && franchiseStockCacheTimestamp) {
                const now = Date.now();
                if (now - franchiseStockCacheTimestamp < CACHE_DURATION) {
                    console.log('Using cached franchise stock');
                    setFranchiseStock(franchiseStockCache);
                    return { success: true, products: franchiseStockCache };
                }
            }
            
            if(!silent) Swal.fire({ title: 'กำลังดึงข้อมูล...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                const res = await callAPI({ action: 'getFranchiseStock', userEmail: user.email });
                if(!silent) Swal.close();
                if (res.success) {
                    setFranchiseStockCache(res.products || []);
                    setFranchiseStockCacheTimestamp(Date.now());
                    setFranchiseStock(res.products || []);
                }
                return res;
            } catch (error) {
                if(!silent) Swal.close();
                return { success: false, message: error.message || 'Unknown error' };
            }
        }, [user, franchiseStockCache, franchiseStockCacheTimestamp]);

        const fetchFranchisePOs = useCallback(async (silent=false, forceRefresh = false) => {
            if (!user?.email) return { success: false, message: 'User not logged in' };
            if(!silent) Swal.fire({ title: 'กำลังดึงข้อมูล...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                const res = await callAPI({ action: 'getFranchisePOs', userEmail: user.email });
                if(!silent) Swal.close();
                if (res.success) setFranchisePOs(res.pos || []);
                return res;
            } catch (error) {
                if(!silent) Swal.close();
                return { success: false, message: error.message || 'Unknown error' };
            }
        }, [user]);

        const fetchFranchiseStockLog = useCallback(async (silent=false, forceRefresh = false) => {
            if (!user?.email) return { success: false, message: 'User not logged in' };
            if(!silent) Swal.fire({ title: 'กำลังดึงข้อมูล...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                const res = await callAPI({ 
                    action: 'getFranchiseStockLog', 
                    userEmail: user.email,
                    startDate: franchiseStockLogStartDate || null,
                    endDate: franchiseStockLogEndDate || null
                });
                if(!silent) Swal.close();
                if (res.success) setFranchiseStockLog(res.logs || []);
                return res;
            } catch (error) {
                if(!silent) Swal.close();
                return { success: false, message: error.message || 'Unknown error' };
            }
        }, [user, franchiseStockLogStartDate, franchiseStockLogEndDate]); // จะถูกเรียกเมื่อ franchiseStockLogStartDate หรือ franchiseStockLogEndDate เปลี่ยน (real-time)

        const fetchDashboardData = useCallback(async (silent = false) => {
            setIsDashboardLoading(true);
            try {
                if (!silent) {
                    Swal.fire({ title: 'กำลังดึงข้อมูล...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                }
                const res = await callAPI({ 
                    action: 'getDashboardData',
                    startDate: dashboardStartDate || null,
                    endDate: dashboardEndDate || null
                });
                if (!silent) Swal.close();
                if (res.success) {
                    setDashboardData({
                        totalSales: res.totalSales || 0,
                        totalOrders: res.totalOrders || 0,
                        topProducts: res.topProducts || [],
                        topUsers: res.topUsers || []
                    });
                } else {
                    if (!silent) showError(res.message || 'เกิดข้อผิดพลาดในการดึงข้อมูลแดชบอร์ด');
                }
            } catch (error) {
                if (!silent) {
                    Swal.close();
                    showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
                }
            } finally {
                setIsDashboardLoading(false);
            }
        }, [dashboardStartDate, dashboardEndDate]);

        const changePage = (newPage) => {
            if(newPage === page) return;
            setIsSidebarOpen(false);
            // Reset pagination when changing pages
            if(newPage !== 'admin_stock') setStockManagementPage(1);
            if(newPage !== 'stock_alert') setStockAlertPage(1);
            if(newPage !== 'franchise_stock_alert') setFranchiseStockAlertPage(1);
            
            if(['admin_orders', 'history', 'tax_invoice', 'profile', 'purchase_order', 'stock_alert', 'admin_dashboard', 'franchise_stock', 'franchise_stock_alert', 'franchise_po', 'franchise_stock_log'].includes(newPage)) {
                const promises = [];
                let needsLoading = false;
                
                if(newPage === 'admin_orders' || (newPage === 'tax_invoice' && user?.role === 'admin')) {
                    promises.push(fetchAllOrders(true));
                    needsLoading = true;
                }
                if(newPage === 'history' || (newPage === 'tax_invoice' && user?.role !== 'admin')) {
                    promises.push(fetchHistory(true));
                    needsLoading = true;
                }
                if(newPage === 'purchase_order') {
                    promises.push(fetchPOs(true));
                    needsLoading = true;
                }
                if(newPage === 'admin_dashboard') {
                    promises.push(fetchDashboardData(true));
                    needsLoading = true;
                }
                if(newPage === 'franchise_stock' && user?.customerType === 'franchise') {
                    promises.push(fetchFranchiseStock(true));
                    needsLoading = true;
                }
                if(newPage === 'franchise_stock_alert' && user?.customerType === 'franchise') {
                    promises.push(fetchFranchiseStock(true));
                    needsLoading = true;
                }
                if(newPage === 'franchise_po' && user?.customerType === 'franchise') {
                    promises.push(fetchFranchisePOs(true));
                    needsLoading = true;
                }
                if(newPage === 'franchise_stock_log' && user?.customerType === 'franchise') {
                    promises.push(fetchFranchiseStockLog(true));
                    needsLoading = true;
                }
                if(newPage === 'franchise_stock' && user?.customerType === 'franchise') {
                    // ดึงข้อมูลออเดอร์ด้วยเพื่อใช้ใน Import From Order
                    promises.push(fetchHistory(true));
                }
                
                // ตรวจสอบว่ามี promises หรือไม่ และต้องแสดง loading หรือไม่
                if (promises.length > 0 && needsLoading) {
                    // แสดงป๊อปอัพกำลังโหลดข้อมูล
                    Swal.fire({ 
                        title: 'กำลังโหลดข้อมูล...', 
                        didOpen: () => Swal.showLoading(), 
                        allowOutsideClick: false 
                    });
                    
                    // ใช้ Promise.allSettled เพื่อรอให้ทุก promise เสร็จ
                    Promise.allSettled(promises).then(() => { 
                        // ใช้ setTimeout เพื่อให้แน่ใจว่า Swal container ถูกจัดการแล้ว
                        setTimeout(() => {
                            Swal.close();
                            setPage(newPage);
                        }, 50);
                    });
                } else {
                    setPage(newPage);
                }
            } else { setPage(newPage); }
        };

        // --- Effects ---
        useEffect(() => { 
           const initApp = async () => {
               setIsInitialLoading(true);
               const storedUser = localStorage.getItem('partner_user');
               
               // ดึง products โดยไม่ต้องใช้ user (สำหรับหน้าแรก)
               const [prodRes, promoRes] = await Promise.all([
                   callAPI({ action: 'getProducts', userEmail: null }),
                   callAPI({ action: 'getPromoConfig' })
               ]);
               if (prodRes && prodRes.success) setProducts(prodRes.products || []);
               if (promoRes.success && promoRes.enabled) setPromoImage(promoRes.image);

               if (storedUser) {
                  const u = JSON.parse(storedUser); 
                  setUser(u);
                  // Update Profile Form on Init
                  setProfileForm({ username: u.username, phone: u.phone, address: u.address });
                  setTaxForm({ taxName: u.taxName || '', taxId: u.taxId || '', taxAddr: u.taxAddr || '' });
                  
                  // ดึง products อีกครั้งด้วย user email เพื่อแสดงราคาที่ถูกต้อง
                  const userProdRes = await callAPI({ action: 'getProducts', userEmail: u.email });
                  if (userProdRes && userProdRes.success) setProducts(userProdRes.products || []);

                  if (u.role === 'admin') {
                      await fetchAllOrders(true);
                      setPage('admin_orders'); 
                  } else {
                      setPage('home'); 
                  }
               }
               // ปิด initial loading screen หลังจากโหลดข้อมูลเสร็จ
               setTimeout(() => {
                   setIsInitialLoading(false);
               }, 100);
           };
           initApp();
        }, []); // เปลี่ยน dependency เป็น [] เพื่อให้เรียกแค่ครั้งเดียวตอน mount

        useEffect(() => {
            if (page === 'profile' && user) setProfileForm({ username: user.username, phone: user.phone, address: user.address });
            if (page === 'tax_invoice' && user) setTaxForm({ taxName: user.taxName || '', taxId: user.taxId || '', taxAddr: user.taxAddr || '' });
        }, [page, user]);
        
        // ตรวจสอบสถานะการบันทึกข้อมูลภาษีของออเดอร์ที่ชำระเงินแล้ว (สำหรับแอดมิน)
        useEffect(() => {
            if (user?.role === 'admin' && allOrders.length > 0) {
                const paidOrders = allOrders.filter(o => o.status === 'ชำระเงินแล้ว' || o.status === 'จัดส่งแล้ว');
                paidOrders.forEach(order => {
                    if (!taxInvoiceRecordedStatus[order.id]) {
                        checkOrderTaxInvoiceStatus(order.id);
                    }
                });
            }
        }, [allOrders, user]);
        
        // ตรวจสอบสถานะการบันทึกข้อมูลภาษีของออเดอร์ที่ชำระเงินแล้ว (สำหรับลูกค้า)
        useEffect(() => {
            if (user?.role !== 'admin' && orders.length > 0) {
                const eligibleOrders = orders.filter(o => o.status === 'ชำระเงินแล้ว' || o.status === 'จัดส่งแล้ว');
                eligibleOrders.forEach(order => {
                    if (!taxInvoiceRecordedStatus[order.id]) {
                        checkOrderTaxInvoiceStatus(order.id);
                    }
                });
            }
        }, [orders, user]);

        useEffect(() => {
            if (editingOrder && allOrders.length > 0) {
                const originalOrder = allOrders.find(o => o.id === editingOrder.id);
                if (originalOrder) {
                    const newSubtotal = editingOrder.items.reduce((s,i)=>s+i.price*i.qty,0);
                    let discVal = 0; const match = String(originalOrder.discountInfo).match(/-(\d+)B/); if (match) discVal = parseInt(match[1]);
                    const shipping = Number(originalOrder.shippingCost) || 0; 
                    const newTotal = Math.max(0, newSubtotal - discVal + shipping);
                    setEditingOrderDiff(newTotal - (Number(originalOrder.total) || 0));
                }
            }
        }, [editingOrder, allOrders]);

        useEffect(() => {
           if (cart.length > 0) {
              // คำนวณน้ำหนักรวม: น้ำหนักต่อชิ้น x จำนวน
              const totalWeight = cart.reduce((sum, item) => {
                  const itemWeight = Number(item.weight) || 0;
                  const itemQty = Number(item.qty) || 0;
                  return sum + (itemWeight * itemQty);
              }, 0);
              
              // ตรวจสอบว่า totalWeight เป็นตัวเลขที่ถูกต้อง
              if (isNaN(totalWeight) || totalWeight < 0) {
                  console.error('Invalid totalWeight:', totalWeight, cart);
                  setShippingCost(0);
                  return;
              }
              
              const getShipping = async () => {
                  try {
                      // Log สำหรับ debug
                      console.log('Calculating shipping for weight:', totalWeight, 'grams');
                      
                      const res = await callAPI({ action: 'calculateShipping', totalWeight: totalWeight });
                      if (res && res.success) {
                          const cost = Number(res.cost) || 0;
                          
                          // ตรวจสอบว่าค่าจัดส่งสมเหตุสมผลหรือไม่ (ไม่ควรเกิน 10,000)
                          if (cost > 10000) {
                              console.error('Shipping cost too high:', cost, 'Setting to 0');
                              setShippingCost(0);
                              showError('ค่าจัดส่งผิดปกติ กรุณาติดต่อแอดมิน');
                          } else {
                              console.log('Shipping cost calculated:', cost);
                              setShippingCost(cost);
                          }
                      } else {
                          console.error('Failed to calculate shipping:', res);
                          setShippingCost(0);
                      }
                  } catch (error) {
                      console.error('Error calculating shipping:', error);
                      setShippingCost(0);
                  }
              };
              getShipping();
           } else { 
               setShippingCost(0); 
           }
        }, [cart]);

        const filteredAdminOrders = useMemo(() => {
            let filtered = allOrders;
            if (dateStart || dateEnd) {
                // Parse วันที่จาก input (ISO format: YYYY-MM-DD)
                const start = dateStart ? parseISODate(dateStart) : null;
                const end = dateEnd ? parseISODate(dateEnd) : null;
                if (end) {
                    end.setHours(23, 59, 59, 999); // ตั้งเวลาเป็น 23:59:59.999 สำหรับวันสุดท้าย
                }
                
                filtered = filtered.filter(order => {
                    // Parse วันที่จาก order.date (รูปแบบไทย: DD/M/YYYY หรือ DD/MM/YYYY)
                    const oDate = parseThaiDate(order.date);
                    // ตรวจสอบว่า oDate ไม่ใช่ null ก่อนเปรียบเทียบ
                    if (!oDate) return false;
                    
                    // เปรียบเทียบวันที่
                    if (start && oDate < start) return false;
                    if (end && oDate > end) return false;
                    return true;
                });
            }
            if (adminStatusFilter !== 'All') {
                filtered = filtered.filter(order => order.status === adminStatusFilter);
            }
            // ค้นหาตาม orderSearchTerm (Order ID, Email, Username, Address)
            if (orderSearchTerm.trim() !== '') {
                const searchLower = orderSearchTerm.toLowerCase().trim();
                filtered = filtered.filter(order => 
                    (order.id && order.id.toLowerCase().includes(searchLower)) ||
                    (order.user && order.user.toLowerCase().includes(searchLower)) ||
                    (order.username && order.username.toLowerCase().includes(searchLower)) ||
                    (order.address && order.address.toLowerCase().includes(searchLower))
                );
            }
            return filtered;
        }, [allOrders, dateStart, dateEnd, adminStatusFilter, orderSearchTerm]);

        const adminStats = useMemo(() => {
            let baseOrders = allOrders;
            if (dateStart || dateEnd) {
                // Parse วันที่จาก input (ISO format: YYYY-MM-DD)
                const start = dateStart ? parseISODate(dateStart) : null;
                const end = dateEnd ? parseISODate(dateEnd) : null;
                if (end) {
                    end.setHours(23, 59, 59, 999); // ตั้งเวลาเป็น 23:59:59.999 สำหรับวันสุดท้าย
                }
                
                baseOrders = baseOrders.filter(order => {
                    // Parse วันที่จาก order.date (รูปแบบไทย: DD/M/YYYY หรือ DD/MM/YYYY)
                    const oDate = parseThaiDate(order.date);
                    // ตรวจสอบว่า oDate ไม่ใช่ null ก่อนเปรียบเทียบ
                    if (!oDate) return false;
                    
                    // เปรียบเทียบวันที่
                    if (start && oDate < start) return false;
                    if (end && oDate > end) return false;
                    return true;
                });
            }
            return {
                totalSales: baseOrders.reduce((acc, o) => acc + (Number(o.total) || 0), 0),
                totalOrders: baseOrders.length,
                pending: baseOrders.filter(o => o.status === 'รอตรวจสอบ').length,
                paid: baseOrders.filter(o => o.status === 'ชำระเงินแล้ว').length,
                shipped: baseOrders.filter(o => o.status === 'จัดส่งแล้ว').length,
            };
        }, [allOrders, dateStart, dateEnd]);

        const uniqueSuppliers = useMemo(() => ['All', ...new Set(products.map(p => p.supplier).filter(Boolean))], [products]);
        
        // Search function with debounce for home page
        const performSearch = useCallback(async (term) => {
            if (!term || term.trim() === '') {
                setSearchResults([]);
                setIsSearching(false);
                return;
            }
            
            setIsSearching(true);
            try {
                console.log('Searching for:', term);
                const res = await callAPI({ action: 'searchProducts', searchTerm: term, userEmail: user?.email || null });
                console.log('Search result:', res);
                if (res && res.success) {
                    const products = res.products || [];
                    console.log('Found products:', products.length);
                    setSearchResults(products);
                } else {
                    console.log('Search failed or no results');
                    setSearchResults([]);
                }
            } catch (error) {
                console.error('Search error:', error);
                setSearchResults([]);
            } finally {
                setIsSearching(false);
            }
        }, [user]);
        
        // Debounce search for home page
        useEffect(() => {
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            if (searchTerm.trim() !== '') {
                const timeout = setTimeout(() => {
                    performSearch(searchTerm);
                }, 500); // 500ms debounce
                setSearchTimeout(timeout);
            } else {
                setSearchResults([]);
                setIsSearching(false);
            }
            
            return () => {
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
            };
        }, [searchTerm, performSearch]);
        
        // Search function for stock management
        const performStockSearch = useCallback(async (term) => {
            if (!term || term.trim() === '') {
                setStockSearchResults([]);
                setIsStockSearching(false);
                return;
            }
            
            setIsStockSearching(true);
            try {
                console.log('Stock searching for:', term);
                const res = await callAPI({ action: 'searchProducts', searchTerm: term, userEmail: user?.email || null });
                console.log('Stock search result:', res);
                if (res && res.success) {
                    const products = res.products || [];
                    console.log('Found stock products:', products.length);
                    setStockSearchResults(products);
                } else {
                    console.log('Stock search failed or no results');
                    setStockSearchResults([]);
                }
            } catch (error) {
                console.error('Stock search error:', error);
                setStockSearchResults([]);
            } finally {
                setIsStockSearching(false);
            }
        }, [user]);
        
        // Debounce search for stock management
        useEffect(() => {
            if (stockSearchTimeout) {
                clearTimeout(stockSearchTimeout);
            }
            
            if (stockSearchTerm.trim() !== '') {
                const timeout = setTimeout(() => {
                    performStockSearch(stockSearchTerm);
                }, 500); // 500ms debounce
                setStockSearchTimeout(timeout);
            } else {
                setStockSearchResults([]);
                setIsStockSearching(false);
            }
            
            return () => {
                if (stockSearchTimeout) {
                    clearTimeout(stockSearchTimeout);
                }
            };
        }, [stockSearchTerm, performStockSearch]);
        
        // Real-time search for franchise stock log - debounce date changes
        useEffect(() => {
            if (page === 'franchise_stock_log' && user?.customerType === 'franchise') {
                const timeout = setTimeout(() => {
                    fetchFranchiseStockLog(true); // silent mode
                }, 500); // 500ms debounce
                
                return () => clearTimeout(timeout);
            }
        }, [franchiseStockLogStartDate, franchiseStockLogEndDate, page, user, fetchFranchiseStockLog]);
        
        // Filter ก่อน pagination - ใช้ searchResults ถ้ามีการค้นหา
        const filteredProductsList = useMemo(() => {
            // ถ้ามีการค้นหา (searchTerm มีค่า) ให้ใช้ searchResults เสมอ (แม้จะว่างก็ตาม)
            // เพราะ searchResults มาจากการค้นหาจากฐานข้อมูลทั้งหมด
            if (searchTerm.trim() !== '') {
                // ใช้ searchResults ที่ค้นหาจาก backend แล้ว และ filter ด้วย category และ supplier
                return searchResults.filter(p => {
             const matchCat = selectedCategory === 'All' || p.category === selectedCategory;
             const matchSup = selectedSupplier === 'All' || p.supplier === selectedSupplier;
                    return matchCat && matchSup;
                });
            } else {
                // ถ้าไม่มี searchTerm ใช้ products และ filter ด้วย category และ supplier
                return products.filter(p => {
                    const matchCat = selectedCategory === 'All' || p.category === selectedCategory;
                    const matchSup = selectedSupplier === 'All' || p.supplier === selectedSupplier;
                    return matchCat && matchSup;
                });
            }
        }, [products, searchResults, searchTerm, selectedCategory, selectedSupplier]);
        // Pagination หลังจาก filter
        const displayedProducts = filteredProductsList.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

        // Stock Alert: คำนวณสินค้าที่สต็อกต่ำ
        const lowStockProducts = useMemo(() => {
            return products.filter(p => {
                const stock = Number(p.stock) || 0;
                const minStock = Number(p.minStock) || 5;
                return stock <= minStock;
            }).sort((a, b) => {
                const aStock = Number(a.stock) || 0;
                const bStock = Number(b.stock) || 0;
                return aStock - bStock; // เรียงจากสต็อกน้อยไปมาก
            });
        }, [products]);

        // Filter ก่อน pagination - ค้นหาจากทั้งหมด
        const filteredLowStockProducts = useMemo(() => {
            return lowStockProducts.filter(p => 
                p.name.toLowerCase().includes(stockAlertSearch.toLowerCase())
            );
        }, [lowStockProducts, stockAlertSearch]);
        
        // Filter และ paginate franchise stock
        const filteredFranchiseStock = useMemo(() => {
            return franchiseStock.filter(p => 
                p.name.toLowerCase().includes(franchiseStockSearchTerm.toLowerCase())
            );
        }, [franchiseStock, franchiseStockSearchTerm]);
        
        const displayedFranchiseStock = useMemo(() => {
            return filteredFranchiseStock.slice(
                (franchiseStockPage - 1) * itemsPerPage,
                franchiseStockPage * itemsPerPage
            );
        }, [filteredFranchiseStock, franchiseStockPage]);
        
        // Franchise Stock Alert: คำนวณสินค้าที่สต็อกต่ำจาก franchiseStock
        const lowStockFranchiseProducts = useMemo(() => {
            return franchiseStock.filter(p => {
                const stock = Number(p.stock) || 0;
                const minStock = Number(p.minStock) || 5;
                return stock <= minStock;
            }).sort((a, b) => {
                const aStock = Number(a.stock) || 0;
                const bStock = Number(b.stock) || 0;
                return aStock - bStock; // เรียงจากสต็อกน้อยไปมาก
            });
        }, [franchiseStock]);
        
        // Filter ก่อน pagination - ค้นหาจากทั้งหมด
        const filteredLowStockFranchiseProducts = useMemo(() => {
            return lowStockFranchiseProducts.filter(p => 
                p.name.toLowerCase().includes(franchiseStockAlertSearch.toLowerCase())
            );
        }, [lowStockFranchiseProducts, franchiseStockAlertSearch]);

        // นับจำนวนสินค้าที่สต็อกต่ำ
        const lowStockCount = lowStockProducts.length;

        // --- Handlers ---
        const handleLogin = async (e) => { 
          e.preventDefault(); 
          Swal.fire({ 
              title: 'กำลังเข้าสู่ระบบ...', 
              didOpen: () => Swal.showLoading(), 
              allowOutsideClick: false 
          });
          const res = await callAPI({ action: 'login', email: loginForm.email, password: loginForm.password });
          Swal.close();
          if (res.success) { 
              setUser(res.user); 
              localStorage.setItem('partner_user', JSON.stringify(res.user)); 
              // Set tax info immediately after login
              setTaxForm({ taxName: res.user.taxName || '', taxId: res.user.taxId || '', taxAddr: res.user.taxAddr || '' });

              if (res.user.role === 'admin') { await fetchAllOrders(true); setPage('admin_orders'); } 
              else { setPage('home'); }
          } else { showError(res.message); } 
        };

        const handleLogout = () => { 
            Swal.fire({ 
                title: 'ออกจากระบบ?', 
                icon: 'warning', 
                showCancelButton: true, 
                confirmButtonColor: THEME_COLOR, 
                confirmButtonText: 'ยืนยัน', 
                cancelButtonText: 'ยกเลิก' 
            }).then((result) => { 
                if (result.isConfirmed) { 
                    setUser(null); 
                    setPage('login'); 
                    localStorage.removeItem('partner_user'); 
                } 
            }); 
        };

        const handleUpdateProfile = async () => { 
            Swal.fire({ 
                title: 'กำลังบันทึกข้อมูล...', 
                didOpen: () => Swal.showLoading(), 
                allowOutsideClick: false 
            });
            const res = await callAPI({ action: 'updateProfile', email: user.email, ...profileForm }); 
            Swal.close();
            if(res.success) { 
                const newUser = { ...user, ...profileForm }; 
                setUser(newUser); 
                localStorage.setItem('partner_user', JSON.stringify(newUser)); 
                showSuccess('สำเร็จ', 'บันทึกข้อมูลเรียบร้อย'); 
            } else { 
                showError(res.message); 
            } 
        };
        const handleUpdateTax = async () => { 
            Swal.fire({ 
                title: 'กำลังบันทึกข้อมูล...', 
                didOpen: () => Swal.showLoading(), 
                allowOutsideClick: false 
            });
            const res = await callAPI({ action: 'updateTaxProfile', email: user.email, ...taxForm }); 
            Swal.close();
            if(res.success) { 
                const newUser = { ...user, ...taxForm }; 
                setUser(newUser); 
                localStorage.setItem('partner_user', JSON.stringify(newUser)); 
                showSuccess('สำเร็จ', 'บันทึกข้อมูลภาษีเรียบร้อย'); 
            } else { 
                showError(res.message); 
            } 
        };

        const addToCart = (product, quantity) => { 
           if (cart.length > 0) { const currentSup = cart[0].supplier || 'Unknown'; const newSup = product.supplier || 'Unknown'; if (currentSup !== newSup) { showError(`กรุณาสั่งสินค้าของร้าน "${currentSup}" ให้เสร็จก่อน`); return; } }
           const existing = cart.find(item => item.id === product.id); 
           const currentTotalInCart = existing ? existing.qty : 0;
           if (currentTotalInCart + quantity > product.stock) { showError(`สินค้าในคลังเหลือเพียง ${product.stock} ${product.unit || 'ชิ้น'}`); return; }
           if (existing) { setCart(cart.map(item => item.id === product.id ? { ...item, qty: item.qty + quantity } : item)); } 
           else { setCart([...cart, { ...product, qty: quantity }]); } 
           setAppliedCoupon(null); setDiscountAmount(0); Toast.fire({ icon: 'success', title: `เพิ่มลงตะกร้าเรียบร้อย` }); 
        };

        const handleAddToCartClick = (product) => {
            if (product.stock <= 0) { showError('ขออภัย สินค้าหมดสต็อก'); return; }
            Swal.fire({ title: product.name, text: `ระบุจำนวน (เหลือ ${product.stock})`, input: 'number', inputValue: 1, showCancelButton: true, confirmButtonColor: THEME_COLOR }).then((res) => { 
                if(res.value && parseInt(res.value) > 0) {
                    if(parseInt(res.value) > product.stock) { Swal.fire('เกินสต็อก', `ระบุจำนวนได้ไม่เกิน ${product.stock}`, 'warning'); } 
                    else { addToCart(product, parseInt(res.value)); }
                } 
            });
        };

        const updateQty = (id, delta) => { 
            const item = cart.find(i => i.id === id); 
            if (item) { 
                const newQty = item.qty + delta; 
                if (newQty <= 0) { setCart(cart.filter(i => i.id !== id)); }
                else {
                    const originalProd = products.find(p => p.id === id);
                    if (originalProd && newQty > originalProd.stock) { showError(`เกินสต็อกที่มีอยู่ (${originalProd.stock})`); return; }
                    setCart(cart.map(i => i.id === id ? { ...i, qty: newQty } : i)); 
                }
                setAppliedCoupon(null); setDiscountAmount(0); 
            } 
        };

        const updateQtyDirect = (id, value) => {
            const item = cart.find(i => i.id === id);
            if (!item) return;

            // แปลงเป็นตัวเลข
            let newQty = parseInt(value) || 0;
            
            // ตรวจสอบว่าต้องเป็นตัวเลขและมากกว่า 0
            if (isNaN(newQty) || newQty < 1) {
                newQty = 1; // ตั้งค่าเป็น 1 ถ้าน้อยกว่า 1
            }

            const originalProd = products.find(p => p.id === id);
            if (originalProd && newQty > originalProd.stock) {
                showError(`เกินสต็อกที่มีอยู่ (${originalProd.stock})`);
                newQty = originalProd.stock; // ตั้งค่าเป็นสต็อกสูงสุด
            }

            setCart(cart.map(i => i.id === id ? { ...i, qty: newQty } : i));
            setAppliedCoupon(null);
            setDiscountAmount(0);
        };

        const openEditModal = (order) => { setEditingOrder(JSON.parse(JSON.stringify(order))); setIsEditModalOpen(true); };
        const updateEditQty = (idx, delta) => {
            const newItems = [...editingOrder.items];
            newItems[idx].qty += delta;
            if (newItems[idx].qty <= 0) {
                newItems.splice(idx, 1);
            }
            setEditingOrder({ ...editingOrder, items: newItems });
        };

        const updateEditQtyDirect = (idx, value) => {
            const newItems = [...editingOrder.items];
            let newQty = parseInt(value) || 1;
            if (isNaN(newQty) || newQty < 1) {
                newQty = 1;
            }
            newItems[idx].qty = newQty;
            setEditingOrder({ ...editingOrder, items: newItems });
        };
        
        const updateEditPrice = async (idx, newPrice) => {
            if (!user || user.role !== 'admin') {
                showError('เฉพาะแอดมินเท่านั้นที่สามารถแก้ไขราคาได้');
                return;
            }
            
            const result = await Swal.fire({
                title: 'แก้ไขราคา',
                text: `เปลี่ยนราคาจาก ฿${editingOrder.items[idx].price.toLocaleString()} เป็น ฿${Number(newPrice).toLocaleString()}?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: THEME_COLOR
            });
            
            if (result.isConfirmed) {
                Swal.fire({ title: 'กำลังอัพเดท...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
                try {
                    const res = await callAPI({ 
                        action: 'updateOrderItemPrice', 
                        orderId: editingOrder.id, 
                        itemIndex: idx, 
                        newPrice: Number(newPrice),
                        userEmail: user.email
                    });
                    Swal.close();
                    if (res.success) {
                        // อัพเดทราคาใน state
                        const newItems = [...editingOrder.items];
                        newItems[idx].price = Number(newPrice);
                        setEditingOrder({ ...editingOrder, items: newItems, total: res.newTotal });
                        Toast.fire({ icon: 'success', title: 'อัพเดทราคาเรียบร้อย' });
                    } else {
                        showError(res.message || 'เกิดข้อผิดพลาดในการอัพเดทราคา');
                    }
                } catch (error) {
                    Swal.close();
                    showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
                }
            }
        };
        const saveEditOrder = async () => {
             let msg = 'ยืนยันการแก้ไข?';
             if (editingOrderDiff > 0) msg = `ยอดเงินเพิ่มขึ้น ${editingOrderDiff.toLocaleString()} บาท (ต้องเก็บเพิ่ม)`;
             else if (editingOrderDiff < 0) msg = `ยอดเงินลดลง ${Math.abs(editingOrderDiff).toLocaleString()} บาท (ต้องคืนเงิน)`;
             Swal.fire({title:'บันทึกการแก้ไข', text: msg, showCancelButton:true, confirmButtonText:'ยืนยัน', confirmButtonColor: THEME_COLOR}).then(async (r)=>{
                 if(r.isConfirmed) {
                    Swal.fire({ title: 'กำลังทำรายการ...', text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    try {
                        const res = await callAPI({ action: 'editOrder', orderId: editingOrder.id, newItems: editingOrder.items, userEmail: user.email });
                        if (res.success) { 
                            // อัพเดท popup เป็น success
                            Swal.fire({
                                icon: 'success',
                                title: 'ทำรายการเสร็จแล้ว',
                                text: 'อัปเดตข้อมูลแล้ว',
                                confirmButtonText: 'เสร็จสิ้น',
                                allowOutsideClick: false
                            }).then(async (result) => {
                                if (result.isConfirmed) {
                                    setIsEditModalOpen(false);
                                    
                                    // เรียก fetchAllOrders ใน silent mode โดยไม่แสดง loading popup
                                    // เพราะข้อมูลจะอัพเดททันทีโดยไม่ต้องแสดง loading screen
                                    await fetchAllOrders(true, true);
                                }
                            });
                        } else { 
                            Swal.close();
                            showError(res.message); 
                        }
                    } catch (error) {
                        Swal.close();
                        showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
                    }
                 }
             });
        };

        const updateOrderStatusFn = async (orderId, status, tracking = '') => {
            Swal.fire({ title: 'กำลังทำรายการ...', text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            const res = await callAPI({ action: 'updateOrderStatus', orderId, status, tracking });
            if (res.success) { 
                // อัพเดท popup เดิมเป็น success (ไม่ปิดและเปิดใหม่)
                Swal.fire({
                    icon: 'success',
                    title: 'ทำรายการเสร็จแล้ว',
                    text: `อัปเดตเป็น ${status} แล้ว`,
                    confirmButtonText: 'เสร็จสิ้น',
                    allowOutsideClick: false
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        // หลังจากผู้ใช้กดเสร็จสิ้น ให้ refresh ข้อมูลใน silent mode (ไม่แสดง loading popup)
                        // เรียก fetchAllOrders ใน silent mode โดยไม่แสดง loading popup
                        await fetchAllOrders(true, true); // silent=true, forceRefresh=true
                    }
                });
            } 
            else { 
                Swal.close();
                showError('เกิดข้อผิดพลาด'); 
            }
        };

        const handleShipOrder = (orderId) => { Swal.fire({ title: 'แจ้งเลขพัสดุ', input: 'text', showCancelButton: true, confirmButtonColor: THEME_COLOR }).then((res) => { if (res.isConfirmed) updateOrderStatusFn(orderId, 'จัดส่งแล้ว', res.value); }); };

        const toggleOrderSelection = (orderId) => {
            setSelectedOrdersForShipping(prev => {
                if (prev.includes(orderId)) {
                    // ถ้าเลือกอยู่แล้ว ให้ยกเลิกการเลือก
                    const newTracking = { ...trackingNumbers };
                    delete newTracking[orderId];
                    setTrackingNumbers(newTracking);
                    return prev.filter(id => id !== orderId);
                } else {
                    // ถ้ายังไม่เลือก ให้เพิ่ม
                    return [...prev, orderId];
                }
            });
        };

        const handleTrackingNumberChange = (orderId, value) => {
            setTrackingNumbers(prev => ({
                ...prev,
                [orderId]: value
            }));
        };

        const handleBulkShipOrders = async () => {
            const ordersToShip = selectedOrdersForShipping.filter(orderId => {
                const tracking = trackingNumbers[orderId]?.trim();
                return tracking && tracking.length > 0;
            });

            if (ordersToShip.length === 0) {
                showError('กรุณาเลือกออเดอร์และกรอกเลขพัสดุอย่างน้อย 1 รายการ');
                return;
            }

            try {
                Swal.fire({ 
                    title: 'กำลังทำรายการ...',
                    text: `กำลังส่งสินค้า ${ordersToShip.length} รายการ...`, 
                    allowOutsideClick: false, 
                    didOpen: () => Swal.showLoading() 
                });

                const promises = ordersToShip.map(orderId => 
                    callAPI({ 
                        action: 'updateOrderStatus', 
                        orderId, 
                        status: 'จัดส่งแล้ว', 
                        tracking: trackingNumbers[orderId].trim() 
                    })
                );

                const results = await Promise.all(promises);
                const successCount = results.filter(r => r.success).length;
                const failCount = results.length - successCount;
                
                if (failCount === 0) {
                    // อัพเดท popup เป็น success
                    Swal.fire({
                        icon: 'success',
                        title: 'ทำรายการเสร็จแล้ว',
                        text: `ส่งสินค้า ${successCount} รายการเรียบร้อย`,
                        confirmButtonText: 'เสร็จสิ้น',
                        allowOutsideClick: false
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            setSelectedOrdersForShipping([]);
                            setTrackingNumbers({});
                            setIsBulkShippingModalOpen(false);
                            
                            // เปิด popup ใหม่สำหรับ loading (ไม่ใช้ update เพราะ popup เดิมปิดแล้ว)
                            Swal.fire({
                                title: 'กำลังอัพเดทข้อมูล...',
                                text: 'กรุณารอสักครู่',
                                allowOutsideClick: false,
                                didOpen: () => Swal.showLoading()
                            });
                            
                            // เรียก fetchAllOrders ใน silent mode
                            await fetchAllOrders(true, true);
                            
                            // ใช้ setTimeout เพื่อให้แน่ใจว่า Swal container ยังอยู่ใน DOM ก่อนที่จะปิด
                            // และให้ React re-render ก่อนที่จะปิด Swal
                            await new Promise(resolve => setTimeout(resolve, 100));
                            
                            // ปิด Swal หลังจากอัพเดทข้อมูลเสร็จ
                            // ตรวจสอบว่ายังมี Swal container อยู่ก่อนปิด
                            if (document.querySelector('.swal2-container')) {
                                Swal.close();
                            }
                        }
                    });
                } else {
                    // อัพเดท popup เป็น error
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: `ส่งสำเร็จ ${successCount} รายการ, ล้มเหลว ${failCount} รายการ`,
                        confirmButtonText: 'เสร็จสิ้น',
                        allowOutsideClick: false
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            // เรียก fetchAllOrders ใน silent mode โดยไม่แสดง loading popup
                            await fetchAllOrders(true, true);
                        }
                    });
                }
            } catch (error) {
                Swal.close();
                showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
            }
        };
        const handleEditStock = (product) => { 
            Swal.fire({ title: `แก้ไขสต็อก: ${product.name}`, input: 'number', inputValue: product.stock, showCancelButton: true, confirmButtonColor: THEME_COLOR }).then((res) => { 
                if (res.isConfirmed) {
                    Swal.fire({ title: 'กำลังอัปเดต...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                     callAPI({ action: 'updateProductStock', productId: product.id, newStock: parseInt(res.value) }).then(r => {
                        Swal.close();
                         if(r.success) { Toast.fire({icon:'success',title:'สต็อกอัปเดตแล้ว'}); fetchProducts(true); }
                        else { showError('เกิดข้อผิดพลาดในการอัปเดตสต็อก'); }
                    }).catch(error => {
                        Swal.close();
                        showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
                     });
                }
            }); 
        };

        const openEditProductModal = (product) => {
            setEditingProduct(product);
            setEditProductForm({
                name: product.name || '',
                image: product.image || '',
                price: product.price || '',
                stock: product.stock || '',
                category: product.category || '',
                detail: product.detail || '',
                supplier: product.supplier || '',
                unit: product.unit || 'ชิ้น',
                weight: product.weight || '',
                minStock: product.minStock || '5',
                franchisePrice: product.franchisePrice || '',
                cost: product.cost || ''
            });
            setIsEditProductModalOpen(true);
        };

        const handleUpdateProduct = async () => {
            if (!editingProduct) return;

            // Validation
            if (!editProductForm.name || !editProductForm.name.trim()) {
                showError('กรุณากรอกชื่อสินค้า');
                return;
            }
            if (!editProductForm.price || Number(editProductForm.price) <= 0) {
                showError('กรุณากรอกราคาที่ถูกต้อง');
                return;
            }

            try {
                Swal.fire({ title: 'กำลังอัปเดตสินค้า...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                const res = await callAPI({
                    action: 'updateProduct',
                    productId: editingProduct.id,
                    productData: {
                        name: editProductForm.name.trim(),
                        image: editProductForm.image.trim() || '',
                        price: Number(editProductForm.price) || 0,
                        stock: Number(editProductForm.stock) || 0,
                        category: editProductForm.category.trim() || '',
                        detail: editProductForm.detail.trim() || '',
                        supplier: editProductForm.supplier.trim() || '',
                        unit: editProductForm.unit.trim() || 'ชิ้น',
                        weight: Number(editProductForm.weight) || 0,
                        minStock: Number(editProductForm.minStock) || 5,
                        franchisePrice: Number(editProductForm.franchisePrice) || Number(editProductForm.price) || 0,
                        cost: Number(editProductForm.cost) || 0
                    },
                    userEmail: user.email
                });
                Swal.close();

                if (res && res.success) {
                    showSuccess('สำเร็จ', 'อัปเดตข้อมูลสินค้าเรียบร้อย');
                    setIsEditProductModalOpen(false);
                    setEditingProduct(null);
                    fetchProducts(true);
                } else {
                    showError(res?.message || 'เกิดข้อผิดพลาดในการอัปเดตสินค้า');
                }
            } catch (error) {
                Swal.close();
                showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
            }
        };

        const handleRestock = (product) => {
             Swal.fire({ title: `เติมสต็อก: ${product.name}`, text: 'ระบุจำนวนที่ต้องการเติมเพิ่ม (+)', input: 'number', inputValue: 0, showCancelButton: true, confirmButtonColor: THEME_COLOR }).then((res) => {
                 if(res.isConfirmed && res.value > 0) {
                    Swal.fire({ title: 'กำลังเติมสต็อก...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                     callAPI({ action: 'restockProduct', productId: product.id, qty: parseInt(res.value), note: 'Admin Restock', userEmail: user.email }).then(r => {
                        Swal.close();
                         if(r.success) { Toast.fire({icon:'success',title:`เติมสต็อก +${res.value} เรียบร้อย`}); fetchProducts(true); }
                        else { showError('เกิดข้อผิดพลาดในการเติมสต็อก'); }
                    }).catch(error => {
                        Swal.close();
                        showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
                     });
                 }
             });
        };

        const handleAddFranchiseProduct = async () => {
            if (!franchiseProductForm.name || !franchiseProductForm.name.trim()) {
                showError('กรุณากรอกชื่อสินค้า');
                return;
            }
            if (!franchiseProductForm.franchisePrice || Number(franchiseProductForm.franchisePrice) <= 0) {
                showError('กรุณากรอกราคาสินค้า');
                return;
            }

            try {
                Swal.fire({ title: 'กำลังเพิ่มสินค้า...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
                const res = await callAPI({
                    action: 'addFranchiseProduct',
                    productData: {
                        productId: franchiseProductForm.productId || '',
                        name: franchiseProductForm.name,
                        image: franchiseProductForm.image || '',
                        price: Number(franchiseProductForm.franchisePrice) || 0, // ใช้ franchisePrice เป็น price
                        stock: Number(franchiseProductForm.stock) || 0,
                        category: franchiseProductForm.category || '',
                        detail: franchiseProductForm.detail || '',
                        supplier: franchiseProductForm.supplier || '',
                        unit: franchiseProductForm.unit || 'ชิ้น',
                        weight: Number(franchiseProductForm.weight) || 0,
                        minStock: Number(franchiseProductForm.minStock) || 5,
                        franchisePrice: Number(franchiseProductForm.franchisePrice) || 0
                    },
                    userEmail: user.email
                });
                Swal.close();

                if (res && res.success) {
                    showSuccess('สำเร็จ', `เพิ่มสินค้า ${res.productId} เรียบร้อย`);
                    setIsAddFranchiseProductModalOpen(false);
                    setFranchiseProductForm({
                        productId: '',
                        name: '',
                        image: '',
                        price: 0,
                        stock: 0,
                        category: '',
                        detail: '',
                        supplier: '',
                        unit: 'ชิ้น',
                        weight: 0,
                        minStock: 5,
                        franchisePrice: 0
                    });
                    fetchFranchiseStock(true, true);
                } else {
                    showError(res?.message || 'เกิดข้อผิดพลาดในการเพิ่มสินค้า');
                }
            } catch (error) {
                Swal.close();
                showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
            }
        };

        const fetchOrdersWithImportStatus = useCallback(async () => {
            if (!user?.email) return;
            try {
                const res = await callAPI({
                    action: 'getOrdersWithImportStatus',
                    userEmail: user.email
                });
                if (res && res.success) {
                    setOrdersWithImportStatus(res.orders || []);
                }
            } catch (error) {
                console.error('Error fetching orders with import status:', error);
            }
        }, [user?.email]);

        const handleImportFromOrder = async (orderId) => {
            try {
                Swal.fire({ title: 'กำลังนำเข้าสินค้า...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
                const res = await callAPI({
                    action: 'importFromOrder',
                    orderId: orderId,
                    userEmail: user.email
                });
                Swal.close();

                if (res && res.success) {
                    showSuccess('สำเร็จ', res.message || `นำเข้าสินค้า ${res.importedProducts?.length || 0} รายการเรียบร้อย`);
                    fetchFranchiseStock(true, true);
                    fetchOrdersWithImportStatus(); // รีเฟรชสถานะออเดอร์
                } else {
                    if (res?.alreadyImported) {
                        showError('ออเดอร์นี้ถูกดึงเข้ามาแล้ว');
                        fetchOrdersWithImportStatus(); // รีเฟรชสถานะออเดอร์
                    } else {
                        showError(res?.message || 'เกิดข้อผิดพลาดในการนำเข้าสินค้า');
                    }
                }
            } catch (error) {
                Swal.close();
                showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
            }
        };

        const openBulkEditModal = () => {
            // เตรียมข้อมูลสำหรับ bulk edit
            const items = filteredFranchiseStock.map(p => ({
                    productId: p.id,
                    name: p.name,
                    currentStock: p.stock,
                    action: 'set', // set, add, subtract
                    value: p.stock,
                    note: ''
                }));
            setBulkEditItems(items);
            setIsBulkEditModalOpen(true);
        };

        const handleBulkUpdateStock = async () => {
            // กรองเฉพาะรายการที่มีการเปลี่ยนแปลง
            const updates = bulkEditItems
                .filter(item => {
                    if (item.action === 'set') {
                        return Number(item.value) !== Number(item.currentStock);
                    } else if (item.action === 'add' || item.action === 'subtract') {
                        return Number(item.value) > 0;
                    }
                    return false;
                })
                .map(item => ({
                    productId: item.productId,
                    action: item.action,
                    value: Number(item.value) || 0,
                    note: item.note || ''
                }));

            if (updates.length === 0) {
                showError('กรุณาแก้ไขสต็อกอย่างน้อย 1 รายการ');
                return;
            }

            try {
                Swal.fire({ 
                    title: `กำลังอัปเดต ${updates.length} รายการ...`, 
                    allowOutsideClick: false, 
                    didOpen: () => Swal.showLoading() 
                });
                
                const res = await callAPI({
                    action: 'bulkUpdateFranchiseStock',
                    updates: updates,
                    userEmail: user.email
                });
                
                Swal.close();

                if (res && res.success) {
                    const successCount = res.results.filter(r => r.success).length;
                    showSuccess('สำเร็จ', `อัปเดตสต็อก ${successCount} รายการเรียบร้อย`);
                    setIsBulkEditModalOpen(false);
                    setSelectedProductsForBulkEdit([]); // ล้างการเลือก
                    fetchFranchiseStock(true, true);
                } else {
                    showError(res?.message || 'เกิดข้อผิดพลาดในการอัปเดตสต็อก');
                }
            } catch (error) {
                Swal.close();
                showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
            }
        };

        // State สำหรับฟอร์มเพิ่มสินค้า
        const [productForm, setProductForm] = useState({
            productId: '',
            name: '',
            image: '',
            price: '',
            stock: '',
            category: '',
            detail: '',
            supplier: '',
            unit: 'ชิ้น',
            weight: '',
            minStock: '5',
            franchisePrice: '',
            cost: ''
        });

        // State สำหรับฟอร์มแก้ไขสินค้า
        const [editProductForm, setEditProductForm] = useState({
            name: '',
            image: '',
            price: '',
            stock: '',
            category: '',
            detail: '',
            supplier: '',
            unit: 'ชิ้น',
            weight: '',
            minStock: '5',
            franchisePrice: '',
            cost: ''
        });

        const openAddProductModal = () => {
            setProductForm({
                productId: '',
                name: '',
                image: '',
                price: '',
                stock: '0',
                category: '',
                detail: '',
                supplier: '',
                unit: 'ชิ้น',
                weight: '',
                minStock: '5',
                franchisePrice: '',
                cost: ''
            });
            setIsAddProductModalOpen(true);
        };

        const handleAddProduct = async () => {
            // Validation
            if (!productForm.name || !productForm.name.trim()) {
                showError('กรุณากรอกชื่อสินค้า');
                return;
            }
            if (!productForm.price || Number(productForm.price) <= 0) {
                showError('กรุณากรอกราคาที่ถูกต้อง');
                return;
            }

            try {
                Swal.fire({ title: 'กำลังเพิ่มสินค้า...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                const res = await callAPI({
                    action: 'addProduct',
                    productData: {
                        productId: productForm.productId || undefined, // ถ้าไม่กรอกจะสร้างอัตโนมัติ
                        name: productForm.name.trim(),
                        image: productForm.image.trim() || '',
                        price: Number(productForm.price) || 0,
                        stock: Number(productForm.stock) || 0,
                        category: productForm.category.trim() || '',
                        detail: productForm.detail.trim() || '',
                        supplier: productForm.supplier.trim() || '',
                        unit: productForm.unit.trim() || 'ชิ้น',
                        weight: Number(productForm.weight) || 0,
                        minStock: Number(productForm.minStock) || 5,
                        franchisePrice: Number(productForm.franchisePrice) || Number(productForm.price) || 0,
                        cost: Number(productForm.cost) || 0
                    },
                    userEmail: user.email
                });
                Swal.close();

                if (res && res.success) {
                    showSuccess('สำเร็จ', `เพิ่มสินค้า ${res.productId || 'ใหม่'} เรียบร้อย`);
                    setIsAddProductModalOpen(false);
                    fetchProducts(true);
                } else {
                    showError(res?.message || 'เกิดข้อผิดพลาดในการเพิ่มสินค้า');
                }
            } catch (error) {
                Swal.close();
                showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
            }
        };

        // --- Purchase Order Handlers ---
        const openCreatePOModal = () => {
            setPoItems([]);
            setPoSupplier('');
            setPoExpectedDate('');
            setPoNotes('');
            setIsPOModalOpen(true);
        };

        const addPOItem = (product) => {
            const existing = poItems.find(item => item.productId === product.id);
            if (existing) {
                setPoItems(poItems.map(item => 
                    item.productId === product.id 
                        ? { ...item, qty: item.qty + 1 }
                        : item
                ));
            } else {
                setPoItems([...poItems, {
                    productId: product.id,
                    productName: product.name,
                    qty: 1,
                    price: product.price || 0
                }]);
            }
        };

        const updatePOItemQty = (productId, delta) => {
            setPoItems(poItems.map(item => {
                if (item.productId === productId) {
                    const newQty = Math.max(1, item.qty + delta);
                    return { ...item, qty: newQty };
                }
                return item;
            }).filter(item => item.qty > 0));
        };

        const updatePOItemQtyDirect = (productId, value) => {
            let newQty = parseInt(value) || 1;
            if (isNaN(newQty) || newQty < 1) {
                newQty = 1;
            }
            setPoItems(poItems.map(item => {
                if (item.productId === productId) {
                    return { ...item, qty: newQty };
                }
                return item;
            }).filter(item => item.qty > 0));
        };

        const handleCreatePO = async () => {
            if (!poSupplier || poSupplier.trim() === '') {
                showError('กรุณาระบุชื่อซัพพลายเออร์');
                return;
            }
            if (poItems.length === 0) {
                showError('กรุณาเพิ่มสินค้าในรายการ');
                return;
            }

            try {
                Swal.fire({ title: 'กำลังสร้าง PO...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
                
                // ตรวจสอบว่าเป็นแฟรนไชส์หรือไม่
                const isFranchise = user?.customerType === 'franchise';
                const action = isFranchise ? 'createFranchisePO' : 'createPO';
                
                const res = await callAPI({
                    action: action,
                    poData: {
                        supplier: poSupplier,
                        items: poItems,
                        expectedDate: poExpectedDate,
                        notes: poNotes
                    },
                    userEmail: user.email
                });
                Swal.close();

                if (res && res.success) {
                    showSuccess('สำเร็จ', `สร้าง PO ${res.poId} เรียบร้อย`);
                    setIsPOModalOpen(false);
                    setPoItems([]);
                    setPoSupplier('');
                    setPoExpectedDate('');
                    setPoNotes('');
                    if (isFranchise) {
                        fetchFranchisePOs(true);
                    } else {
                        fetchPOs(true);
                    }
                } else {
                    showError(res?.message || 'เกิดข้อผิดพลาดในการสร้าง PO');
                    console.error('PO Creation Error:', res);
                }
            } catch (error) {
                Swal.close();
                showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
                console.error('PO Creation Exception:', error);
            }
        };

        const handleReceivePO = async (po) => {
            Swal.fire({ 
                title: 'กำลังโหลด...', 
                allowOutsideClick: false, 
                didOpen: () => Swal.showLoading() 
            });
            try {
                const poDetailRes = await callAPI({ action: 'getPO', poId: po.id });
                Swal.close();
                if (!poDetailRes.success || !poDetailRes.po) {
                    showError('ไม่สามารถดึงข้อมูล PO ได้');
                    return;
                }

                setSelectedPO(poDetailRes.po);
                setIsReceivePOModalOpen(true);
            } catch (error) {
                Swal.close();
                showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
            }
        };

        const confirmReceivePO = async () => {
            if (!selectedPO) return;

            const receivedItems = selectedPO.items.map(item => ({
                productId: item.productId,
                receivedQty: item.receivedQty || item.qty
            }));

            Swal.fire({ title: 'กำลังรับสินค้า...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
            
            // ตรวจสอบว่าเป็น PO ของแฟรนไชส์หรือไม่ (FPO- prefix)
            const isFranchisePO = selectedPO.id && selectedPO.id.startsWith('FPO-');
            const action = isFranchisePO ? 'receiveFranchisePO' : 'receivePO';
            
            const res = await callAPI({
                action: action,
                poId: selectedPO.id,
                receivedItems: receivedItems,
                userEmail: user.email
            });
            Swal.close();

            if (res.success) {
                showSuccess('สำเร็จ', 'รับสินค้าและอัปเดตสต็อกเรียบร้อย');
                setIsReceivePOModalOpen(false);
                setSelectedPO(null);
                if (isFranchisePO) {
                    fetchFranchisePOs(true);
                    fetchFranchiseStock(true);
                } else {
                    fetchPOs(true);
                    fetchProducts(true);
                }
            } else {
                showError(res.message || 'เกิดข้อผิดพลาด');
            }
        };

        const handleUpdatePOStatus = async (poId, status) => {
            Swal.fire({ title: 'กำลังอัปเดตสถานะ...', didOpen: () => Swal.showLoading() });
            const res = await callAPI({ action: 'updatePOStatus', poId, status, userEmail: user.email });
            Swal.close();
            if (res.success) {
                Toast.fire({ icon: 'success', title: 'อัปเดตสถานะเรียบร้อย' });
                fetchPOs(true);
            } else {
                showError(res.message || 'เกิดข้อผิดพลาด');
            }
        };

        // Stock Alert: สร้าง PO อัตโนมัติจากสินค้าที่สต็อกต่ำ (สำหรับแอดมิน)
        const handleAutoCreatePO = async (selectedProducts) => {
            if (!selectedProducts || selectedProducts.length === 0) {
                showError('กรุณาเลือกสินค้าที่ต้องการสร้าง PO');
                return;
            }

            // จัดกลุ่มสินค้าตามซัพพลายเออร์
            const productsBySupplier = {};
            selectedProducts.forEach(product => {
                const supplier = product.supplier || 'ไม่ระบุ';
                if (!productsBySupplier[supplier]) {
                    productsBySupplier[supplier] = [];
                }
                // คำนวณจำนวนที่ต้องสั่ง (minStock * 2 - stock ปัจจุบัน)
                const minStock = Number(product.minStock) || 5;
                const currentStock = Number(product.stock) || 0;
                const orderQty = Math.max(minStock * 2 - currentStock, minStock);
                
                productsBySupplier[supplier].push({
                    productId: product.id,
                    productName: product.name,
                    qty: orderQty,
                    price: product.price || 0
                });
            });

            // แยก PO ตามซัพพลายเออร์อัตโนมัติ
            const suppliers = Object.keys(productsBySupplier);
            let createdCount = 0;
            let failedCount = 0;
            
            Swal.fire({ 
                title: 'กำลังสร้าง PO...', 
                html: `กำลังสร้าง PO สำหรับ ${suppliers.length} ซัพพลายเออร์`,
                didOpen: () => Swal.showLoading(), 
                allowOutsideClick: false 
            });

            // สร้าง PO แยกตามซัพพลายเออร์
            for (const supplier of suppliers) {
                try {
                    // เพิ่ม delay เล็กน้อยเพื่อให้แต่ละ PO มี timestamp ที่แตกต่างกัน
                    if (createdCount > 0) {
                        await new Promise(resolve => setTimeout(resolve, 100)); // delay 100ms
                    }
                    
                    const res = await callAPI({
                        action: 'createPO',
                        poData: {
                            supplier: supplier,
                            items: productsBySupplier[supplier],
                            expectedDate: '',
                            notes: `สร้างอัตโนมัติจาก Stock Alert - ${new Date().toLocaleDateString('th-TH')}`
                        },
                        userEmail: user.email
                    });

                    if (res && res.success) {
                        createdCount++;
                    } else {
                        failedCount++;
                    }
                } catch (error) {
                    failedCount++;
                    console.error('Error creating PO for supplier:', supplier, error);
                }
            }

            Swal.close();

            if (createdCount > 0) {
                if (suppliers.length > 1) {
                    showSuccess('สำเร็จ', `สร้าง PO เรียบร้อย ${createdCount} ใบ (แยกตามซัพพลายเออร์)`);
                } else {
                    Toast.fire({ icon: 'success', title: 'สร้าง PO เรียบร้อย' });
                }
                fetchPOs(true);
                fetchProducts(true);
            } else {
                showError('ไม่สามารถสร้าง PO ได้');
            }
            
            if (failedCount > 0) {
                console.warn(`${failedCount} PO creation(s) failed`);
            }
        };


        // Filter ก่อน pagination - ค้นหาจากทั้งหมด
        const filteredPOs = useMemo(() => {
            let filtered = purchaseOrders;
            // Filter ตามสถานะ
            if (poStatusFilter !== 'All') {
                filtered = filtered.filter(po => po.status === poStatusFilter);
            }
            // Filter ตามคำค้นหา (PO ID, Supplier, Notes)
            if (poSearchTerm.trim() !== '') {
                const searchLower = poSearchTerm.toLowerCase();
                filtered = filtered.filter(po => 
                    po.id.toLowerCase().includes(searchLower) ||
                    (po.supplier && po.supplier.toLowerCase().includes(searchLower)) ||
                    (po.notes && po.notes.toLowerCase().includes(searchLower))
                );
            }
            return filtered;
        }, [purchaseOrders, poStatusFilter, poSearchTerm]);

        const calculateSubtotal = () => cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        const calculateNetTotal = () => Math.max(0, calculateSubtotal() - discountAmount + shippingCost);
        const openCouponPopup = () => { 
            Swal.fire({ 
                title: 'กรอกโค้ดส่วนลด', 
                input: 'text', 
                inputPlaceholder: 'กรอกโค้ดส่วนลด',
                showCancelButton: true, 
                confirmButtonText: 'ใช้โค้ด',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: THEME_COLOR,
                allowOutsideClick: false,
                inputValidator: (value) => {
                    if (!value || !value.trim()) {
                        return 'กรุณากรอกโค้ดส่วนลด';
                    }
                },
                preConfirm: async (code) => {
                    if (!code || !code.trim()) {
                        Swal.showValidationMessage('กรุณากรอกโค้ดส่วนลด');
                        return false;
                    }
                    
                    // แสดง loading ตอนกำลังตรวจสอบโค้ด
                    Swal.fire({ 
                        title: 'กำลังตรวจสอบโค้ด...', 
                        allowOutsideClick: false, 
                        didOpen: () => Swal.showLoading() 
                    });
                    
                    try {
                        const res = await callAPI({ 
                            action: 'checkCoupon', 
                            code: code.trim(), 
                            cartTotal: calculateSubtotal(), 
                            userEmail: user?.email 
                        });
                        
                        if (!res.success) {
                            Swal.close(); // ปิด loading popup
                            Swal.fire({
                                icon: 'error',
                                title: 'ไม่สามารถใช้โค้ดได้',
                                text: res.message || 'โค้ดส่วนลดไม่ถูกต้อง',
                                confirmButtonColor: THEME_COLOR
                            });
                            return false;
                        }
                        
                        Swal.close(); // ปิด loading popup
                        
                        // ส่งกลับทั้ง discount และ code
                        return {
                            discount: res.discount || 0,
                            code: res.code || code.trim(),
                            type: res.type,
                            value: res.value
                        };
                    } catch (error) {
                        Swal.close(); // ปิด loading popup
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: error.message || 'เกิดข้อผิดพลาดในการตรวจสอบโค้ด',
                            confirmButtonColor: THEME_COLOR
                        });
                        return false;
                    }
                } 
            }).then((result) => { 
                if (result.isConfirmed && result.value) { 
                    setDiscountAmount(result.value.discount || 0); 
                    setAppliedCoupon(result.value.code || ''); 
                    Swal.fire({
                        icon: 'success',
                        title: 'ใช้โค้ดสำเร็จ',
                        text: `ลดไป ฿${(result.value.discount || 0).toLocaleString()}`,
                        confirmButtonColor: THEME_COLOR
                    }); 
                } 
            }); 
        };
        
        const handlePlaceOrder = async () => { 
            if (!slipFile) { showError('กรุณาแนบสลิปโอนเงิน'); return; } 
            Swal.fire({ title: 'กำลังทำรายการ...', text: 'กรุณารอสักครู่ ระบบกำลังบันทึกข้อมูลและอัปโหลดหลักฐาน', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
            const reader = new FileReader(); 
            reader.readAsDataURL(slipFile); 
            reader.onload = async function () { 
                const orderData = { id: `ORD-${Date.now().toString().slice(-6)}`, user: user.email, items: cart, total: calculateNetTotal(), address: user.address, discountCode: appliedCoupon, discountAmount: discountAmount }; 
                const res = await callAPI({ action: 'placeOrder', orderData, slipBase64: reader.result }); 
                if(res.success) { 
                    // อัพเดท state ก่อน
                    setCart([]); 
                    setSlipFile(null); 
                    setAppliedCoupon(null); 
                    setIsCheckoutOpen(false);
                    
                    // เปิด popup ใหม่สำหรับ loading (ไม่ใช้ update เพราะอาจเกิดปัญหา)
                    Swal.fire({
                        title: 'กำลังทำรายการ...',
                        text: 'กำลังโหลดข้อมูล...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });
                    
                    // Refresh stock และ fetch history (silent mode เพื่อไม่แสดง popup ใหม่)
                    await Promise.all([
                        fetchProducts(true), // force refresh (ไม่มี silent parameter)
                        fetchHistory(true, true) // silent mode + force refresh
                    ]);
                    
                    // ปิด popup และแสดง success
                    Swal.close();
                    showSuccess('สั่งซื้อสำเร็จ', 'ขอบคุณที่ใช้บริการ'); 
                    
                    // เปลี่ยนหน้าโดยตรง (ไม่ใช้ changePage เพื่อไม่แสดง loading popup ใหม่)
                    setPage('history');
                } 
                else { 
                    Swal.close();
                    showError(res.message); 
                } 
            }; 
        };

        const openPrintWindow = (content) => {
            const printWindow = window.open('', '_blank', 'width=850,height=1100');
            if (printWindow) {
                // เพิ่มปุ่มปิดสำหรับมือถือ (แสดงเฉพาะตอนดู ไม่แสดงตอนพิมพ์)
                const closeButton = `
                    <div id="close-print-btn" style="position: fixed; top: 15px; right: 15px; z-index: 99999; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); padding: 10px; border-radius: 50px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                        <button onclick="window.close()" style="background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.2s;">
                            <span style="font-size: 20px;">✕</span> ปิด
                        </button>
                    </div>
                    <style>
                        @media screen {
                            #close-print-btn { display: block !important; }
                        }
                        @media print {
                            #close-print-btn { display: none !important; }
                        }
                        button:hover {
                            background: #b91c1c !important;
                            transform: scale(1.05);
                        }
                        button:active {
                            transform: scale(0.95);
                        }
                    </style>
                `;
                printWindow.document.write(closeButton + content);
                 printWindow.document.close();
                printWindow.onload = () => { 
                    setTimeout(() => { 
                        printWindow.print(); 
                        Swal.close(); 
                    }, 1000); 
                };
             } else { 
                 Swal.close();
                 showError('เบราว์เซอร์บล็อกการเปิดหน้าต่างใหม่ กรุณาอนุญาต Pop-up'); 
             }
        };

        // ** FIX 1: Robust Invoice Logic with User State Priority **
        const handlePrintFullInvoice = async (order) => {
             Swal.fire({ title: 'กำลังตรวจสอบข้อมูล...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
             
             // ตรวจสอบว่าเป็น admin หรือลูกค้า (ประกาศไว้ด้านนอกเพื่อใช้ได้ทุกที่)
             const isAdmin = user && user.role === 'admin';
             
             let taxName = "";
             let taxId = "";
             let taxAddrStr = "";
             let eligibilityCheck = null; // ประกาศไว้ด้านนอกเพื่อใช้ได้ทุกที่
             let taxInvoiceData = null; // ประกาศไว้ด้านนอกเพื่อใช้ได้ทุกที่

             try {
                 // สำหรับแอดมิน: ดึงข้อมูลจาก taxInvoiceRecordedStatus หรือตรวจสอบใหม่
                 if (isAdmin) {
                     const recordedStatus = taxInvoiceRecordedStatus[order.id];
                     if (recordedStatus && recordedStatus.recorded) {
                         taxInvoiceData = recordedStatus.data;
                     } else {
                         // ตรวจสอบสถานะใหม่
                         const status = await checkOrderTaxInvoiceStatus(order.id);
                         if (status) {
                             taxInvoiceData = taxInvoiceRecordedStatus[order.id]?.data;
                         }
                     }
                 }
                 
                 // สำหรับลูกค้า: ตรวจสอบว่าออเดอร์มีการบันทึกข้อมูลภาษีแล้วหรือยัง
                 if (!isAdmin) {
                     const recordedStatus = taxInvoiceRecordedStatus[order.id];
                     if (!recordedStatus) {
                         // ตรวจสอบสถานะ
                         const status = await checkOrderTaxInvoiceStatus(order.id);
                         if (!status) {
                             Swal.close();
                             showError('ออเดอร์นี้ยังไม่มีการบันทึกข้อมูลภาษี กรุณาติดต่อแอดมิน');
                             return;
                         }
                     } else if (!recordedStatus.recorded) {
                         Swal.close();
                         showError('ออเดอร์นี้ยังไม่มีการบันทึกข้อมูลภาษี กรุณาติดต่อแอดมิน');
                         return;
                     }
                     
                     // ดึงข้อมูลจาก taxInvoiceData ที่บันทึกไว้แล้ว (สำหรับลูกค้า)
                     if (recordedStatus && recordedStatus.recorded && recordedStatus.data) {
                         taxInvoiceData = recordedStatus.data;
                     }
                     
                     // ตรวจสอบจำนวนครั้งที่พิมพ์ (จำกัด 1 ครั้งสำหรับลูกค้า)
                     const printCount = recordedStatus?.data?.printCount || 0;
                     if (printCount >= 1) {
                         Swal.close();
                         showError('คุณได้พิมพ์ใบกำกับภาษีครบ 1 ครั้งแล้ว กรุณาติดต่อแอดมินเพื่อพิมพ์เพิ่มเติม');
                         return;
                     }
                     
                     // ตรวจสอบเงื่อนไข 7 วัน (สำหรับลูกค้าเท่านั้น)
                     eligibilityCheck = await callAPI({ 
                         action: 'checkTaxInvoiceEligibility', 
                         orderId: order.id, 
                         userEmail: user?.email 
                     });
                     
                     if (!eligibilityCheck.success || !eligibilityCheck.eligible) {
                         Swal.close();
                         showError(eligibilityCheck.message || 'ไม่สามารถออกใบกำกับภาษีได้');
                         return;
                     }
                 }

                 // Priority 1: สำหรับแอดมิน ใช้ข้อมูลจาก taxInvoiceData ที่บันทึกไว้
                 if (isAdmin && taxInvoiceData) {
                     taxName = String(taxInvoiceData.taxName || "").trim();
                     taxId = String(taxInvoiceData.taxId || "").trim();
                     taxAddrStr = String(taxInvoiceData.taxAddress || "").trim();
                 }
                 
                 // Priority 1: สำหรับลูกค้า ใช้ข้อมูลจาก taxInvoiceData ที่บันทึกไว้แล้ว (ถ้ามี)
                 if (!isAdmin && taxInvoiceData) {
                     taxName = String(taxInvoiceData.taxName || "").trim();
                     taxId = String(taxInvoiceData.taxId || "").trim();
                     taxAddrStr = String(taxInvoiceData.taxAddress || "").trim();
                 }
                 
                 // Priority 2: สำหรับลูกค้า (non-admin) ถ้ายังไม่มีข้อมูลจาก taxInvoiceData ให้ใช้ข้อมูลจาก Local State
                 // เพราะลูกค้าจะเห็นเฉพาะ order ของตัวเองอยู่แล้ว
                 // ใช้ที่อยู่จากข้อมูลใบกำกับภาษีล่าสุด (taxAddr) เสมอ ไม่ใช่ที่อยู่จัดส่ง (address)
                 if (!isAdmin && user && (!taxName || !taxId)) {
                    // 1.1 ใช้ taxForm state ก่อน (ค่าล่าสุดที่ผู้ใช้กรอกแต่ยังไม่ได้บันทึก)
                    // ตรวจสอบว่ามีค่าจริงๆ และไม่ใช่ empty string
                    if (taxForm && taxForm.taxName && String(taxForm.taxName).trim() !== "") {
                        taxName = String(taxForm.taxName).trim();
                    }
                    if (taxForm && taxForm.taxId && String(taxForm.taxId).trim() !== "") {
                        taxId = String(taxForm.taxId).trim();
                    }
                    // ใช้ที่อยู่จากข้อมูลใบกำกับภาษีล่าสุด (taxAddr) เสมอ
                    if (taxForm && taxForm.taxAddr && String(taxForm.taxAddr).trim() !== "") {
                        taxAddrStr = String(taxForm.taxAddr).trim();
                    }

                    // 1.2 ถ้า taxForm ยังไม่มีค่า ใช้ user state (ค่าจาก localStorage)
                    if (!taxName || taxName === "") {
                        taxName = (user.taxName && String(user.taxName).trim() !== "") ? String(user.taxName).trim() : "";
                    }
                    if (!taxId || taxId === "") {
                        taxId = (user.taxId && String(user.taxId).trim() !== "") ? String(user.taxId).trim() : "";
                    }
                    // ใช้ที่อยู่จากข้อมูลใบกำกับภาษีล่าสุด (taxAddr) เสมอ ไม่ใช่ที่อยู่จัดส่ง (address)
                    if (!taxAddrStr || taxAddrStr === "") {
                        taxAddrStr = (user.taxAddr && String(user.taxAddr).trim() !== "") ? String(user.taxAddr).trim() : "";
                    }
             }

                 // Priority 2: สำหรับ admin หรือเมื่อ Local State ไม่มีค่า ให้ดึงจาก Server
                 const hasLocalTaxData = taxName && taxName !== "" && taxId && taxId !== "";
                 
                 // Debug: ตรวจสอบข้อมูลที่ได้จาก Local State
                 console.log('Tax Invoice Debug:', {
                     isAdmin,
                     hasLocalTaxData,
                     taxForm: taxForm ? { taxName: taxForm.taxName, taxId: taxForm.taxId, taxAddr: taxForm.taxAddr } : 'null',
                     user: user ? { taxName: user.taxName, taxId: user.taxId, taxAddr: user.taxAddr } : 'null',
                     current: { taxName, taxId, taxAddrStr },
                     orderUser: order.user
                 });
                 
                 // สำหรับแอดมิน: ถ้ายังไม่มีข้อมูลจาก taxInvoiceData ให้ดึงจาก Server
                 if (isAdmin && !taxInvoiceData) {
                     try {
                         const apiPromise = callAPI({ action: 'getProfile', email: order.user });
                         const res = await apiPromise;
                         
                         if (res && res.success && res.user) {
                             if (!taxName || taxName === "") {
                                 taxName = (res.user.taxName && String(res.user.taxName).trim() !== "") ? String(res.user.taxName).trim() : taxName;
                             }
                             if (!taxId || taxId === "") {
                                 taxId = (res.user.taxId && String(res.user.taxId).trim() !== "") ? String(res.user.taxId).trim() : taxId;
                             }
                             if (!taxAddrStr || taxAddrStr === "") {
                                 if (res.user.taxAddr && String(res.user.taxAddr).trim() !== "") {
                                     taxAddrStr = String(res.user.taxAddr).trim();
                                 } else if (res.user.address && String(res.user.address).trim() !== "") {
                                     taxAddrStr = String(res.user.address).trim();
                                 }
                             }
                         }
                     } catch(e) {
                         console.error('Error fetching profile for admin:', e);
                     }
                 }
                 
                 // สำหรับลูกค้า: ถ้ามีข้อมูลใน Local State แล้ว ไม่ต้องเรียก API
                 // แต่ถ้ายังไม่มีค่า ให้ดึงจาก Server
                 if (!isAdmin && !hasLocalTaxData) {
                     try {
                         const apiPromise = callAPI({ action: 'getProfile', email: order.user });
                         const res = await apiPromise;
                         
                         if (res && res.success && res.user) {
                             if (!taxName || taxName === "") {
                                 taxName = (res.user.taxName && String(res.user.taxName).trim() !== "") ? String(res.user.taxName).trim() : taxName;
                             }
                             if (!taxId || taxId === "") {
                                 taxId = (res.user.taxId && String(res.user.taxId).trim() !== "") ? String(res.user.taxId).trim() : taxId;
                             }
                             if (!taxAddrStr || taxAddrStr === "") {
                                 if (res.user.taxAddr && String(res.user.taxAddr).trim() !== "") {
                                     taxAddrStr = String(res.user.taxAddr).trim();
                                 } else if (res.user.address && String(res.user.address).trim() !== "") {
                                     taxAddrStr = String(res.user.address).trim();
                                 }
                             }
                             console.log('Tax Invoice - Data from Server:', { taxName, taxId, taxAddrStr });
                         }
                     } catch(e) {
                         console.error('Error fetching profile:', e);
                         console.warn('API failed and no local data available');
                     }
                 } else if (!isAdmin) {
                     console.log('Tax Invoice - Using Local State:', { taxName, taxId, taxAddrStr });
                 }
             } catch(e) {
                 console.error('Unexpected error in handlePrintFullInvoice:', e);
             } finally {
                 // ปิด modal เสมอ ไม่ว่าจะเกิด error หรือไม่
             Swal.close();
             }

             // ** Condition Check **
             // ตรวจสอบว่ามีข้อมูลครบถ้วนหรือไม่ (ต้องมีทั้ง taxName และ taxId)
             // แปลงเป็น string ก่อนเรียก .trim() เพื่อป้องกัน TypeError
             const taxNameStr = String(taxName || "").trim();
             const taxIdStr = String(taxId || "").trim();
             const hasValidTaxData = taxNameStr !== "" && taxIdStr !== "";
             
             // อัพเดทค่า taxName, taxId, taxAddrStr ให้เป็น string ที่ถูกต้อง
             taxName = taxNameStr;
             taxId = taxIdStr;
             taxAddrStr = String(taxAddrStr || "").trim();
             
             console.log('Tax Invoice - Final Check:', {
                 hasValidTaxData,
                 taxName: taxName || '(empty)',
                 taxId: taxId || '(empty)',
                 taxAddrStr: taxAddrStr || '(empty)',
                 taxInvoiceData: taxInvoiceData ? 'exists' : 'null'
             });
             
             if (!hasValidTaxData) {
                const result = await Swal.fire({
                    title: 'ข้อมูลภาษีไม่ครบถ้วน',
                    text: "คุณยังไม่ได้ระบุข้อมูลผู้เสียภาษี (ชื่อ/เลขผู้เสียภาษี/ที่อยู่) ในหน้าโปรไฟล์",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ใช้ที่อยู่จัดส่งแทน',
                    cancelButtonText: 'แก้ไขข้อมูลภาษี',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33'
                });

                if (result.isConfirmed) {
                    // Fallback to shipping info
                    taxName = order.user; 
                    taxId = "-";
                    taxAddrStr = order.address;
                } else {
                    changePage('tax_invoice'); 
                    return; 
                }
             }

             // ใช้ข้อมูลสินค้าและราคาจาก taxInvoiceData ถ้ามี (สำหรับแอดมิน) หรือจาก order (สำหรับลูกค้า)
             let itemsToDisplay = order.items;
             let subtotal = order.items.reduce((s,i)=>s+i.price*i.qty,0);
             let discVal = 0;
             let shipping = Number(order.shippingCost) || 0;
             
             if (isAdmin && taxInvoiceData && taxInvoiceData.items) {
                 // สำหรับแอดมิน: ใช้ข้อมูลจาก taxInvoiceData ที่บันทึกไว้
                 itemsToDisplay = taxInvoiceData.items;
                 subtotal = taxInvoiceData.subtotal || subtotal;
                 discVal = taxInvoiceData.discount || 0;
                 shipping = taxInvoiceData.shipping || shipping;
             } else {
                 // สำหรับลูกค้าหรือเมื่อไม่มี taxInvoiceData: ใช้ข้อมูลจาก order
                 const match = String(order.discountInfo || "").match(/-(\d+)B/);
                 if (match) discVal = parseInt(match[1]);
             }
             
             const grandTotal = subtotal - discVal + shipping;
             const vat = grandTotal * 7 / 107;
             const preVat = grandTotal - vat;
             
             const itemsHtml = itemsToDisplay.map((it, i) => `<tr><td style="text-align:center;border-bottom:1px solid #eee;padding:8px 5px;">${i+1}</td><td style="border-bottom:1px solid #eee;padding:8px 5px;">${it.name}</td><td style="text-align:center;border-bottom:1px solid #eee;padding:8px 5px;">${it.qty}</td><td style="text-align:right;border-bottom:1px solid #eee;padding:8px 5px;">${Number(it.price).toLocaleString(undefined, {minimumFractionDigits: 2})}</td><td style="text-align:right;border-bottom:1px solid #eee;padding:8px 5px;">${(it.price*it.qty).toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`).join('');

             // ดึงวันที่อนุมัติออเดอร์
             let orderDateObj = new Date();
             let approvalDate = null;
             
             // สำหรับแอดมิน: ใช้ข้อมูลจาก taxInvoiceData
             if (isAdmin && taxInvoiceData && taxInvoiceData.invoiceDate) {
                 orderDateObj = new Date(taxInvoiceData.invoiceDate);
                 approvalDate = taxInvoiceData.invoiceDate;
             } else if (!isAdmin && eligibilityCheck && eligibilityCheck.success && eligibilityCheck.approvalDate) {
                 // สำหรับลูกค้า: ใช้ข้อมูลจาก eligibilityCheck
                 orderDateObj = new Date(eligibilityCheck.approvalDate);
                 approvalDate = eligibilityCheck.approvalDate;
             } else if (order.date) {
                 // Fallback: ใช้ order.date ถ้าไม่มี approvalDate
                 try {
                     const dateStr = order.date.toString().trim();
                     const dateMatch = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                     if (dateMatch) {
                         const day = parseInt(dateMatch[1]);
                         const month = parseInt(dateMatch[2]) - 1;
                         const year = parseInt(dateMatch[3]);
                         const ceYear = year - 543;
                         orderDateObj = new Date(ceYear, month, day);
                         approvalDate = orderDateObj;
                     }
                 } catch(e) {
                     orderDateObj = new Date();
                     approvalDate = orderDateObj;
                 }
             }
             const orderDateStr = orderDateObj.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
             
             const content = `<html><head><title>Tax Invoice</title><style>@page{size:A4;margin:15mm}body{font-family:'Sarabun',sans-serif;padding:0;line-height:1.4;color:#333}table{width:100%;border-collapse:collapse}th{background:#047857 !important;color:white !important;border:1px solid #047857;padding:8px;font-size:11pt; -webkit-print-color-adjust: exact; print-color-adjust: exact;}.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:30px;border-bottom:2px solid #047857;padding-bottom:15px}.box{border:1px solid #ccc;padding:15px;margin-bottom:20px;border-radius:4px;font-size:11pt}td{font-size:11pt;padding:8px 5px}</style></head><body>
                <div class="header"><div style="width:60%; text-align:left;"><h2 style="margin:0 0 5px 0; font-size:14pt; font-weight:bold; color:#047857;">${SHOP_INFO.name}</h2><div style="font-size:11pt; color:#333; line-height:1.5;">${SHOP_INFO.address.replace(/\n/g, '<br>')}</div><div style="font-size:11pt; color:#333; margin-top:5px;"><strong>เลขประจำตัวผู้เสียภาษี:</strong> ${SHOP_INFO.taxId}</div></div><div style="width:40%; text-align:right;"><h1 style="margin:0; font-size:18pt; font-weight:bold; color:#047857; white-space:nowrap;">ใบกำกับภาษี / ใบเสร็จรับเงิน</h1><p style="margin:0 0 15px; font-size:10pt; color:#666;">(ต้นฉบับ / Original)</p><div style="border:1px solid #ddd; padding:10px; border-radius:5px; background-color:#f9fafb; display:inline-block; text-align:right;"><div style="font-size:11pt;"><strong>เลขที่:</strong> INV-${order.id}</div><div style="font-size:11pt;"><strong>วันที่:</strong> ${orderDateStr}</div></div></div></div>
                <div class="box" style="background-color:#f9fafb;"><h3 style="margin:0 0 10px 0; font-size:12pt; font-weight:bold; color:#047857; border-bottom:1px solid #eee; padding-bottom:5px;">ลูกค้า (Customer)</h3><div><div style="font-weight:bold; margin-bottom:3px;">${taxName || '-'}</div><div style="margin-bottom:3px;">${taxAddrStr || '-'}</div><div><strong>เลขประจำตัวผู้เสียภาษี:</strong> ${taxId || '-'}</div></div></div>
                <table style="width:100%; border:1px solid #ddd;"><thead><tr><th style="width:5%;text-align:center">#</th><th style="width:40%">รายการ</th><th style="width:10%;text-align:center">จำนวน</th><th style="width:20%;text-align:right">ราคา/หน่วย</th><th style="width:20%;text-align:right">จำนวนเงิน</th></tr></thead><tbody>${itemsHtml}</tbody><tfoot><tr><td colspan="4" style="text-align:right;font-weight:bold">รวมเงิน</td><td style="text-align:right">${subtotal.toLocaleString(undefined,{minimumFractionDigits:2})}</td></tr>${discVal > 0 ? `<tr><td colspan="4" style="text-align:right;color:#dc2626">ส่วนลด</td><td style="text-align:right;color:#dc2626">-${discVal.toLocaleString(undefined,{minimumFractionDigits:2})}</td></tr>` : ''}<tr><td colspan="4" style="text-align:right">ค่าขนส่ง</td><td style="text-align:right">${shipping.toLocaleString(undefined,{minimumFractionDigits:2})}</td></tr><tr><td colspan="4" style="text-align:right">มูลค่าก่อนภาษี</td><td style="text-align:right">${preVat.toLocaleString(undefined,{minimumFractionDigits:2})}</td></tr><tr><td colspan="4" style="text-align:right">ภาษีมูลค่าเพิ่ม 7%</td><td style="text-align:right">${vat.toLocaleString(undefined,{minimumFractionDigits:2})}</td></tr><tr style="background-color:#047857 !important; color:white !important; font-weight:bold; font-size:14pt; -webkit-print-color-adjust: exact; print-color-adjust: exact;"><td colspan="4" style="text-align:right; padding:10px;">ยอดสุทธิ</td><td style="text-align:right; padding:10px;">${grandTotal.toLocaleString(undefined,{minimumFractionDigits:2})} บาท</td></tr></tfoot></table>
                <div style="margin-top:60px; display:flex; justify-content:flex-end; text-align:center; font-size:11pt;"><div style="width:250px; position:relative;"><img src="${SHOP_INFO.signature}" style="position:absolute; bottom:40px; left:50%; transform:translateX(-50%); width:120px; opacity:0.8;" /><div style="border-bottom:1px solid #ccc; height:30px; margin-bottom:5px;"></div>ผู้มีอำนาจลงนาม (Authorized Signature)<br>ในนาม บริษัท ไชยจันลา จำกัด</div></div>
                <div style="margin-top:40px; padding-top:20px; border-top:1px solid #ddd; text-align:center; font-size:10pt; color:#666;">
                    <p style="margin:5px 0;">ใบเสร็จรับเงิน / ใบกำกับภาษีอิเล็กทรอนิกส์</p>
                    <p style="margin:5px 0;">(Electronic Receipt / Tax Invoice)</p>
                </div>
             </body></html>`;
             
             // บันทึกการพิมพ์ (สำหรับลูกค้าเท่านั้น - เพิ่ม printCount)
             if (!isAdmin) {
                 try {
                     Swal.fire({ 
                         title: 'กำลังบันทึกข้อมูล...', 
                         text: 'กรุณารอสักครู่', 
                         allowOutsideClick: false, 
                         didOpen: () => Swal.showLoading() 
                     });
                     
                     // ดึงข้อมูลจาก taxInvoiceData ที่บันทึกไว้แล้ว
                     const recordedData = taxInvoiceRecordedStatus[order.id]?.data;
                     
                     const invoiceData = {
                         userEmail: order.user,
                         invoiceDate: approvalDate || orderDateObj,
                         taxName: recordedData?.taxName || taxName,
                         taxId: recordedData?.taxId || taxId,
                         taxAddress: recordedData?.taxAddress || taxAddrStr,
                         subtotal: recordedData?.subtotal || subtotal,
                         discount: recordedData?.discount || discVal,
                         shipping: recordedData?.shipping || shipping,
                         total: recordedData?.total || grandTotal,
                         vat: recordedData?.vat || vat,
                         preVat: recordedData?.preVat || preVat
                     };
                     
                     const recordResult = await callAPI({ 
                         action: 'recordTaxInvoice', 
                         orderId: order.id, 
                         invoiceData: invoiceData,
                         userEmail: user?.email,
                         isAdmin: false,
                         items: recordedData?.items || itemsToDisplay
                     });
                     
                     Swal.close();
                     
                     if (recordResult && recordResult.success) {
                         console.log('Tax invoice print recorded successfully:', {
                             orderId: order.id,
                             printCount: recordResult.printCount
                         });
                         // อัพเดทสถานะ
                         setTaxInvoiceRecordedStatus(prev => ({
                             ...prev,
                             [order.id]: {
                                 recorded: true,
                                 data: {
                                     ...recordedData,
                                     printCount: recordResult.printCount
                                 }
                             }
                         }));
                     } else {
                         console.warn('Failed to record tax invoice print:', recordResult?.message || 'Unknown error');
                     }
                 } catch(e) {
                     Swal.close();
                     console.error('Error recording tax invoice print:', e);
                 }
             }
             
             // เปิดหน้าต่างพิมพ์หลังจากบันทึกข้อมูลเสร็จ
             openPrintWindow(content);
        };

        // ฟังก์ชันพิมพ์ใบเสร็จรับเงิน (แบบง่าย)
        const handlePrintReceipt = (order) => {
            Swal.fire({ title: 'กำลังเตรียมพิมพ์...', didOpen: () => Swal.showLoading() });
            
            // ใช้ username จาก order object (บันทึกตอนสร้างออเดอร์แล้ว)
            const customerName = order.username || order.user || '-';
            
            const itemsHtml = order.items.map((it, i) => `
                <tr>
                    <td style="text-align:center;border-bottom:1px solid #eee;padding:8px 5px;">${i+1}</td>
                    <td style="border-bottom:1px solid #eee;padding:8px 5px;">${it.name}</td>
                    <td style="text-align:center;border-bottom:1px solid #eee;padding:8px 5px;">${it.qty}</td>
                    <td style="text-align:right;border-bottom:1px solid #eee;padding:8px 5px;">${Number(it.price).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                    <td style="text-align:right;border-bottom:1px solid #eee;padding:8px 5px;">${(it.price*it.qty).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                </tr>
            `).join('');
            
            const subtotal = order.items.reduce((s,i)=>s+i.price*i.qty,0);
            let discVal = 0; 
            const match = String(order.discountInfo || "").match(/-(\d+)B/); 
            if (match) discVal = parseInt(match[1]);
            const shipping = Number(order.shippingCost) || 0;
            const grandTotal = subtotal - discVal + shipping;

            // แปลงวันที่จาก order.date (รูปแบบ Thai date string) เป็น Date object
            let orderDateObj = new Date();
            if (order.date) {
                try {
                    // พยายามแปลงวันที่จากรูปแบบไทย (dd/mm/yyyy) หรือรูปแบบอื่น
                    const dateStr = order.date.toString().trim();
                    // ถ้าเป็นรูปแบบ "9/1/2569" หรือ "09/01/2569"
                    const dateMatch = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                    if (dateMatch) {
                        const day = parseInt(dateMatch[1]);
                        const month = parseInt(dateMatch[2]) - 1; // month is 0-indexed
                        const year = parseInt(dateMatch[3]);
                        // แปลงปี BE เป็น CE (2569 -> 2026)
                        const ceYear = year - 543;
                        orderDateObj = new Date(ceYear, month, day);
                    }
                } catch(e) {
                    // ถ้าแปลงไม่ได้ให้ใช้วันที่ปัจจุบัน
                    orderDateObj = new Date();
                }
            }
            const orderDateStr = orderDateObj.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
            
            const content = `<html><head><title>Receipt</title><style>
                @page { size: A4; margin: 15mm; }
                body { font-family: 'Sarabun', sans-serif; padding: 0; line-height: 1.4; color: #333; }
                table { width: 100%; border-collapse: collapse; }
                th { background: #1f2937 !important; color: white !important; border: 1px solid #1f2937; padding: 8px; font-size: 11pt; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; border-bottom: 2px solid #1f2937; padding-bottom: 15px; }
                .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 4px; font-size: 11pt; }
                td { font-size: 11pt; padding: 8px 5px; }
            </style></head><body>
                <div class="header">
                    <div style="width: 60%; text-align: left;">
                        <h2 style="margin: 0 0 5px 0; font-size: 16pt; font-weight: bold; color: #1f2937;">${SHOP_INFO.name}</h2>
                        <div style="font-size: 11pt; color: #333; line-height: 1.5;">${SHOP_INFO.address.replace(/\n/g, '<br>')}</div>
                    </div>
                    <div style="width: 40%; text-align: right;">
                        <h1 style="margin: 0; font-size: 18pt; font-weight: bold; color: #1f2937;">ใบเสร็จรับเงิน</h1>
                        <p style="margin: 5px 0; font-size: 10pt; color: #666;">(Receipt)</p>
                        <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px; background-color: #f9fafb; display: inline-block; text-align: right; margin-top: 10px;">
                            <div style="font-size: 11pt;"><strong>เลขที่:</strong> ${order.id}</div>
                            <div style="font-size: 11pt;"><strong>วันที่:</strong> ${orderDateStr}</div>
                        </div>
                    </div>
                </div>
                <div class="box" style="background-color: #f9fafb;">
                    <h3 style="margin: 0 0 10px 0; font-size: 12pt; font-weight: bold; color: #1f2937; border-bottom: 1px solid #eee; padding-bottom: 5px;">ลูกค้า (Customer)</h3>
                    <div>
                        <div style="font-weight: bold; margin-bottom: 3px;">${customerName}</div>
                        <div style="margin-bottom: 3px;">${order.address || '-'}</div>
                    </div>
                </div>
                <table style="width: 100%; border: 1px solid #ddd;">
                    <thead>
                        <tr>
                            <th style="width: 5%; text-align: center;">#</th>
                            <th style="width: 40%;">รายการ</th>
                            <th style="width: 10%; text-align: center;">จำนวน</th>
                            <th style="width: 20%; text-align: right;">ราคา/หน่วย</th>
                            <th style="width: 20%; text-align: right;">จำนวนเงิน</th>
                        </tr>
                    </thead>
                    <tbody>${itemsHtml}</tbody>
                    <tfoot>
                        <tr><td colspan="4" style="text-align: right; font-weight: bold;">รวมเงิน</td><td style="text-align: right;">${subtotal.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>
                        ${discVal > 0 ? `<tr><td colspan="4" style="text-align: right; color: #dc2626;">ส่วนลด</td><td style="text-align: right; color: #dc2626;">-${discVal.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>` : ''}
                        <tr><td colspan="4" style="text-align: right;">ค่าขนส่ง</td><td style="text-align: right;">${shipping.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>
                        <tr style="background-color: #1f2937 !important; color: white !important; font-weight: bold; font-size: 14pt; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                            <td colspan="4" style="text-align: right; padding: 10px;">ยอดสุทธิ</td>
                            <td style="text-align: right; padding: 10px;">${grandTotal.toLocaleString(undefined, {minimumFractionDigits: 2})} บาท</td>
                        </tr>
                    </tfoot>
                </table>
                <div style="margin-top: 40px; text-align: center; font-size: 11pt; color: #666;">
                    <p>ขอบคุณที่ใช้บริการ</p>
                </div>
            </body></html>`;
            
            openPrintWindow(content);
        };

        // ฟังก์ชันพิมพ์ใบปะหน้า (สำหรับเครื่องพิมพ์ความร้อน - Thermal Printer 100x150mm)
        const handlePrintLabel = (order) => {
            Swal.fire({ title: 'กำลังเตรียมพิมพ์...', didOpen: () => Swal.showLoading() });
            
            // ใช้ username จาก order object (บันทึกตอนสร้างออเดอร์แล้ว)
            const customerName = order.username || order.user || '-';
            
            // นับจำนวนรวมของรายการสินค้า
            const totalItems = order.items.reduce((sum, item) => sum + item.qty, 0);
            
            // แยกที่อยู่และเบอร์โทร - ตัดที่ "เขตบางซื่อ"
            const fullAddress = SHOP_INFO.address.split('\n')[0] || '';
            // แยกที่อยู่เป็น 2 บรรทัดที่ "เขตบางซื่อ"
            // ที่อยู่: "966 ถนนประชาราษฎร์1 แขวงบางซื่อ เขตบางซื่อ กรุงเทพมหานคร 10800"
            const addressParts = fullAddress.split('เขตบางซื่อ');
            const addressLine1 = addressParts[0] ? addressParts[0].trim() : '';
            const addressLine2 = addressParts[1] ? ('เขตบางซื่อ' + addressParts[1]).trim() : '';
            const shopPhone = SHOP_INFO.address.split('\n')[1]?.replace('โทร. ', '') || '061-732-1346';
            
            const content = `<html><head><title>Shipping Label</title><style>
                @page { 
                    size: 100mm 150mm; 
                    margin: 6mm 4mm; 
                }
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                body { 
                    font-family: 'Sarabun', 'Arial', sans-serif; 
                    padding: 0; 
                    margin: 0; 
                    line-height: 1.5; 
                    color: #000; 
                    font-size: 10pt;
                    background: white;
                }
                .container {
                    width: 100%;
                    max-width: 92mm;
                    margin: 0 auto;
                }
                .header-section {
                    padding: 6px 0;
                    margin-bottom: 12px;
                    text-align: center;
                }
                .company-name { 
                    font-size: 11pt; 
                    font-weight: bold; 
                    text-align: center; 
                    margin-bottom: 6px;
                    line-height: 1.3;
                    letter-spacing: 0.3px;
                    white-space: nowrap;
                }
                .shop-address { 
                    font-size: 8pt; 
                    text-align: center; 
                    color: #333;
                    line-height: 1.4;
                    margin-bottom: 3px;
                }
                .shop-phone { 
                    font-size: 8pt; 
                    text-align: center; 
                    color: #333;
                    line-height: 1.4;
                }
                .order-section {
                    padding: 8px 0;
                    margin: 10px 0;
                    text-align: center;
                    border-top: 2px solid #000;
                    border-bottom: 2px solid #000;
                }
                .order-id { 
                    font-size: 11pt; 
                    font-weight: bold; 
                    color: #000;
                    letter-spacing: 1px;
                    font-family: 'Arial', monospace;
                }
                .customer-box {
                    border: 1.5px solid #000;
                    padding: 8px 6px;
                    margin: 10px 0;
                    background: #fff;
                }
                .customer-label { 
                    font-size: 9pt; 
                    font-weight: bold; 
                    margin-bottom: 5px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    border-bottom: 1px solid #000;
                    padding-bottom: 3px;
                }
                .customer-name { 
                    font-size: 11pt; 
                    font-weight: bold; 
                    margin-bottom: 4px;
                    margin-top: 4px;
                }
                .customer-address { 
                    font-size: 9pt; 
                    line-height: 1.5;
                    word-break: break-word;
                }
                .info-box {
                    border: 1px dashed #666;
                    padding: 6px;
                    margin: 8px 0;
                    text-align: center;
                    background: #f9f9f9;
                }
                .items-count { 
                    font-size: 10pt; 
                    font-weight: bold;
                }
                ${order.tracking ? `
                .tracking-box {
                    padding: 8px;
                    margin: 10px 0;
                    text-align: center;
                    background: #fff;
                }
                .tracking-label {
                    font-size: 8pt;
                    font-weight: bold;
                    margin-bottom: 4px;
                    text-transform: uppercase;
                }
                .tracking-number {
                    font-size: 12pt;
                    font-weight: bold;
                    font-family: 'Arial', monospace;
                    letter-spacing: 1px;
                }
                ` : ''}
            </style></head><body>
                <div class="container">
                    <div class="header-section">
                        <div class="company-name">${SHOP_INFO.name}</div>
                        <div class="shop-address">${addressLine1}</div>
                        <div class="shop-address">${addressLine2}</div>
                        <div class="shop-phone">โทร. ${shopPhone}</div>
                    </div>
                    
                    <div class="order-section">
                        <div class="order-id">${order.id}</div>
                    </div>
                    
                    <div class="customer-box">
                        <div class="customer-label">📦 ส่งถึง</div>
                        <div class="customer-name">${customerName}</div>
                        <div class="customer-address">${order.address || '-'}</div>
                    </div>
                    
                    <div class="info-box">
                        <div class="items-count">จำนวนรายการ: ${totalItems} รายการ</div>
                    </div>
                    
                    ${order.tracking ? `
                    <div class="tracking-box">
                        <div class="tracking-label">🚚 เลขพัสดุ</div>
                        <div class="tracking-number">${order.tracking}</div>
                    </div>
                    ` : ''}
                </div>
            </body></html>`;
            
             openPrintWindow(content);
        };

        // ฟังก์ชันตรวจสอบว่าออเดอร์มีการบันทึกข้อมูลภาษีแล้วหรือยัง
        const checkOrderTaxInvoiceStatus = async (orderId) => {
            try {
                const result = await callAPI({
                    action: 'checkTaxInvoiceRecorded',
                    orderId: orderId
                });
                
                if (result && result.success) {
                    setTaxInvoiceRecordedStatus(prev => ({
                        ...prev,
                        [orderId]: { recorded: result.recorded, data: result.recorded ? result : null }
                    }));
                    return result.recorded;
                }
                return false;
            } catch (e) {
                console.error('Error checking tax invoice status:', e);
                return false;
            }
        };
        
        // ฟังก์ชันบันทึกข้อมูลภาษีสำหรับแอดมิน
        const handleSaveTaxInvoiceData = async (order) => {
            // ตรวจสอบว่าออเดอร์ได้รับการอนุมัติเงินแล้วหรือยัง
            if (order.status !== 'ชำระเงินแล้ว' && order.status !== 'จัดส่งแล้ว') {
                showError('กรุณาอนุมัติเงินก่อนบันทึกข้อมูลภาษี');
                return;
            }
            
            try {
                // ดึงข้อมูลลูกค้า
                Swal.fire({ 
                    title: 'กำลังโหลดข้อมูล...', 
                    didOpen: () => Swal.showLoading(), 
                    allowOutsideClick: false 
                });
                
                const profileRes = await callAPI({ action: 'getProfile', email: order.user });
                let customerTaxData = {
                    taxName: '',
                    taxId: '',
                    taxAddress: ''
                };
                
                if (profileRes && profileRes.success && profileRes.user) {
                    customerTaxData = {
                        taxName: profileRes.user.taxName || '',
                        taxId: profileRes.user.taxId || '',
                        taxAddress: profileRes.user.taxAddr || profileRes.user.address || ''
                    };
                }
                
                // ตรวจสอบว่ามีการบันทึกข้อมูลภาษีแล้วหรือยัง
                const recordedStatus = taxInvoiceRecordedStatus[order.id];
                let existingData = null;
                
                if (recordedStatus && recordedStatus.recorded) {
                    // ถ้ามีการบันทึกแล้ว ให้ใช้ข้อมูลเดิม
                    existingData = recordedStatus.data;
                }
                
                // คำนวณยอดรวมจาก order
                const subtotal = order.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                let discVal = 0;
                const match = String(order.discountInfo || "").match(/-(\d+)B/);
                if (match) discVal = parseInt(match[1]);
                const shipping = Number(order.shippingCost) || 0;
                const grandTotal = subtotal - discVal + shipping;
                const vat = grandTotal * 7 / 107;
                const preVat = grandTotal - vat;
                
                // ตั้งค่า form (ใช้ข้อมูลเดิมถ้ามี หรือข้อมูลใหม่)
                setTaxInvoiceForm({
                    taxName: existingData?.taxName || customerTaxData.taxName,
                    taxId: existingData?.taxId || customerTaxData.taxId,
                    taxAddress: existingData?.taxAddress || customerTaxData.taxAddress,
                    items: existingData?.items || order.items.map(item => ({
                        name: item.name,
                        qty: item.qty,
                        price: item.price,
                        total: item.price * item.qty
                    })),
                    subtotal: existingData?.subtotal || subtotal,
                    discount: existingData?.discount || discVal,
                    shipping: existingData?.shipping || shipping,
                    total: existingData?.total || grandTotal,
                    vat: existingData?.vat || vat,
                    preVat: existingData?.preVat || preVat
                });
                
                setEditingOrderForTax(order);
                Swal.close();
                setIsTaxInvoiceModalOpen(true);
            } catch (e) {
                Swal.close();
                console.error('Error loading tax invoice data:', e);
                showError('เกิดข้อผิดพลาดในการโหลดข้อมูล');
            }
        };
        
        // ฟังก์ชันบันทึกข้อมูลภาษีลง Sheets
        const handleSubmitTaxInvoiceData = async () => {
            if (!editingOrderForTax) return;
            
            if (!taxInvoiceForm.taxName || !taxInvoiceForm.taxId) {
                showError('กรุณากรอกชื่อและเลขประจำตัวผู้เสียภาษี');
                return;
            }
            
            try {
                Swal.fire({ 
                    title: 'กำลังบันทึกข้อมูล...', 
                    didOpen: () => Swal.showLoading(), 
                    allowOutsideClick: false 
                });
                
                // ดึงวันที่อนุมัติออเดอร์
                const eligibilityCheck = await callAPI({ 
                    action: 'checkTaxInvoiceEligibility', 
                    orderId: editingOrderForTax.id, 
                    userEmail: user?.email 
                });
                
                const approvalDate = eligibilityCheck.success && eligibilityCheck.approvalDate 
                    ? new Date(eligibilityCheck.approvalDate) 
                    : new Date();
                
                const invoiceData = {
                    userEmail: editingOrderForTax.user,
                    invoiceDate: approvalDate,
                    taxName: taxInvoiceForm.taxName,
                    taxId: taxInvoiceForm.taxId,
                    taxAddress: taxInvoiceForm.taxAddress,
                    subtotal: taxInvoiceForm.subtotal,
                    discount: taxInvoiceForm.discount,
                    shipping: taxInvoiceForm.shipping,
                    total: taxInvoiceForm.total,
                    vat: taxInvoiceForm.vat,
                    preVat: taxInvoiceForm.preVat
                };
                
                const result = await callAPI({
                    action: 'recordTaxInvoice',
                    orderId: editingOrderForTax.id,
                    invoiceData: invoiceData,
                    userEmail: user?.email,
                    isAdmin: true,
                    items: taxInvoiceForm.items
                });
                
                Swal.close();
                
                if (result && result.success) {
                    showSuccess('สำเร็จ', 'บันทึกข้อมูลภาษีเรียบร้อยแล้ว');
                    setIsTaxInvoiceModalOpen(false);
                    setEditingOrderForTax(null);
                    
                    // อัพเดทสถานะ
                    setTaxInvoiceRecordedStatus(prev => ({
                        ...prev,
                        [editingOrderForTax.id]: { recorded: true, data: { ...invoiceData, items: taxInvoiceForm.items, printCount: 0 } }
                    }));
                    
                    // Refresh orders
                    await fetchAllOrders(true, true);
                } else {
                    showError(result?.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                }
            } catch (e) {
                Swal.close();
                console.error('Error saving tax invoice data:', e);
                showError('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
            }
        };

        // --- View Logic ---
        const displayedProductsList = useMemo(() => displayedProducts, [displayedProducts]);

        // --- Render UI ---
        // แสดง loading screen เฉพาะตอนเริ่มต้นแอปเท่านั้น
        if (isInitialLoading) return (
            <div className="fixed inset-0 z-50 gradient-bg flex flex-col items-center justify-center">
                {/* Animated Logo */}
                <div className="relative mb-8">
                    <div className="loading-float">
                        <img 
                            src={LOGO_URL} 
                            className="w-32 h-32 rounded-full object-cover shadow-2xl border-4 border-white/30"
                            alt="Logo"
                        />
                    </div>
                    {/* Glowing ring effect */}
                    <div className="absolute inset-0 rounded-full border-4 border-emerald-400/50 loading-pulse"></div>
                </div>
                
                {/* App Name */}
                <h1 className="text-3xl font-bold text-white mb-2 loading-pulse">
                    Partner Portal
                </h1>
                
                {/* Loading Dots */}
                <div className="flex items-center gap-2 mt-6">
                    <div className="w-3 h-3 bg-emerald-400 rounded-full loading-dot"></div>
                    <div className="w-3 h-3 bg-emerald-400 rounded-full loading-dot"></div>
                    <div className="w-3 h-3 bg-emerald-400 rounded-full loading-dot"></div>
                </div>
                
                {/* Loading Text */}
                <p className="text-white/70 text-sm mt-4 loading-pulse">
                    กำลังโหลด...
                </p>
                
                {/* Spinning Ring */}
                <div className="absolute bottom-20">
                    <div className="w-16 h-16 border-4 border-white/20 border-t-emerald-400 rounded-full loading-spin"></div>
                </div>
            </div>
        );

        if (page === 'login') return (
            <div className="flex items-center justify-center h-dvh bg-gray-100 p-4 text-gray-800 font-normal">
                <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center slide-up-modal">
                    <img src={LOGO_URL} className="w-28 h-28 rounded-full object-cover mx-auto mb-6 shadow-lg border-4 border-gray-100" />
                    <h2 className="text-2xl font-bold mb-6 uppercase tracking-wide">Partner Portal</h2>
                    <form onSubmit={handleLogin} className="space-y-4 font-normal text-left">
                        <div>
                            <label className="text-xs font-bold text-gray-400 block mb-1">EMAIL</label>
                            <input className="w-full px-4 py-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-green-600 outline-none transition" value={loginForm.email} onChange={e => setLoginForm({...loginForm, email: e.target.value})} required />
                        </div>
                        <div>
                            <label className="text-xs font-bold text-gray-400 block mb-1">PASSWORD</label>
                            <div className="relative">
                                <input 
                                    type={showPassword ? "text" : "password"} 
                                    className="w-full px-4 py-3 pr-12 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-green-600 outline-none transition" 
                                    value={loginForm.password} 
                                    onChange={e => setLoginForm({...loginForm, password: e.target.value})} 
                                    required 
                                    style={{WebkitTextSecurity: showPassword ? 'none' : 'disc'}}
                                />
                                <button 
                                    type="button" 
                                    onClick={() => setShowPassword(!showPassword)} 
                                    className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none z-10"
                                    style={{pointerEvents: 'auto'}}
                                >
                                    <Icon icon={showPassword ? "fa-eye-slash" : "fa-eye"} />
                                </button>
                            </div>
                        </div>
                        <button className="w-full py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition active:scale-95 shadow-md uppercase">เข้าสู่ระบบ</button>
                    </form>
                </div>
            </div>
        );

        return (
            <div className="flex flex-col h-dvh overflow-hidden bg-gray-100">
                <div className="flex flex-1 overflow-hidden relative text-gray-800 font-normal">
                    
                    {/* SIDEBAR */}
                    <aside className={`fixed lg:static w-72 bg-gray-900 text-gray-400 flex flex-col h-full z-50 transition-transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'} shadow-xl`}>
                        <div className="p-6 border-b border-gray-800 text-center">
                            <div className="w-16 h-16 bg-gray-700 rounded-full mx-auto mb-3 flex items-center justify-center text-white text-xl font-bold">{(user?.username||'U').charAt(0).toUpperCase()}</div>
                            <h1 className="text-white font-bold truncate">{user?.username}</h1>
                            <span className="text-xs bg-gray-800 px-2 py-1 rounded mt-2 border border-gray-700 inline-block font-normal">{user?.role === 'admin' ? 'Administrator' : `Branch: ${user?.branchId}`}</span>
                        </div>
                        <nav className="flex-1 py-4 overflow-y-auto space-y-1">
                            {user?.role === 'admin' ? (
                                <>
                                    <button onClick={() => changePage('admin_dashboard')} className={`w-full text-left flex items-center px-6 py-4 sidebar-item ${page==='admin_dashboard'?'sidebar-active':''}`}><Icon icon="fa-chart-line" className="w-6 text-center" /> <span className="ml-3 text-sm">แดชบอร์ด</span></button>
                                    <button onClick={() => changePage('admin_orders')} className={`w-full text-left flex items-center px-6 py-4 sidebar-item ${page==='admin_orders'?'sidebar-active':''}`}><Icon icon="fa-list-alt" className="w-6 text-center" /> <span className="ml-3 text-sm">รายการสั่งซื้อทั้งหมด</span></button>
                                    <button onClick={() => changePage('purchase_order')} className={`w-full text-left flex items-center px-6 py-4 sidebar-item ${page==='purchase_order'?'sidebar-active':''}`}><Icon icon="fa-shopping-cart" className="w-6 text-center" /> <span className="ml-3 text-sm">สั่งซื้อสินค้า (PO)</span></button>
                                    <button onClick={() => changePage('stock_alert')} className={`w-full text-left flex items-center px-6 py-4 sidebar-item ${page==='stock_alert'?'sidebar-active':''} relative`}>
                                        <Icon icon="fa-exclamation-triangle" className="w-6 text-center" /> 
                                        <span className="ml-3 text-sm">แจ้งเตือนสต็อกต่ำ</span>
                                        {lowStockCount > 0 && (
                                            <span className="absolute right-4 bg-red-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
                                                {lowStockCount > 9 ? '9+' : lowStockCount}
                                            </span>
                                        )}
                                    </button>
                                    <button onClick={() => changePage('admin_stock')} className={`w-full text-left flex items-center px-6 py-4 sidebar-item ${page==='admin_stock'?'sidebar-active':''}`}><Icon icon="fa-cubes" className="w-6 text-center" /> <span className="ml-3 text-sm">จัดการคลังสินค้า</span></button>
                                    <button onClick={() => changePage('tax_invoice')} className={`w-full text-left flex items-center px-6 py-4 sidebar-item ${page==='tax_invoice'?'sidebar-active':''}`}><Icon icon="fa-file-invoice-dollar" className="w-6 text-center" /> <span className="ml-3 text-sm">ออกใบกำกับภาษี</span></button>
                                </>
                            ) : (
                                <>
                                    <button onClick={() => changePage('home')} className={`w-full text-left flex items-center px-6 py-4 sidebar-item ${page==='home'?'sidebar-active':''}`}><Icon icon="fa-shopping-bag" className="w-6 text-center" /> <span className="ml-3 text-sm font-bold">สั่งซื้อสินค้า (Shop)</span></button>
                                    <button onClick={() => changePage('history')} className={`w-full text-left flex items-center px-6 py-4 sidebar-item ${page==='history'?'sidebar-active':''}`}><Icon icon="fa-history" className="text-center w-6" /> <span className="ml-3 text-sm">ประวัติการสั่งซื้อ</span></button>
                                    {user?.customerType === 'franchise' && (
                                        <>
                                            <button onClick={() => changePage('franchise_stock')} className={`w-full text-left flex items-center px-6 py-4 sidebar-item ${page==='franchise_stock'?'sidebar-active':''}`}><Icon icon="fa-warehouse" className="text-center w-6" /> <span className="ml-3 text-sm">จัดการสต็อก</span></button>
                                            <button onClick={() => changePage('franchise_stock_alert')} className={`w-full text-left flex items-center px-6 py-4 sidebar-item ${page==='franchise_stock_alert'?'sidebar-active':''} relative`}><Icon icon="fa-exclamation-triangle" className="text-center w-6" /> <span className="ml-3 text-sm">แจ้งเตือนสต็อกต่ำ</span>
                                                {(() => {
                                                    const lowStockCount = franchiseStock.filter(p => {
                                                        const stock = Number(p.stock) || 0;
                                                        const minStock = Number(p.minStock) || 5;
                                                        return stock <= minStock;
                                                    }).length;
                                                    return lowStockCount > 0 ? (
                                                        <span className="absolute right-4 bg-red-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
                                                            {lowStockCount > 9 ? '9+' : lowStockCount}
                                                        </span>
                                                    ) : null;
                                                })()}
                                            </button>
                                            <button onClick={() => changePage('franchise_po')} className={`w-full text-left flex items-center px-6 py-4 sidebar-item ${page==='franchise_po'?'sidebar-active':''}`}><Icon icon="fa-shopping-cart" className="text-center w-6" /> <span className="ml-3 text-sm">สั่งซื้อสินค้า (PO)</span></button>
                                            <button onClick={() => changePage('franchise_stock_log')} className={`w-full text-left flex items-center px-6 py-4 sidebar-item ${page==='franchise_stock_log'?'sidebar-active':''}`}><Icon icon="fa-list-alt" className="text-center w-6" /> <span className="ml-3 text-sm">ประวัติสต็อก</span></button>
                                        </>
                                    )}
                                    <button onClick={() => changePage('tax_invoice')} className={`w-full text-left flex items-center px-6 py-4 sidebar-item ${page==='tax_invoice'?'sidebar-active':''}`}><Icon icon="fa-receipt" className="text-center w-6" /> <span className="ml-3 text-sm">ข้อมูลใบกำกับภาษี</span></button>
                                    <button onClick={() => changePage('profile')} className={`w-full text-left flex items-center px-6 py-4 sidebar-item ${page==='profile'?'sidebar-active':''}`}><Icon icon="fa-user-cog" className="text-center w-6" /> <span className="ml-3 text-sm">แก้ไขโปรไฟล์</span></button>
                                </>
                            )}
                        </nav>
                        <div className="p-4 border-t border-gray-800 bg-gray-900">
                            <button onClick={handleLogout} className="flex items-center justify-center w-full py-3 text-gray-400 hover:text-white transition rounded-lg hover:bg-red-900/20 font-bold"><Icon icon="fa-sign-out-alt" className="mr-2"/> ออกจากระบบ</button>
                        </div>
                    </aside>
                    {isSidebarOpen && <div className="fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden" onClick={() => setIsSidebarOpen(false)}></div>}

                    <div className="flex-1 flex flex-col min-w-0 relative h-full">
                        {/* Mobile Header Adjusted: Added pt-safe and pt-12 (3rem) for clear separation */}
                        <header className="bg-white shadow-sm h-auto min-h-[70px] flex items-center justify-between px-4 z-20 shrink-0 pt-safe pt-12 pb-4">
                            <div className="flex items-center">
                                <button onClick={() => setIsSidebarOpen(true)} className="lg:hidden text-gray-600 mr-4 p-2 rounded-full transition"><Icon icon="fa-bars" className="text-xl"/></button>
                                <h2 className="text-lg font-bold text-gray-800 capitalize truncate">{page.replace('admin_','').replace('_',' ')}</h2>
                            </div>
                            
                            <div className="flex items-center gap-2">
                                {page === 'home' && (
                                    <>
                                        <button onClick={handleLogout} className="lg:hidden p-2 text-red-500 hover:bg-red-50 rounded-full transition" title="ออกจากระบบ">
                                            <Icon icon="fa-sign-out-alt" className="text-xl"/>
                                        </button>
                                        <button onClick={() => setIsCartOpen(true)} className="relative p-2 text-gray-700 hover:bg-gray-100 rounded-full transition active:scale-90">
                                            <Icon icon="fa-shopping-cart" className="text-xl"/>
                                            {cart.length > 0 && <span className="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-bold rounded-full w-4 h-4 flex items-center justify-center">{cart.length}</span>}
                                        </button>
                                    </>
                                )}
                            </div>
                        </header>

                        <main className="flex-1 overflow-y-auto p-4 pb-24 lg:p-8 bg-gray-50 scroll-smooth">
                            {page === 'home' && (
                                <div className="fade-in pb-10">
                                    <div className="flex flex-col gap-4 mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                        <div className="relative flex-grow">
                                            <span className="absolute left-3 top-3 text-gray-400"><Icon icon="fa-search"/></span>
                                            <div className="relative">
                                                <input 
                                                    className="w-full pl-10 pr-10 p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-green-600 outline-none transition font-normal" 
                                                    placeholder="ค้นหาชื่อสินค้า..." 
                                                    value={searchTerm} 
                                                    onChange={e => { 
                                                        setSearchTerm(e.target.value); 
                                                        setCurrentPage(1); 
                                                    }} 
                                                />
                                                {isSearching && (
                                                    <span className="absolute right-3 top-3 text-gray-400">
                                                        <Icon icon="fa-spinner" className="animate-spin" />
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                        {/* Categories */}
                                        <div className="flex gap-2 overflow-x-auto scrollbar-hide text-gray-800 font-normal">
                                            {['All', ...new Set(products.map(p => p.category))].map(cat => <button key={cat} onClick={() => setSelectedCategory(cat)} className={`px-4 py-1.5 rounded-full text-xs font-medium whitespace-nowrap transition-all ${selectedCategory===cat?'bg-green-600 text-white shadow':'bg-white border text-gray-600'}`}>{cat}</button>)}
                                        </div>
                                        
                                        {/* Supplier Dropdown Filter (Restored) */}
                                        <div className="mt-2">
                                            <div className="relative">
                                                <select 
                                                    className="w-full p-2 pl-3 pr-10 border rounded-lg bg-gray-50 text-sm appearance-none outline-none focus:ring-2 focus:ring-green-600 transition text-gray-700"
                                                    value={selectedSupplier}
                                                    onChange={(e) => setSelectedSupplier(e.target.value)}
                                                >
                                                    {uniqueSuppliers.map((sup) => (
                                                        <option key={sup} value={sup}>{sup === 'All' ? 'ร้านค้า/ซัพพลายเออร์ทั้งหมด' : sup}</option>
                                                    ))}
                                                </select>
                                                <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                                                    <Icon icon="fa-chevron-down" className="text-xs"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {isSearching && searchTerm.trim() !== '' && (
                                        <div className="text-center py-8 text-gray-500">
                                            <Icon icon="fa-spinner" className="animate-spin text-2xl mb-2" />
                                            <p>กำลังค้นหา...</p>
                                        </div>
                                    )}
                                    {!isSearching && searchTerm.trim() !== '' && filteredProductsList.length === 0 && (
                                        <div className="text-center py-8 text-gray-500">
                                            <Icon icon="fa-search" className="text-2xl mb-2" />
                                            <p>ไม่พบสินค้าที่ค้นหา</p>
                                        </div>
                                    )}
                                    {(!isSearching || searchTerm.trim() === '') && (
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 text-gray-800 font-bold">
                                        {displayedProducts.map(p => (
                                            <div key={p.id} className="bg-white rounded-xl shadow-sm hover:shadow-lg transition border flex flex-col overflow-hidden group font-normal" onClick={() => handleAddToCartClick(p)}>
                                                <div className="h-40 relative bg-gray-200 overflow-hidden font-normal text-gray-800">
                                                    <img src={p.image} className="w-full h-full object-cover group-hover:scale-105 transition duration-500 font-normal" onError={(e)=>e.target.src='https://via.placeholder.com/150'} />
                                                    {p.stock <= 5 && <span className="absolute top-2 right-2 bg-red-600 text-white text-[10px] px-2 py-1 rounded-full font-bold shadow-md animate-pulse">เหลือน้อย</span>}
                                                </div>
                                                <div className="p-3 flex-grow flex flex-col justify-between">
                                                    <div><h3 className="font-bold text-sm text-gray-800 line-clamp-2 leading-tight">{p.name}</h3><div className="text-[10px] text-gray-500 mt-1 font-normal">คงเหลือ: <span className={p.stock <= 5 ? "text-red-500 font-bold" : ""}>{p.stock} {p.unit || 'ชิ้น'}</span></div></div>
                                                    <div className="mt-2 flex justify-between items-center font-bold"><span className="font-bold text-gray-900 text-base">฿{p.price.toLocaleString()}</span><div className="w-7 h-7 bg-green-600 text-white rounded-lg flex items-center justify-center shadow active:scale-90 transition font-bold hover:bg-green-700"><Icon icon="fa-plus" className="text-xs"/></div></div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    )}
                                    {(!isSearching || searchTerm.trim() === '') && (
                                    <Pagination totalItems={filteredProductsList.length} itemsPerPage={itemsPerPage} currentPage={currentPage} onPageChange={setCurrentPage} />
                                    )}
                                </div>
                            )}

                            {page === 'admin_dashboard' && (
                                <div className="fade-in max-w-7xl mx-auto space-y-6 text-gray-800 font-normal">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold text-gray-800">แดชบอร์ด</h2>
                                    </div>

                                    {/* Date Filter */}
                                    <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                                        <div className="flex flex-wrap items-center gap-4">
                                            <div className="flex items-center gap-2 text-sm font-bold text-gray-700">
                                                <Icon icon="fa-calendar-alt" /> กรองตามช่วงเวลา:
                                            </div>
                                            <input 
                                                type="date" 
                                                className="border rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 font-normal" 
                                                value={dashboardStartDate} 
                                                onChange={e => setDashboardStartDate(e.target.value)} 
                                            />
                                            <span className="text-gray-600 font-bold">ถึง</span>
                                            <input 
                                                type="date" 
                                                className="border rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 font-normal" 
                                                value={dashboardEndDate} 
                                                onChange={e => setDashboardEndDate(e.target.value)} 
                                            />
                                            <button 
                                                onClick={fetchDashboardData}
                                                disabled={isDashboardLoading}
                                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-bold text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                {isDashboardLoading ? 'กำลังโหลด...' : 'ค้นหา'}
                                            </button>
                                            <button 
                                                onClick={() => {
                                                    setDashboardStartDate('');
                                                    setDashboardEndDate('');
                                                    fetchDashboardData();
                                                }}
                                                className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-bold text-sm"
                                            >
                                                ล้างฟิลเตอร์
                                            </button>
                                        </div>
                                    </div>

                                    {/* Summary Cards */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl shadow-lg text-white">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="text-blue-100 text-sm font-bold mb-1">ยอดขายรวม</p>
                                                    <p className="text-3xl font-bold">{dashboardData.totalSales.toLocaleString('th-TH')} บาท</p>
                                                </div>
                                                <div className="bg-white bg-opacity-20 p-4 rounded-full">
                                                    <Icon icon="fa-money-bill-wave" className="text-2xl" />
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl shadow-lg text-white">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="text-green-100 text-sm font-bold mb-1">จำนวนออเดอร์</p>
                                                    <p className="text-3xl font-bold">{dashboardData.totalOrders.toLocaleString('th-TH')} รายการ</p>
                                                </div>
                                                <div className="bg-white bg-opacity-20 p-4 rounded-full">
                                                    <Icon icon="fa-shopping-cart" className="text-2xl" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Top Products & Top Users */}
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        {/* Top Products */}
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <Icon icon="fa-trophy" className="mr-2 text-yellow-500" /> สินค้าขายดี 10 อันดับแรก
                                            </h3>
                                            {dashboardData.topProducts.length === 0 ? (
                                                <p className="text-gray-500 text-sm text-center py-8">ไม่มีข้อมูล</p>
                                            ) : (
                                                <div className="space-y-3">
                                                    {dashboardData.topProducts.map((product, index) => (
                                                        <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                                            <div className="flex items-center gap-3 flex-1">
                                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                                                                    index === 0 ? 'bg-yellow-400 text-yellow-900' :
                                                                    index === 1 ? 'bg-gray-300 text-gray-700' :
                                                                    index === 2 ? 'bg-orange-300 text-orange-900' :
                                                                    'bg-gray-200 text-gray-600'
                                                                }`}>
                                                                    {index + 1}
                                                                </div>
                                                                <div className="flex-1 min-w-0">
                                                                    <p className="font-bold text-gray-800 truncate">{product.name}</p>
                                                                    <p className="text-xs text-gray-500">ขายได้ {product.qty.toLocaleString('th-TH')} ชิ้น</p>
                                                                </div>
                                                            </div>
                                                            <div className="text-right">
                                                                <p className="font-bold text-green-600">{product.revenue.toLocaleString('th-TH')} บาท</p>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>

                                        {/* Top Users */}
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <Icon icon="fa-users" className="mr-2 text-blue-500" /> ผู้ใช้ที่ซื้อเยอะสุด 10 อันดับแรก
                                            </h3>
                                            {dashboardData.topUsers.length === 0 ? (
                                                <p className="text-gray-500 text-sm text-center py-8">ไม่มีข้อมูล</p>
                                            ) : (
                                                <div className="space-y-3">
                                                    {dashboardData.topUsers.map((user, index) => (
                                                        <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                                            <div className="flex items-center gap-3 flex-1">
                                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                                                                    index === 0 ? 'bg-yellow-400 text-yellow-900' :
                                                                    index === 1 ? 'bg-gray-300 text-gray-700' :
                                                                    index === 2 ? 'bg-orange-300 text-orange-900' :
                                                                    'bg-gray-200 text-gray-600'
                                                                }`}>
                                                                    {index + 1}
                                                                </div>
                                                                <div className="flex-1 min-w-0">
                                                                    <p className="font-bold text-gray-800 truncate">{user.username}</p>
                                                                    <p className="text-xs text-gray-500">{user.email}</p>
                                                                    <p className="text-xs text-gray-400 mt-1">{user.orderCount} ออเดอร์</p>
                                                                </div>
                                                            </div>
                                                            <div className="text-right">
                                                                <p className="font-bold text-blue-600">{user.total.toLocaleString('th-TH')} บาท</p>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {page === 'admin_orders' && (<div className="fade-in max-w-6xl mx-auto space-y-4 text-gray-800 font-normal">
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4 text-sm font-bold">
                                    <div className="flex flex-wrap items-center gap-4 mb-4 font-normal">
                                        <div className="flex flex-wrap items-center gap-4">
                                        <div className="flex gap-2 items-center text-sm font-bold text-gray-600"><Icon icon="fa-calendar-alt"/> กรองตามวันที่:</div>
                                            <input type="date" className="border rounded p-1 text-sm outline-none font-normal" value={dateStartInput} onChange={e=>setDateStartInput(e.target.value)} />
                                        <span>ถึง</span>
                                            <input type="date" className="border rounded p-1 text-sm outline-none font-normal" value={dateEndInput} onChange={e=>setDateEndInput(e.target.value)} />
                                            <button 
                                                onClick={() => {
                                                    setDateStart(dateStartInput);
                                                    setDateEnd(dateEndInput);
                                                }}
                                                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition font-bold text-sm flex items-center gap-2"
                                            >
                                                <Icon icon="fa-search" /> ค้นหา
                                            </button>
                                            <input 
                                                type="text" 
                                                placeholder="ค้นหา Order ID, Email, ชื่อ, ที่อยู่..." 
                                                className="border rounded p-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 font-normal w-64"
                                                value={orderSearchTerm}
                                                onChange={e => setOrderSearchTerm(e.target.value)}
                                            />
                                            <button 
                                                onClick={() => {
                                                    setDateStartInput('');
                                                    setDateEndInput('');
                                                    setDateStart('');
                                                    setDateEnd('');
                                                    setOrderSearchTerm('');
                                                }} 
                                                className="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition font-bold text-sm flex items-center gap-2"
                                            >
                                                <Icon icon="fa-times" /> ล้างฟิลเตอร์
                                            </button>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 font-bold">
                                        <div onClick={()=>setAdminStatusFilter('All')} className={`p-4 rounded-lg border cursor-pointer transition ${adminStatusFilter==='All'?'bg-blue-600 text-white ring-2 ring-blue-300':'bg-blue-50 border-blue-100 text-blue-800 hover:bg-blue-100'}`}><div className="text-xs mb-1 opacity-80 uppercase font-normal">ยอดขายรวม</div><div className="text-lg font-bold">฿{adminStats.totalSales.toLocaleString()}</div><div className="text-[10px] font-normal opacity-70">รายการ {adminStats.totalOrders}</div></div>
                                        <div onClick={()=>setAdminStatusFilter('รอตรวจสอบ')} className={`p-4 rounded-lg border cursor-pointer transition ${adminStatusFilter==='รอตรวจสอบ'?'bg-yellow-500 text-white ring-2 ring-yellow-300':'bg-yellow-50 border-yellow-100 text-yellow-800 hover:bg-yellow-100'}`}><div className="text-xs mb-1 opacity-80 uppercase font-normal text-yellow-800">รอตรวจสอบ</div><div className="text-xl font-bold">{adminStats.pending}</div></div>
                                        <div onClick={()=>setAdminStatusFilter('ชำระเงินแล้ว')} className={`p-4 rounded-lg border cursor-pointer transition ${adminStatusFilter==='ชำระเงินแล้ว'?'bg-green-600 text-white ring-2 ring-green-300':'bg-green-100 border-green-100 text-green-800 hover:bg-green-100'}`}><div className="text-xs mb-1 opacity-80 uppercase font-normal">พร้อมส่ง</div><div className="text-xl font-bold">{adminStats.paid}</div></div>
                                        <div onClick={()=>setAdminStatusFilter('จัดส่งแล้ว')} className={`p-4 rounded-lg border cursor-pointer transition ${adminStatusFilter==='จัดส่งแล้ว'?'bg-gray-600 text-white ring-2 ring-gray-300':'bg-gray-50 border-gray-100 text-gray-800 hover:bg-gray-100'}`}><div className="text-xs mb-1 opacity-80 uppercase font-normal">สำเร็จแล้ว</div><div className="text-xl font-bold">{adminStats.shipped}</div></div>
                                    </div>
                                </div>
                                <div className="flex justify-between items-center mb-4 font-bold">
                                    <h3 className="text-xl font-bold">ออเดอร์ทั้งหมด</h3>
                                    <div className="flex gap-2">
                                        {selectedOrdersForShipping.length > 0 && (
                                            <button 
                                                onClick={() => setIsBulkShippingModalOpen(true)}
                                                className="text-sm text-white font-bold bg-green-600 px-4 py-1 rounded hover:bg-green-700 transition flex items-center gap-2"
                                            >
                                                <Icon icon="fa-truck" /> ส่งสินค้า ({selectedOrdersForShipping.length})
                                            </button>
                                        )}
                                        <button 
                                            onClick={async () => {
                                                // แสดง popup กำลังดึงข้อมูล
                                                Swal.fire({ 
                                                    title: 'กำลังดึงข้อมูล...', 
                                                    allowOutsideClick: false, 
                                                    didOpen: () => Swal.showLoading() 
                                                });
                                                // ดึงข้อมูลใหม่ (force refresh)
                                                const result = await fetchAllOrders(false, true);
                                                Swal.close();
                                                if (result && result.success) {
                                                    Toast.fire({ 
                                                        icon: 'success', 
                                                        title: 'อัพเดทข้อมูลเรียบร้อย',
                                                        timer: 1500
                                                    });
                                                } else {
                                                    showError('ไม่สามารถดึงข้อมูลได้');
                                                }
                                            }} 
                                            className="text-sm text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded hover:bg-blue-100 transition"
                                        >
                                            <Icon icon="fa-sync" /> Refresh
                                        </button>
                                    </div>
                                </div>
                                {filteredAdminOrders.map(order => {
                                    const isSelected = selectedOrdersForShipping.includes(order.id);
                                    const canSelect = order.status === 'ชำระเงินแล้ว';
                                    return (
                                        <div key={order.id} className={`bg-white p-5 rounded-xl shadow-sm border text-sm font-normal ${isSelected ? 'border-green-500 ring-2 ring-green-200' : 'border-gray-100'}`}>
                                            <div className="flex items-start gap-3 mb-3">
                                                {canSelect && (
                                                    <input 
                                                        type="checkbox" 
                                                        checked={isSelected}
                                                        onChange={() => toggleOrderSelection(order.id)}
                                                        className="mt-1 w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500 cursor-pointer"
                                                    />
                                                )}
                                                <div className="flex-1">
                                                    <div className="flex justify-between border-b pb-3 mb-3 font-bold">
                                                        <div>
                                                            <span className="font-bold text-lg text-gray-800 uppercase">{order.id}</span> 
                                                            <span className="text-xs text-gray-400 font-normal">| {order.date}</span>
                                                        </div>
                                                        <div className="text-right font-bold text-emerald-700 text-lg">฿{(Number(order.total) || 0).toLocaleString()}</div>
                                                    </div>
                                                    <div className="space-y-1 mb-4 font-normal text-gray-600">
                                                        <p className="font-bold"><Icon icon="fa-user" className="mr-1"/> {order.username || order.user}</p>
                                                        <p className="text-xs text-gray-500 font-normal">{order.user}</p>
                                                        <p><Icon icon="fa-map-marker-alt" className="mr-1"/> {order.address}</p>
                                                        <div className="flex gap-2 text-xs pt-1 font-normal">
                                                            <span className={`px-2 py-0.5 rounded font-bold ${order.status==='รอตรวจสอบ'?'bg-yellow-100 text-yellow-800':order.status==='ชำระเงินแล้ว'?'bg-blue-100 text-blue-800':'bg-green-100 text-green-800'}`}>{order.status}</span>
                                                            {order.slip && <a href={order.slip} target="_blank" className="text-blue-600 underline font-bold">สลิปเงิน</a>}
                                                        </div>
                                                    </div>
                                        <div className="flex flex-wrap gap-2 justify-end pt-3 border-t text-gray-600 font-bold font-normal">
                                            {order.status === 'รอตรวจสอบ' && <button onClick={() => openEditModal(order)} className="bg-gray-100 text-blue-600 px-3 py-2 rounded-lg text-xs hover:bg-blue-50 transition"><Icon icon="fa-edit" className="mr-1" /> แก้ไข</button>}
                                            <button onClick={() => handlePrintLabel(order)} className="bg-gray-100 px-3 py-2 rounded-lg text-xs font-bold"><Icon icon="fa-print" className="mr-1"/> ปะหน้า</button>
                                            <button onClick={() => handlePrintReceipt(order)} className="bg-gray-100 px-3 py-2 rounded-lg text-xs font-bold"><Icon icon="fa-receipt" className="mr-1"/> ใบเสร็จ</button>
                                            {(order.status === 'ชำระเงินแล้ว' || order.status === 'จัดส่งแล้ว') && (
                                                taxInvoiceRecordedStatus[order.id]?.recorded ? (
                                                    <button onClick={() => handleSaveTaxInvoiceData(order)} className="bg-emerald-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-emerald-700 transition"><Icon icon="fa-file-invoice" className="mr-1"/> ออกใบกำกับภาษี/แก้ไข</button>
                                                ) : (
                                                    <button onClick={() => handleSaveTaxInvoiceData(order)} className="bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 transition"><Icon icon="fa-save" className="mr-1"/> บันทึกข้อมูลภาษี</button>
                                                )
                                            )}
                                            {order.status === 'รอตรวจสอบ' && <button onClick={() => updateOrderStatusFn(order.id, 'ชำระเงินแล้ว')} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs shadow hover:bg-blue-700 transition active:scale-95 font-bold">อนุมัติเงิน</button>}
                                                        {order.status === 'ชำระเงินแล้ว' && !isSelected && (
                                                            <button onClick={() => handleShipOrder(order.id)} className="bg-green-600 text-white px-4 py-2 rounded-lg text-xs shadow transition font-bold">ส่งสินค้า</button>
                                                        )}
                                                        {isSelected && (
                                                            <div className="bg-green-50 border border-green-300 rounded-lg p-3 mt-2 w-full">
                                                                <label className="block text-xs font-bold text-gray-700 mb-1">เลขพัสดุ:</label>
                                                                <input
                                                                    type="text"
                                                                    value={trackingNumbers[order.id] || ''}
                                                                    onChange={e => handleTrackingNumberChange(order.id, e.target.value)}
                                                                    placeholder="กรอกเลขพัสดุ..."
                                                                    className="w-full border border-green-300 rounded p-2 text-sm focus:ring-2 focus:ring-green-500 outline-none"
                                                                    autoFocus
                                                                />
                                        </div>
                                                        )}
                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>)}

                            {page === 'history' && (
                                <div className="fade-in max-w-3xl mx-auto space-y-3 text-gray-800 font-bold">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-xl font-bold text-gray-900">ประวัติการสั่งซื้อ</h2>
                                        <button 
                                            onClick={() => fetchHistory(true, true)} 
                                            className="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-bold transition active:scale-95"
                                            title="รีเฟรชข้อมูล"
                                        >
                                            <Icon icon="fa-sync-alt" className="text-gray-700" />
                                            <span className="text-gray-700">รีเฟรช</span>
                                        </button>
                                    </div>
                                    {orders.length === 0 ? <div className="text-center py-20 text-gray-400 bg-white rounded-xl border border-dashed font-normal">ยังไม่มีข้อมูลรายการสั่งซื้อ</div> : orders.map(order => (
                                        <div key={order.id} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 font-normal">
                                            <div className="flex justify-between items-start mb-3 border-b pb-3 font-bold"><div><h3 className="font-bold text-gray-900 uppercase">{order.id}</h3><p className="text-xs text-gray-400 font-normal">{order.date}</p></div><span className={`px-3 py-1 rounded-full text-[10px] font-bold ${order.status==='รอตรวจสอบ'?'bg-yellow-100 text-yellow-800':'bg-green-100 text-green-800'}`}>{order.status}</span></div>
                                            <div className="space-y-1.5 mb-3 font-normal">{order.items.map((it, idx) => <div key={idx} className="flex justify-between text-xs text-gray-600 font-normal"><span>{it.name} x{it.qty}</span><span className="font-medium text-gray-800 font-bold">฿{(it.price*it.qty).toLocaleString()}</span></div>)}</div>
                                            {order.status === 'จัดส่งแล้ว' && order.tracking && (
                                                <div className="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                                    <div className="flex items-center gap-2 text-sm">
                                                        <Icon icon="fa-truck" className="text-blue-600" />
                                                        <span className="font-bold text-blue-900">เลขที่พัสดุ:</span>
                                                        <span 
                                                            className="font-bold text-blue-700 cursor-pointer hover:text-blue-900 hover:underline transition"
                                                            onClick={async () => {
                                                                try {
                                                                    await navigator.clipboard.writeText(order.tracking);
                                                                    Toast.fire({
                                                                        icon: 'success',
                                                                        title: 'คัดลอกเลขที่พัสดุแล้ว',
                                                                        timer: 2000,
                                                                        showConfirmButton: false
                                                                    });
                                                                } catch (err) {
                                                                    // Fallback สำหรับเบราว์เซอร์ที่ไม่มี clipboard API
                                                                    const textArea = document.createElement('textarea');
                                                                    textArea.value = order.tracking;
                                                                    textArea.style.position = 'fixed';
                                                                    textArea.style.opacity = '0';
                                                                    document.body.appendChild(textArea);
                                                                    textArea.select();
                                                                    try {
                                                                        document.execCommand('copy');
                                                                        Toast.fire({
                                                                            icon: 'success',
                                                                            title: 'คัดลอกเลขที่พัสดุแล้ว',
                                                                            timer: 2000,
                                                                            showConfirmButton: false
                                                                        });
                                                                    } catch (err2) {
                                                                        showError('ไม่สามารถคัดลอกได้');
                                                                    }
                                                                    document.body.removeChild(textArea);
                                                                }
                                                            }}
                                                            title="คลิกเพื่อคัดลอกเลขที่พัสดุ"
                                                        >
                                                            {order.tracking}
                                                        </span>
                                                        <Icon icon="fa-copy" className="text-blue-500 text-xs" />
                                                    </div>
                                                </div>
                                            )}
                                            <div className="flex justify-between font-bold text-base pt-2 border-t border-dashed"><span>ยอดสุทธิ</span><span className="text-emerald-700 font-bold text-lg">฿{Number(order.total).toLocaleString()}</span></div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {page === 'tax_invoice' && (
                                <div className="fade-in max-w-4xl mx-auto space-y-6 text-gray-800 font-normal">
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                        <h3 className="text-lg font-bold mb-4 border-b pb-2 text-emerald-800"><Icon icon="fa-edit" className="mr-1"/> ข้อมูลผู้เสียภาษี</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-sm font-normal">
                                            <div><label className="text-xs font-bold text-gray-400 uppercase">ชื่อบริษัท / ผู้เสียภาษี</label><input className="w-full border rounded p-3 mt-1 outline-none focus:ring-1 focus:ring-gray-800 transition font-normal" value={taxForm.taxName} onChange={e => setTaxForm({...taxForm, taxName: e.target.value})} placeholder="ระบุชื่อตามใบ ภ.พ. 20..." /></div>
                                            <div><label className="text-xs font-bold text-gray-400 uppercase">เลขประจำตัวผู้เสียภาษี</label><input className="w-full border rounded p-3 mt-1 outline-none focus:ring-1 focus:ring-gray-800 transition font-normal" value={taxForm.taxId} onChange={e => setTaxForm({...taxForm, taxId: e.target.value})} placeholder="ระบุเลข 13 หลัก" /></div>
                                            <div className="md:col-span-2 font-normal"><label className="text-xs font-bold text-gray-400 uppercase">ที่อยู่ (ตามหน้าบัตรหรือ ภ.พ. 20)</label><textarea className="w-full border rounded p-3 mt-1 outline-none focus:ring-1 focus:ring-gray-800 transition" rows="2" value={taxForm.taxAddr} onChange={e => setTaxForm({...taxForm, taxAddr: e.target.value})} placeholder="ที่อยู่ (ตามหน้าบัตรหรือ ภ.พ. 20)" /></div>
                                        </div>
                                        <button onClick={handleUpdateTax} className="bg-emerald-600 text-white px-8 py-3 rounded-xl text-sm font-bold hover:bg-emerald-700 transition active:scale-95 shadow-md uppercase tracking-wider">บันทึกข้อมูลภาษี</button>
                                    </div>
                                    <div>
                                        <h3 className="text-lg font-bold mb-4 font-bold">รายการที่พิมพ์ใบกำกับภาษีได้</h3>
                                        <div className="space-y-3 font-normal text-gray-800">
                                            {(user?.role === 'admin' ? allOrders : orders)
                                                .filter(o => {
                                                    if (user?.role === 'admin') {
                                                        // แอดมินเห็นออเดอร์ที่บันทึกข้อมูลภาษีแล้ว
                                                        return taxInvoiceRecordedStatus[o.id]?.recorded === true;
                                                    } else {
                                                        // ลูกค้าเห็นออเดอร์ที่บันทึกข้อมูลภาษีแล้วและยังพิมพ์ได้ (1 ครั้ง)
                                                        return taxInvoiceRecordedStatus[o.id]?.recorded === true && 
                                                               (o.status === 'จัดส่งแล้ว' || o.status === 'ชำระเงินแล้ว');
                                                    }
                                                })
                                                .map(order => {
                                                    const printCount = taxInvoiceRecordedStatus[order.id]?.data?.printCount || 0;
                                                    const canPrint = user?.role === 'admin' || printCount < 1;
                                                    
                                                    return (
                                                        <div key={order.id} className="bg-white p-4 rounded-xl border flex justify-between items-center shadow-sm font-normal">
                                                            <div>
                                                                <div className="font-bold text-gray-800 uppercase">{order.id}</div>
                                                                <div className="text-xs text-gray-500 font-normal">{order.date} | ฿{Number(order.total).toLocaleString()}</div>
                                                                {user?.role !== 'admin' && printCount >= 1 && (
                                                                    <div className="text-xs text-red-600 font-bold mt-1">พิมพ์แล้ว (1 ครั้ง)</div>
                                                                )}
                                                            </div>
                                                            <button 
                                                                onClick={() => handlePrintFullInvoice(order)} 
                                                                disabled={!canPrint}
                                                                className={`px-3 py-1.5 rounded-lg text-sm flex items-center gap-2 shadow-sm transition active:scale-95 font-bold ${
                                                                    canPrint 
                                                                        ? 'bg-emerald-600 text-white hover:bg-emerald-700' 
                                                                        : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                                }`}
                                                            >
                                                                <Icon icon="fa-print"/> ใบกำกับเต็มรูป
                                                            </button>
                                                        </div>
                                                    );
                                                })
                                            }
                                        </div>
                                    </div>
                                </div>
                            )}

                            {page === 'profile' && (
                                <div className="fade-in max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-sm border border-gray-200 text-sm text-gray-800 font-bold">
                                    <h3 className="text-xl font-bold mb-6 border-b pb-2"><Icon icon="fa-user-circle" className="mr-1"/> แก้ไขข้อมูลส่วนตัว</h3>
                                    <div className="space-y-4 font-normal">
                                        <div><label className="block font-bold text-gray-500 mb-1">ชื่อร้าน / ผู้ติดต่อ</label><input className="w-full border rounded p-3 focus:ring-2 focus:ring-gray-800 outline-none transition font-normal" value={profileForm.username} onChange={e => setProfileForm({...profileForm, username: e.target.value})} /></div>
                                        <div><label className="block font-bold text-gray-500 mb-1">เบอร์โทรศัพท์</label><input className="w-full border rounded p-3 focus:ring-2 focus:ring-gray-800 outline-none transition" value={profileForm.phone} onChange={e => setProfileForm({...profileForm, phone: e.target.value})} /></div>
                                        <div><label className="block font-bold text-gray-500 mb-1">ที่อยู่จัดส่ง</label><textarea className="w-full border rounded p-3 focus:ring-2 focus:ring-gray-800 outline-none transition" rows="3" value={profileForm.address} onChange={e => setProfileForm({...profileForm, address: e.target.value})}></textarea></div>
                                        <div className="pt-4 font-bold"><button onClick={handleUpdateProfile} className="bg-green-600 text-white px-10 py-3 rounded-xl font-bold hover:bg-green-700 transition shadow-lg active:scale-95 uppercase tracking-wider">บันทึกข้อมูลส่วนตัว</button></div>
                                    </div>
                                </div>
                            )}

                            {/* Franchise Stock Management */}
                            {page === 'franchise_stock' && user?.customerType === 'franchise' && (
                                <div className="fade-in max-w-6xl mx-auto space-y-4 text-gray-800 font-bold">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-bold">จัดการสต็อกแฟรนไชส์</h3>
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={() => {
                                                    setIsImportFromOrderModalOpen(true);
                                                    fetchOrdersWithImportStatus();
                                                }}
                                                className="text-sm text-purple-600 font-bold bg-purple-50 px-3 py-1 rounded hover:bg-purple-100 transition flex items-center gap-1"
                                            >
                                                <Icon icon="fa-download" /> ดึงจากออเดอร์
                                            </button>
                                            {selectedProductsForBulkEdit.length > 0 && (
                                                <button 
                                                    onClick={openBulkEditModal}
                                                    className="text-sm text-orange-600 font-bold bg-orange-50 px-3 py-1 rounded hover:bg-orange-100 transition flex items-center gap-1"
                                                >
                                                    <Icon icon="fa-edit" /> แก้ไข {selectedProductsForBulkEdit.length} รายการ
                                                </button>
                                            )}
                                            <button 
                                                onClick={() => setIsAddFranchiseProductModalOpen(true)}
                                                className="text-sm text-emerald-600 font-bold bg-emerald-50 px-3 py-1 rounded hover:bg-emerald-100 transition flex items-center gap-1"
                                            >
                                                <Icon icon="fa-plus" /> เพิ่มสินค้า
                                            </button>
                                            <button onClick={() => fetchFranchiseStock(true, true)} className="text-sm text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded hover:bg-blue-100 transition">
                                                <Icon icon="fa-sync" /> Refresh
                                            </button>
                                        </div>
                                    </div>
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-4">
                                     <div className="relative">
                                        <span className="absolute left-3 top-3 text-gray-400"><Icon icon="fa-search"/></span>
                                        <input 
                                            className="w-full pl-10 p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-gray-800 outline-none transition font-normal" 
                                                placeholder="ค้นหาสินค้า..." 
                                                value={franchiseStockSearchTerm} 
                                                onChange={e => {
                                                    setFranchiseStockSearchTerm(e.target.value);
                                                    setFranchiseStockPage(1); // Reset to page 1 when searching
                                                }} 
                                            />
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                        <table className="w-full text-left text-sm text-gray-700 font-normal">
                                            <thead className="bg-gray-100 font-bold uppercase text-xs text-gray-600">
                                                <tr>
                                                    <th className="p-4 w-12">
                                                        <input
                                                            type="checkbox"
                                                            checked={filteredFranchiseStock.length > 0 && 
                                                                filteredFranchiseStock.every(p => selectedProductsForBulkEdit.includes(p.id))}
                                                            onChange={(e) => {
                                                                if (e.target.checked) {
                                                                    setSelectedProductsForBulkEdit([...new Set([...selectedProductsForBulkEdit, ...filteredFranchiseStock.map(p => p.id)])]);
                                                                } else {
                                                                    setSelectedProductsForBulkEdit(selectedProductsForBulkEdit.filter(id => !filteredFranchiseStock.find(p => p.id === id)));
                                                                }
                                                            }}
                                                            className="rounded"
                                                        />
                                                    </th>
                                                    <th className="p-4">สินค้า</th>
                                                    <th className="p-4 text-center">สต็อก</th>
                                                    <th className="p-4 text-center">Min Stock</th>
                                                    <th className="p-4 text-right">จัดการ</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y">
                                                {displayedFranchiseStock.map(p => (
                                                        <tr key={p.id} className="hover:bg-gray-50">
                                                            <td className="p-4">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={selectedProductsForBulkEdit.includes(p.id)}
                                                                    onChange={(e) => {
                                                                        if (e.target.checked) {
                                                                            setSelectedProductsForBulkEdit([...selectedProductsForBulkEdit, p.id]);
                                                                        } else {
                                                                            setSelectedProductsForBulkEdit(selectedProductsForBulkEdit.filter(id => id !== p.id));
                                                                        }
                                                                    }}
                                                                    className="rounded"
                                                                />
                                                            </td>
                                                            <td className="p-4 font-bold">
                                                                {p.name}
                                                                <div className="text-[10px] text-gray-400 font-normal uppercase mt-1">{p.category}</div>
                                                            </td>
                                                            <td className="p-4 text-center font-bold">
                                                                <span className={`px-2 py-1 rounded text-xs font-bold ${p.stock < p.minStock ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>
                                                                    {p.stock}
                                                                </span>
                                                            </td>
                                                            <td className="p-4 text-center font-bold">
                                                                <span className="px-2 py-1 rounded text-xs bg-gray-100 text-gray-800">{p.minStock}</span>
                                                            </td>
                                                            <td className="p-4 text-right">
                                                                <div className="flex justify-end gap-2">
                                                                    <button 
                                                                        onClick={() => {
                                                                            Swal.fire({ 
                                                                                title: `แก้ไขสต็อก: ${p.name}`, 
                                                                                input: 'number', 
                                                                                inputValue: p.stock, 
                                                                                showCancelButton: true, 
                                                                                confirmButtonColor: THEME_COLOR 
                                                                            }).then((res) => { 
                                                                                if (res.isConfirmed) {
                                                                                    Swal.fire({ title: 'กำลังทำรายการ...', text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                                                                                    callAPI({ action: 'updateFranchiseStock', productId: p.id, newStock: parseInt(res.value), userEmail: user.email }).then(async r => {
                                                                                        if(r.success) { 
                                                                                            Swal.fire({
                                                                                                icon: 'success',
                                                                                                title: 'ทำรายการเสร็จแล้ว',
                                                                                                text: 'สต็อกอัปเดตแล้ว',
                                                                                                confirmButtonText: 'เสร็จสิ้น',
                                                                                                allowOutsideClick: false
                                                                                            }).then(async (result) => {
                                                                                                if (result.isConfirmed) {
                                                                                                    // เปิด popup ใหม่สำหรับ loading (ไม่ใช้ update เพราะ popup เดิมปิดแล้ว)
                                                                                                    Swal.fire({
                                                                                                        title: 'กำลังอัพเดทข้อมูล...',
                                                                                                        text: 'กรุณารอสักครู่',
                                                                                                        allowOutsideClick: false,
                                                                                                        didOpen: () => Swal.showLoading()
                                                                                                    });
                                                                                                    await fetchFranchiseStock(true, true);
                                                                                                    Swal.close();
                                                                                                }
                                                                                            });
                                                                                        } else { 
                                                                                            Swal.close();
                                                                                            showError('เกิดข้อผิดพลาดในการอัปเดตสต็อก'); 
                                                                                        }
                                                                                    }).catch(error => {
                                                                                        Swal.close();
                                                                                        showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
                                                                                    });
                                                                                }
                                                                            }); 
                                                                        }}
                                                                        className="p-2 bg-blue-100 rounded hover:bg-blue-200 transition text-xs flex items-center gap-1 border border-blue-300 font-bold text-blue-700"
                                                                    >
                                                                        <Icon icon="fa-edit"/> แก้ไข
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => {
                                                                            Swal.fire({ 
                                                                                title: `รับเข้าสต็อก: ${p.name}`, 
                                                                                input: 'number', 
                                                                                inputValue: 0, 
                                                                                inputPlaceholder: 'จำนวน',
                                                                                showCancelButton: true, 
                                                                                confirmButtonColor: THEME_COLOR 
                                                                            }).then((res) => { 
                                                                                if (res.isConfirmed && res.value) {
                                                                                    Swal.fire({ 
                                                                                        title: 'หมายเหตุ (ถ้ามี)', 
                                                                                        input: 'text', 
                                                                                        inputPlaceholder: 'เช่น รับจาก PO',
                                                                                        showCancelButton: true, 
                                                                                        confirmButtonColor: THEME_COLOR 
                                                                                    }).then((noteRes) => {
                                                                                        if (noteRes.isConfirmed) {
                                                                                            Swal.fire({ title: 'กำลังทำรายการ...', text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                                                                                            callAPI({ action: 'franchiseStockIn', productId: p.id, qty: parseInt(res.value), note: noteRes.value || '', userEmail: user.email }).then(async r => {
                                                                                                if(r.success) { 
                                                                                                    Swal.fire({
                                                                                                        icon: 'success',
                                                                                                        title: 'ทำรายการเสร็จแล้ว',
                                                                                                        text: `รับเข้าสต็อก +${res.value} เรียบร้อย`,
                                                                                                        confirmButtonText: 'เสร็จสิ้น',
                                                                                                        allowOutsideClick: false
                                                                                                    }).then(async (result) => {
                                                                                                        if (result.isConfirmed) {
                                                                                                            // เปิด popup ใหม่สำหรับ loading (ไม่ใช้ update เพราะ popup เดิมปิดแล้ว)
                                                                                                            Swal.fire({
                                                                                                                title: 'กำลังอัพเดทข้อมูล...',
                                                                                                                text: 'กรุณารอสักครู่',
                                                                                                                allowOutsideClick: false,
                                                                                                                didOpen: () => Swal.showLoading()
                                                                                                            });
                                                                                                            await fetchFranchiseStock(true, true);
                                                                                                            Swal.close();
                                                                                                        }
                                                                                                    });
                                                                                                } else { 
                                                                                                    Swal.close();
                                                                                                    showError('เกิดข้อผิดพลาด'); 
                                                                                                }
                                                                                            }).catch(error => {
                                                                                                Swal.close();
                                                                                                showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
                                                                                            });
                                                                                        }
                                                                                    });
                                                                                }
                                                                            }); 
                                                                        }}
                                                                        className="p-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-xs flex items-center gap-1 font-bold"
                                                                    >
                                                                        <Icon icon="fa-plus"/> รับเข้า
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => {
                                                                            Swal.fire({ 
                                                                                title: `เบิกออกสต็อก: ${p.name}`, 
                                                                                input: 'number', 
                                                                                inputValue: 0, 
                                                                                inputPlaceholder: 'จำนวน',
                                                                                showCancelButton: true, 
                                                                                confirmButtonColor: THEME_COLOR 
                                                                            }).then((res) => { 
                                                                                if (res.isConfirmed && res.value) {
                                                                                    Swal.fire({ 
                                                                                        title: 'หมายเหตุ (ถ้ามี)', 
                                                                                        input: 'text', 
                                                                                        inputPlaceholder: 'เช่น ขาย, เสียหาย',
                                                                                        showCancelButton: true, 
                                                                                        confirmButtonColor: THEME_COLOR 
                                                                                    }).then((noteRes) => {
                                                                                        if (noteRes.isConfirmed) {
                                                                                            Swal.fire({ title: 'กำลังทำรายการ...', text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                                                                                            callAPI({ action: 'franchiseStockOut', productId: p.id, qty: parseInt(res.value), note: noteRes.value || '', userEmail: user.email }).then(async r => {
                                                                                                if(r.success) { 
                                                                                                    Swal.fire({
                                                                                                        icon: 'success',
                                                                                                        title: 'ทำรายการเสร็จแล้ว',
                                                                                                        text: `เบิกออกสต็อก -${res.value} เรียบร้อย`,
                                                                                                        confirmButtonText: 'เสร็จสิ้น',
                                                                                                        allowOutsideClick: false
                                                                                                    }).then(async (result) => {
                                                                                                        if (result.isConfirmed) {
                                                                                                            // เปิด popup ใหม่สำหรับ loading (ไม่ใช้ update เพราะ popup เดิมปิดแล้ว)
                                                                                                            Swal.fire({
                                                                                                                title: 'กำลังอัพเดทข้อมูล...',
                                                                                                                text: 'กรุณารอสักครู่',
                                                                                                                allowOutsideClick: false,
                                                                                                                didOpen: () => Swal.showLoading()
                                                                                                            });
                                                                                                            await fetchFranchiseStock(true, true);
                                                                                                            Swal.close();
                                                                                                        }
                                                                                                    });
                                                                                                } else { 
                                                                                                    Swal.close();
                                                                                                    showError(r.message || 'เกิดข้อผิดพลาด'); 
                                                                                                }
                                                                                            }).catch(error => {
                                                                                                Swal.close();
                                                                                                showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
                                                                                            });
                                                                                        }
                                                                                    });
                                                                                }
                                                                            }); 
                                                                        }}
                                                                        className="p-2 bg-red-600 text-white rounded hover:bg-red-700 transition text-xs flex items-center gap-1 font-bold"
                                                                    >
                                                                        <Icon icon="fa-minus"/> เบิกออก
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => {
                                                                            Swal.fire({ 
                                                                                title: `ตั้ง Min Stock: ${p.name}`, 
                                                                                input: 'number', 
                                                                                inputValue: p.minStock, 
                                                                                inputPlaceholder: 'สต็อกขั้นต่ำ',
                                                                                showCancelButton: true, 
                                                                                confirmButtonColor: THEME_COLOR 
                                                                            }).then((res) => { 
                                                                                if (res.isConfirmed) {
                                                                                    Swal.fire({ title: 'กำลังทำรายการ...', text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                                                                                    callAPI({ action: 'updateFranchiseMinStock', productId: p.id, minStock: parseInt(res.value) || 5, userEmail: user.email }).then(async r => {
                                                                                        if(r.success) { 
                                                                                            Swal.fire({
                                                                                                icon: 'success',
                                                                                                title: 'ทำรายการเสร็จแล้ว',
                                                                                                text: 'ตั้ง Min Stock เรียบร้อย',
                                                                                                confirmButtonText: 'เสร็จสิ้น',
                                                                                                allowOutsideClick: false
                                                                                            }).then(async (result) => {
                                                                                                if (result.isConfirmed) {
                                                                                                    // เปิด popup ใหม่สำหรับ loading (ไม่ใช้ update เพราะ popup เดิมปิดแล้ว)
                                                                                                    Swal.fire({
                                                                                                        title: 'กำลังอัพเดทข้อมูล...',
                                                                                                        text: 'กรุณารอสักครู่',
                                                                                                        allowOutsideClick: false,
                                                                                                        didOpen: () => Swal.showLoading()
                                                                                                    });
                                                                                                    await fetchFranchiseStock(true, true);
                                                                                                    Swal.close();
                                                                                                }
                                                                                            });
                                                                                        } else { 
                                                                                            Swal.close();
                                                                                            showError('เกิดข้อผิดพลาด'); 
                                                                                        }
                                                                                    }).catch(error => {
                                                                                        Swal.close();
                                                                                        showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
                                                                                    });
                                                                                }
                                                                            }); 
                                                                        }}
                                                                        className="p-2 bg-yellow-100 rounded hover:bg-yellow-200 transition text-xs flex items-center gap-1 border border-yellow-300 font-bold text-yellow-700"
                                                                    >
                                                                        <Icon icon="fa-cog"/> Min Stock
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    {filteredFranchiseStock.length > itemsPerPage && (
                                        <Pagination
                                            totalItems={filteredFranchiseStock.length}
                                            itemsPerPage={itemsPerPage}
                                            currentPage={franchiseStockPage}
                                            onPageChange={setFranchiseStockPage}
                                        />
                                    )}
                                </div>
                            )}

                            {/* Franchise PO */}
                            {page === 'franchise_po' && user?.customerType === 'franchise' && (
                                <div className="fade-in max-w-6xl mx-auto space-y-4 text-gray-800 font-normal">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-bold">Purchase Order (PO) - แฟรนไชส์</h3>
                                        <div className="flex gap-2">
                                            <button onClick={() => setIsPOModalOpen(true)} className="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 transition shadow-sm">
                                                <Icon icon="fa-plus" /> สร้าง PO
                                            </button>
                                            <button onClick={() => fetchFranchisePOs(false, true)} className="text-sm text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded hover:bg-blue-100 transition">
                                                <Icon icon="fa-sync" /> Refresh
                                            </button>
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        {franchisePOs.length === 0 ? (
                                            <div className="text-center py-20 text-gray-400 bg-white rounded-xl border border-dashed">
                                                ยังไม่มี Purchase Order
                                            </div>
                                        ) : (
                                            franchisePOs.map(po => (
                                                <div key={po.id} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div>
                                                            <div className="font-bold text-lg text-gray-800">{po.id}</div>
                                                            <div className="text-sm text-gray-500 mt-1">ซัพพลายเออร์: {po.supplier}</div>
                                                            <div className="text-sm text-gray-500">วันที่สร้าง: {po.createdDate}</div>
                                                        </div>
                                                        <div className="text-right">
                                                            <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                                                po.status === 'รออนุมัติ' ? 'bg-yellow-100 text-yellow-800' :
                                                                po.status === 'รับสินค้าแล้ว' ? 'bg-green-100 text-green-800' :
                                                                'bg-gray-100 text-gray-800'
                                                            }`}>
                                                                {po.status}
                                                            </span>
                                                            <div className="text-lg font-bold text-emerald-700 mt-2">฿{Number(po.totalAmount).toLocaleString()}</div>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2 justify-end">
                                                        <button 
                                                            onClick={async () => {
                                                                Swal.fire({ title: 'กำลังโหลด...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                                                                const res = await callAPI({ action: 'getFranchisePO', poId: po.id, userEmail: user.email });
                                                                Swal.close();
                                                                if (res.success) {
                                                                    setSelectedPO(res.po);
                                                                    setPoItems(res.po.items || []);
                                                                    setIsReceivePOModalOpen(true);
                                                                } else {
                                                                    showError(res.message || 'ไม่สามารถโหลดข้อมูล PO ได้');
                                                                }
                                                            }}
                                                            className="bg-green-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-green-700 transition"
                                                            disabled={po.status === 'รับสินค้าแล้ว'}
                                                        >
                                                            <Icon icon="fa-check" className="mr-1" /> รับสินค้า
                                                        </button>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Franchise Stock Log */}
                            {page === 'franchise_stock_log' && user?.customerType === 'franchise' && (
                                <div className="fade-in max-w-6xl mx-auto space-y-4 text-gray-800 font-normal">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-bold">ประวัติสต็อกแฟรนไชส์</h3>
                                        <button onClick={() => fetchFranchiseStockLog(true, true)} className="text-sm text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded hover:bg-blue-100 transition">
                                            <Icon icon="fa-sync" /> Refresh
                                        </button>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-4">
                                        <div className="flex flex-wrap items-center gap-4">
                                            <div className="flex items-center gap-2 text-sm font-bold text-gray-600">
                                                <Icon icon="fa-calendar-alt" /> กรองตามช่วงเวลา:
                                            </div>
                                            <input 
                                                type="date" 
                                                className="border rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 font-normal" 
                                                value={franchiseStockLogStartDate} 
                                                onChange={e => setFranchiseStockLogStartDate(e.target.value)} 
                                            />
                                            <span className="text-gray-600 font-bold">ถึง</span>
                                            <input 
                                                type="date" 
                                                className="border rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 font-normal" 
                                                value={franchiseStockLogEndDate} 
                                                onChange={e => setFranchiseStockLogEndDate(e.target.value)} 
                                            />
                                            <input 
                                                type="text" 
                                                placeholder="ค้นหาสินค้า, Product ID, หมายเหตุ..." 
                                                className="border rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 font-normal w-64"
                                                value={franchiseStockLogSearchTerm}
                                                onChange={e => setFranchiseStockLogSearchTerm(e.target.value)}
                                            />
                                            <button 
                                                onClick={() => {
                                                    setFranchiseStockLogStartDate('');
                                                    setFranchiseStockLogEndDate('');
                                                    setFranchiseStockLogSearchTerm('');
                                                    // useEffect จะจัดการ fetch ให้อัตโนมัติเมื่อ state เปลี่ยน
                                                }}
                                                className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-bold text-sm flex items-center gap-2"
                                            >
                                                <Icon icon="fa-times" /> ล้างฟิลเตอร์
                                            </button>
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                        <table className="w-full text-left text-sm text-gray-700">
                                            <thead className="bg-gray-100 font-bold uppercase text-xs text-gray-600">
                                                <tr>
                                                    <th className="p-4">วันที่/เวลา</th>
                                                    <th className="p-4">สินค้า</th>
                                                    <th className="p-4 text-center">ประเภท</th>
                                                    <th className="p-4 text-center">จำนวน</th>
                                                    <th className="p-4 text-center">คงเหลือ</th>
                                                    <th className="p-4">หมายเหตุ</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y">
                                                {(() => {
                                                    // กรองข้อมูลตาม franchiseStockLogSearchTerm
                                                    const filteredLogs = franchiseStockLogSearchTerm.trim() !== '' 
                                                        ? franchiseStockLog.filter(log => {
                                                            const searchLower = franchiseStockLogSearchTerm.toLowerCase().trim();
                                                            return (
                                                                (log.productName && log.productName.toLowerCase().includes(searchLower)) ||
                                                                (log.productId && log.productId.toLowerCase().includes(searchLower)) ||
                                                                (log.note && log.note.toLowerCase().includes(searchLower)) ||
                                                                (log.timestamp && log.timestamp.toLowerCase().includes(searchLower))
                                                            );
                                                        })
                                                        : franchiseStockLog;
                                                    
                                                    return filteredLogs.length === 0 ? (
                                                        <tr>
                                                            <td colSpan="6" className="p-8 text-center text-gray-400">ไม่มีข้อมูล</td>
                                                        </tr>
                                                    ) : (
                                                        filteredLogs.map((log, index) => (
                                                            <tr key={index} className="hover:bg-gray-50">
                                                                <td className="p-4 font-normal">{log.timestamp}</td>
                                                                <td className="p-4 font-bold">{log.productName} <span className="text-xs text-gray-400 font-normal">({log.productId})</span></td>
                                                                <td className="p-4 text-center">
                                                                    <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                                        (log.type === 'IN' || log.type === 'ADD') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                                                    }`}>
                                                                        {(log.type === 'IN' || log.type === 'ADD') ? 'รับเข้า' : 'เบิกออก'}
                                                                    </span>
                                                                </td>
                                                                <td className="p-4 text-center font-bold">{log.quantity}</td>
                                                                <td className="p-4 text-center font-bold">{log.balance}</td>
                                                                <td className="p-4 font-normal">{log.note || '-'}</td>
                                                            </tr>
                                                        ))
                                                    );
                                                })()}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {page === 'admin_stock' && (<div className="fade-in max-w-6xl mx-auto space-y-4 text-gray-800 font-bold">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold">Stock Management</h3>
                                    <button 
                                        onClick={openAddProductModal}
                                        className="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 transition shadow-sm flex items-center gap-2"
                                    >
                                        <Icon icon="fa-plus" /> เพิ่มสินค้าใหม่
                                    </button>
                                </div>
                                {/* Stock Search Input */}
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-4">
                                     <div className="relative">
                                        <span className="absolute left-3 top-3 text-gray-400"><Icon icon="fa-search"/></span>
                                        <input 
                                            className="w-full pl-10 pr-10 p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-gray-800 outline-none transition font-normal" 
                                            placeholder="ค้นหาชื่อสินค้าเพื่อจัดการสต็อก..." 
                                            value={stockSearchTerm} 
                                            onChange={e => setStockSearchTerm(e.target.value)} 
                                        />
                                        {isStockSearching && (
                                            <span className="absolute right-3 top-3 text-gray-400">
                                                <Icon icon="fa-spinner" className="animate-spin" />
                                            </span>
                                        )}
                                    </div>
                                </div>

                                {(() => {
                                    // ใช้ searchResults ถ้ามีการค้นหา
                                    let filteredStockProducts;
                                    if (stockSearchTerm.trim() !== '') {
                                        // ถ้ามีการค้นหา ใช้ stockSearchResults เสมอ (แม้จะว่างก็ตาม)
                                        // เพราะ stockSearchResults มาจากการค้นหาจากฐานข้อมูลทั้งหมด
                                        filteredStockProducts = stockSearchResults;
                                    } else {
                                        // ถ้าไม่มี stockSearchTerm ใช้ products
                                        filteredStockProducts = products;
                                    }
                                    const displayedStockProducts = filteredStockProducts.slice((stockManagementPage - 1) * itemsPerPage, stockManagementPage * itemsPerPage);
                                    
                                    return (
                                        <div>
                                <div className="bg-white rounded-xl shadow-sm border overflow-hidden font-normal">
                                <table className="w-full text-left text-sm text-gray-700 font-normal">
                                    <thead className="bg-gray-100 font-bold uppercase text-xs text-gray-600 font-bold">
                                        <tr><th className="p-4">สินค้า</th><th className="p-4 text-center">คงเหลือ</th><th className="p-4 text-right">จัดการ</th></tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {isStockSearching && stockSearchTerm.trim() !== '' && (
                                            <tr>
                                                <td colSpan="3" className="p-8 text-center text-gray-500">
                                                    <Icon icon="fa-spinner" className="animate-spin text-2xl mb-2" />
                                                    <p>กำลังค้นหา...</p>
                                                </td>
                                            </tr>
                                        )}
                                        {!isStockSearching && stockSearchTerm.trim() !== '' && displayedStockProducts.length === 0 && (
                                            <tr>
                                                <td colSpan="3" className="p-8 text-center text-gray-500">
                                                    <Icon icon="fa-search" className="text-2xl mb-2" />
                                                    <p>ไม่พบสินค้าที่ค้นหา</p>
                                                </td>
                                            </tr>
                                        )}
                                        {(!isStockSearching || stockSearchTerm.trim() === '') && displayedStockProducts.map(p => (
                                            <tr key={p.id} className="hover:bg-gray-50">
                                                <td className="p-4 font-bold">{p.name}<div className="text-[10px] text-gray-400 font-normal uppercase mt-1">{p.category}</div></td>
                                                <td className="p-4 text-center font-bold"><span className={`px-2 py-1 rounded text-xs font-bold ${p.stock < 10 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>{p.stock}</span></td>
                                                <td className="p-4 text-right"><div className="flex justify-end gap-2">
                                                    <button onClick={() => openEditProductModal(p)} className="p-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-xs flex items-center gap-1 font-bold"><Icon icon="fa-edit"/> แก้ไขสินค้า</button>
                                                    <button onClick={() => handleEditStock(p)} className="p-2 bg-gray-100 rounded hover:bg-gray-200 transition text-xs flex items-center gap-1 border border-gray-300 font-bold text-gray-600"><Icon icon="fa-box"/> แก้สต็อก</button>
                                                    <button onClick={()=>handleRestock(p)} className="p-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-xs flex items-center gap-1 font-bold"><Icon icon="fa-plus"/> เติมของ</button>
                                                </div></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                            </div>
                                            {filteredStockProducts.length > itemsPerPage && (
                                                <div className="mt-4">
                                                    <Pagination 
                                                        totalItems={filteredStockProducts.length} 
                                                        itemsPerPage={itemsPerPage} 
                                                        currentPage={stockManagementPage} 
                                                        onPageChange={(page) => {
                                                            setStockManagementPage(page);
                                                            window.scrollTo({ top: 0, behavior: 'smooth' });
                                                        }} 
                                                    />
                                                </div>
                                            )}
                                        </div>
                                    );
                                })()}
                            </div>)}

                            {page === 'stock_alert' && (
                                <div className="fade-in max-w-6xl mx-auto space-y-4 text-gray-800 font-normal">
                                    <div className="flex justify-between items-center mb-4">
                                        <div>
                                            <h3 className="text-xl font-bold">แจ้งเตือนสต็อกต่ำ</h3>
                                            <p className="text-sm text-gray-500 mt-1">
                                                พบสินค้าที่สต็อกต่ำกว่า minStock จำนวน <span className="font-bold text-red-600">{lowStockCount}</span> รายการ
                                            </p>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => fetchProducts(true)} className="text-sm text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded hover:bg-blue-100 transition">
                                                <Icon icon="fa-sync" /> Refresh
                                            </button>
                                            {filteredLowStockProducts.length > 0 && (
                                                <button 
                                                    onClick={() => {
                                                        // จัดกลุ่มตาม supplier เพื่อแสดงจำนวน PO ที่จะสร้าง
                                                        const productsBySupplier = {};
                                                        filteredLowStockProducts.forEach(product => {
                                                            const supplier = product.supplier || 'ไม่ระบุ';
                                                            if (!productsBySupplier[supplier]) {
                                                                productsBySupplier[supplier] = [];
                                                            }
                                                            productsBySupplier[supplier].push(product);
                                                        });
                                                        const supplierCount = Object.keys(productsBySupplier).length;
                                                        
                                                        Swal.fire({
                                                            title: 'สร้าง PO อัตโนมัติ',
                                                            html: `
                                                                <div class="text-left">
                                                                    <p class="mb-2">ต้องการสร้าง PO สำหรับสินค้าทั้งหมด (${filteredLowStockProducts.length} รายการ) หรือไม่?</p>
                                                                    <p class="text-sm text-gray-600 mb-2">ระบบจะแยกสร้าง PO ตามซัพพลายเออร์อัตโนมัติ:</p>
                                                                    <ul class="text-sm text-gray-700 list-disc list-inside">
                                                                        ${Object.keys(productsBySupplier).map(supplier => 
                                                                            `<li>${supplier}: ${productsBySupplier[supplier].length} รายการ</li>`
                                                                        ).join('')}
                                                                    </ul>
                                                                    <p class="text-sm font-bold text-emerald-600 mt-2">จะสร้าง PO ทั้งหมด ${supplierCount} ใบ</p>
                                                                </div>
                                                            `,
                                                            icon: 'question',
                                                            showCancelButton: true,
                                                            confirmButtonText: 'ยืนยัน',
                                                            cancelButtonText: 'ยกเลิก',
                                                            confirmButtonColor: THEME_COLOR
                                                        }).then((result) => {
                                                            if (result.isConfirmed) {
                                                                handleAutoCreatePO(filteredLowStockProducts);
                                                            }
                                                        });
                                                    }}
                                                    className="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 transition shadow-sm"
                                                >
                                                    <Icon icon="fa-magic" className="mr-1" /> สร้าง PO อัตโนมัติ (แยกตามซัพพลายเออร์)
                                                </button>
                                            )}
                                        </div>
                                    </div>

                                    {/* Search */}
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-4">
                                        <div className="relative">
                                            <span className="absolute left-3 top-3 text-gray-400"><Icon icon="fa-search"/></span>
                                            <input 
                                                className="w-full pl-10 p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-gray-800 outline-none transition font-normal" 
                                                placeholder="ค้นหาสินค้าที่สต็อกต่ำ..." 
                                                value={stockAlertSearch} 
                                                onChange={e => setStockAlertSearch(e.target.value)} 
                                            />
                                        </div>
                                    </div>

                                    {/* Low Stock Products List */}
                                    {filteredLowStockProducts.length === 0 ? (
                                        <div className="text-center py-20 text-gray-400 bg-white rounded-xl border border-dashed">
                                            {lowStockProducts.length === 0 
                                                ? '🎉 ไม่มีสินค้าที่สต็อกต่ำ - ทุกอย่างพร้อม!'
                                                : 'ไม่พบสินค้าที่ตรงกับการค้นหา'
                                            }
                                        </div>
                                    ) : (
                                        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                            <table className="w-full text-left text-sm text-gray-700">
                                                <thead className="bg-red-50 font-bold uppercase text-xs text-gray-600">
                                                    <tr>
                                                        <th className="p-4 w-12">
                                                            <input 
                                                                type="checkbox" 
                                                                className="rounded"
                                                                checked={(() => {
                                                                    const currentPageProducts = filteredLowStockProducts.slice((stockAlertPage - 1) * itemsPerPage, stockAlertPage * itemsPerPage);
                                                                    return currentPageProducts.length > 0 && currentPageProducts.every(p => {
                                                                        const selected = document.querySelector(`input[data-product-id="${p.id}"]`);
                                                                        return selected?.checked;
                                                                    });
                                                                })()}
                                                                onChange={(e) => {
                                                                    const currentPageProducts = filteredLowStockProducts.slice((stockAlertPage - 1) * itemsPerPage, stockAlertPage * itemsPerPage);
                                                                    currentPageProducts.forEach(product => {
                                                                        const checkbox = document.querySelector(`input[data-product-id="${product.id}"]`);
                                                                        if (checkbox) checkbox.checked = e.target.checked;
                                                                    });
                                                                }}
                                                            />
                                                        </th>
                                                        <th className="p-4">สินค้า</th>
                                                        <th className="p-4 text-center">สต็อกปัจจุบัน</th>
                                                        <th className="p-4 text-center">Min Stock</th>
                                                        <th className="p-4 text-center">ขาด</th>
                                                        <th className="p-4 text-center">แนะนำสั่ง</th>
                                                        <th className="p-4 text-right">จัดการ</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {filteredLowStockProducts.slice((stockAlertPage - 1) * itemsPerPage, stockAlertPage * itemsPerPage).map(product => {
                                                        const stock = Number(product.stock) || 0;
                                                        const minStock = Number(product.minStock) || 5;
                                                        const shortage = minStock - stock;
                                                        const recommendedQty = Math.max(minStock * 2 - stock, minStock);
                                                        
                                                        return (
                                                            <tr key={product.id} className="hover:bg-gray-50">
                                                                <td className="p-4">
                                                                    <input 
                                                                        type="checkbox" 
                                                                        className="rounded"
                                                                        data-product-id={product.id}
                                                                    />
                                                                </td>
                                                                <td className="p-4">
                                                                    <div className="font-bold">{product.name}</div>
                                                                    <div className="text-xs text-gray-400 mt-1">
                                                                        {product.category} | {product.supplier || 'ไม่ระบุ'}
                                                                    </div>
                                                                </td>
                                                                <td className="p-4 text-center">
                                                                    <span className={`px-3 py-1 rounded text-sm font-bold ${
                                                                        stock === 0 ? 'bg-red-200 text-red-900' :
                                                                        stock <= minStock / 2 ? 'bg-orange-100 text-orange-800' :
                                                                        'bg-yellow-100 text-yellow-800'
                                                                    }`}>
                                                                        {stock} {product.unit || 'ชิ้น'}
                                                                    </span>
                                                                </td>
                                                                <td className="p-4 text-center font-bold">{minStock} {product.unit || 'ชิ้น'}</td>
                                                                <td className="p-4 text-center">
                                                                    <span className="text-red-600 font-bold">{shortage > 0 ? `-${shortage}` : '0'}</span>
                                                                </td>
                                                                <td className="p-4 text-center">
                                                                    <span className="text-emerald-600 font-bold">{recommendedQty} {product.unit || 'ชิ้น'}</span>
                                                                </td>
                                                                <td className="p-4 text-right">
                                                                    <div className="flex justify-end gap-2">
                                                                        <button 
                                                                            onClick={() => {
                                                                                setPoItems([{
                                                                                    productId: product.id,
                                                                                    productName: product.name,
                                                                                    qty: recommendedQty,
                                                                                    price: product.price || 0
                                                                                }]);
                                                                                setPoSupplier(product.supplier || '');
                                                                                setIsPOModalOpen(true);
                                                                            }}
                                                                            className="p-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-xs flex items-center gap-1 font-bold"
                                                                        >
                                                                            <Icon icon="fa-shopping-cart" /> สร้าง PO
                                                                        </button>
                                                                        <button 
                                                                            onClick={() => handleRestock(product)}
                                                                            className="p-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-xs flex items-center gap-1 font-bold"
                                                                        >
                                                                            <Icon icon="fa-plus" /> เติมสต็อก
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })} 
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                    
                                    {/* Pagination for Stock Alert */}
                                    {filteredLowStockProducts.length > itemsPerPage && (
                                        <div className="mt-4">
                                            <Pagination 
                                                totalItems={filteredLowStockProducts.length} 
                                                itemsPerPage={itemsPerPage} 
                                                currentPage={stockAlertPage} 
                                                onPageChange={(page) => {
                                                    setStockAlertPage(page);
                                                    window.scrollTo({ top: 0, behavior: 'smooth' });
                                                }} 
                                            />
                                        </div>
                                    )}

                                    {/* Summary Card */}
                                    {filteredLowStockProducts.length > 0 && (
                                        <div className="bg-gradient-to-r from-red-50 to-orange-50 p-6 rounded-xl border-2 border-red-200">
                                            <div className="flex justify-between items-center">
                                                <div>
                                                    <h4 className="font-bold text-lg text-red-800 mb-2">
                                                        <Icon icon="fa-exclamation-triangle" className="mr-2" />
                                                        สรุปสินค้าที่ต้องเติม
                                                    </h4>
                                                    <p className="text-sm text-gray-700">
                                                        พบสินค้าที่สต็อกต่ำ <span className="font-bold text-red-600">{filteredLowStockProducts.length}</span> รายการ
                                                    </p>
                                                </div>
                                                <button
                                                    onClick={() => {
                                                        const selectedProducts = filteredLowStockProducts.filter(product => {
                                                            const checkbox = document.querySelector(`input[data-product-id="${product.id}"]`);
                                                            return checkbox?.checked;
                                                        });
                                                        
                                                        if (selectedProducts.length === 0) {
                                                            showError('กรุณาเลือกสินค้าที่ต้องการสร้าง PO');
                                                            return;
                                                        }
                                                        
                                                        // จัดกลุ่มตาม supplier เพื่อแสดงจำนวน PO ที่จะสร้าง
                                                        const productsBySupplier = {};
                                                        selectedProducts.forEach(product => {
                                                            const supplier = product.supplier || 'ไม่ระบุ';
                                                            if (!productsBySupplier[supplier]) {
                                                                productsBySupplier[supplier] = [];
                                                            }
                                                            productsBySupplier[supplier].push(product);
                                                        });
                                                        const supplierCount = Object.keys(productsBySupplier).length;
                                                        
                                                        Swal.fire({
                                                            title: 'สร้าง PO สำหรับสินค้าที่เลือก',
                                                            html: `
                                                                <div class="text-left">
                                                                    <p class="mb-2">ต้องการสร้าง PO สำหรับสินค้าที่เลือก (${selectedProducts.length} รายการ) หรือไม่?</p>
                                                                    <p class="text-sm text-gray-600 mb-2">ระบบจะแยกสร้าง PO ตามซัพพลายเออร์อัตโนมัติ:</p>
                                                                    <ul class="text-sm text-gray-700 list-disc list-inside">
                                                                        ${Object.keys(productsBySupplier).map(supplier => 
                                                                            `<li>${supplier}: ${productsBySupplier[supplier].length} รายการ</li>`
                                                                        ).join('')}
                                                                    </ul>
                                                                    <p class="text-sm font-bold text-emerald-600 mt-2">จะสร้าง PO ทั้งหมด ${supplierCount} ใบ</p>
                                                                </div>
                                                            `,
                                                            icon: 'question',
                                                            showCancelButton: true,
                                                            confirmButtonText: 'ยืนยัน',
                                                            cancelButtonText: 'ยกเลิก',
                                                            confirmButtonColor: THEME_COLOR
                                                        }).then((result) => {
                                                            if (result.isConfirmed) {
                                                                handleAutoCreatePO(selectedProducts);
                                                            }
                                                        });
                                                    }}
                                                    className="bg-red-600 text-white px-6 py-3 rounded-lg text-sm font-bold hover:bg-red-700 transition shadow-lg"
                                                >
                                                    <Icon icon="fa-magic" className="mr-2" />
                                                    สร้าง PO สำหรับสินค้าที่เลือก (แยกตามซัพพลายเออร์)
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {/* Franchise Stock Alert */}
                            {page === 'franchise_stock_alert' && user?.customerType === 'franchise' && (
                                <div className="fade-in max-w-6xl mx-auto space-y-4 text-gray-800 font-normal">
                                    <div className="flex justify-between items-center mb-4">
                                        <div>
                                            <h3 className="text-xl font-bold">แจ้งเตือนสต็อกต่ำ</h3>
                                            <p className="text-sm text-gray-500 mt-1">
                                                พบสินค้าที่สต็อกต่ำกว่า minStock จำนวน <span className="font-bold text-red-600">{lowStockFranchiseProducts.length}</span> รายการ
                                            </p>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => fetchFranchiseStock(true, true)} className="text-sm text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded hover:bg-blue-100 transition">
                                                <Icon icon="fa-sync" /> Refresh
                                            </button>
                                            {filteredLowStockFranchiseProducts.length > 0 && (
                                                <button 
                                                    onClick={() => {
                                                        // จัดกลุ่มตาม supplier เพื่อแสดงจำนวน PO ที่จะสร้าง
                                                        const productsBySupplier = {};
                                                        filteredLowStockFranchiseProducts.forEach(product => {
                                                            const supplier = product.supplier || 'ไม่ระบุ';
                                                            if (!productsBySupplier[supplier]) {
                                                                productsBySupplier[supplier] = [];
                                                            }
                                                            productsBySupplier[supplier].push(product);
                                                        });
                                                        const supplierCount = Object.keys(productsBySupplier).length;
                                                        
                                                        Swal.fire({
                                                            title: 'สร้าง PO อัตโนมัติ',
                                                            html: `
                                                                <div class="text-left">
                                                                    <p class="mb-2">ต้องการสร้าง PO สำหรับสินค้าทั้งหมด (${filteredLowStockFranchiseProducts.length} รายการ) หรือไม่?</p>
                                                                    <p class="text-sm text-gray-600 mb-2">ระบบจะแยกสร้าง PO ตามซัพพลายเออร์อัตโนมัติ:</p>
                                                                    <ul class="text-sm text-gray-700 list-disc list-inside">
                                                                        ${Object.keys(productsBySupplier).map(supplier => 
                                                                            `<li>${supplier}: ${productsBySupplier[supplier].length} รายการ</li>`
                                                                        ).join('')}
                                                                    </ul>
                                                                    <p class="text-sm font-bold text-emerald-600 mt-2">จะสร้าง PO ทั้งหมด ${supplierCount} ใบ</p>
                                                                </div>
                                                            `,
                                                            icon: 'question',
                                                            showCancelButton: true,
                                                            confirmButtonText: 'ยืนยัน',
                                                            cancelButtonText: 'ยกเลิก',
                                                            confirmButtonColor: THEME_COLOR
                                                        }).then((result) => {
                                                            if (result.isConfirmed) {
                                                                handleAutoCreateFranchisePO(filteredLowStockFranchiseProducts);
                                                            }
                                                        });
                                                    }}
                                                    className="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 transition shadow-sm"
                                                >
                                                    <Icon icon="fa-magic" className="mr-1" /> สร้าง PO อัตโนมัติ (แยกตามซัพพลายเออร์)
                                                </button>
                                            )}
                                        </div>
                                    </div>

                                    {/* Search */}
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-4">
                                        <div className="relative">
                                            <span className="absolute left-3 top-3 text-gray-400"><Icon icon="fa-search"/></span>
                                            <input 
                                                className="w-full pl-10 p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-gray-800 outline-none transition font-normal" 
                                                placeholder="ค้นหาสินค้าที่สต็อกต่ำ..." 
                                                value={franchiseStockAlertSearch} 
                                                onChange={e => {
                                                    setFranchiseStockAlertSearch(e.target.value);
                                                    setFranchiseStockAlertPage(1);
                                                }} 
                                            />
                                        </div>
                                    </div>

                                    {/* Low Stock Products List */}
                                    {filteredLowStockFranchiseProducts.length === 0 ? (
                                        <div className="text-center py-20 text-gray-400 bg-white rounded-xl border border-dashed">
                                            {lowStockFranchiseProducts.length === 0 
                                                ? '🎉 ไม่มีสินค้าที่สต็อกต่ำ - ทุกอย่างพร้อม!'
                                                : 'ไม่พบสินค้าที่ตรงกับการค้นหา'
                                            }
                                        </div>
                                    ) : (
                                        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                            <table className="w-full text-left text-sm text-gray-700">
                                                <thead className="bg-red-50 font-bold uppercase text-xs text-gray-600">
                                                    <tr>
                                                        <th className="p-4 w-12">
                                                            <input 
                                                                type="checkbox" 
                                                                className="rounded"
                                                                checked={(() => {
                                                                    const currentPageProducts = filteredLowStockFranchiseProducts.slice((franchiseStockAlertPage - 1) * itemsPerPage, franchiseStockAlertPage * itemsPerPage);
                                                                    return currentPageProducts.length > 0 && currentPageProducts.every(p => {
                                                                        const selected = document.querySelector(`input[data-franchise-product-id="${p.id}"]`);
                                                                        return selected?.checked;
                                                                    });
                                                                })()}
                                                                onChange={(e) => {
                                                                    const currentPageProducts = filteredLowStockFranchiseProducts.slice((franchiseStockAlertPage - 1) * itemsPerPage, franchiseStockAlertPage * itemsPerPage);
                                                                    currentPageProducts.forEach(product => {
                                                                        const checkbox = document.querySelector(`input[data-franchise-product-id="${product.id}"]`);
                                                                        if (checkbox) checkbox.checked = e.target.checked;
                                                                    });
                                                                }}
                                                            />
                                                        </th>
                                                        <th className="p-4">สินค้า</th>
                                                        <th className="p-4 text-center">สต็อกปัจจุบัน</th>
                                                        <th className="p-4 text-center">Min Stock</th>
                                                        <th className="p-4 text-center">ขาด</th>
                                                        <th className="p-4 text-right">จัดการ</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {filteredLowStockFranchiseProducts.slice((franchiseStockAlertPage - 1) * itemsPerPage, franchiseStockAlertPage * itemsPerPage).map(product => {
                                                        const stock = Number(product.stock) || 0;
                                                        const minStock = Number(product.minStock) || 5;
                                                        const shortage = minStock - stock;
                                                        
                                                        return (
                                                            <tr key={product.id} className="hover:bg-gray-50">
                                                                <td className="p-4">
                                                                    <input 
                                                                        type="checkbox" 
                                                                        className="rounded"
                                                                        data-franchise-product-id={product.id}
                                                                    />
                                                                </td>
                                                                <td className="p-4">
                                                                    <div className="font-bold">{product.name}</div>
                                                                    <div className="text-xs text-gray-400 mt-1">
                                                                        {product.category || 'ไม่ระบุหมวดหมู่'}
                                                                    </div>
                                                                </td>
                                                                <td className="p-4 text-center">
                                                                    <span className={`px-3 py-1 rounded text-sm font-bold ${
                                                                        stock === 0 ? 'bg-red-200 text-red-900' :
                                                                        stock <= minStock / 2 ? 'bg-orange-100 text-orange-800' :
                                                                        'bg-yellow-100 text-yellow-800'
                                                                    }`}>
                                                                        {stock} {product.unit || 'ชิ้น'}
                                                                    </span>
                                                                </td>
                                                                <td className="p-4 text-center font-bold">{minStock} {product.unit || 'ชิ้น'}</td>
                                                                <td className="p-4 text-center">
                                                                    <span className="text-red-600 font-bold">{shortage > 0 ? `-${shortage}` : '0'}</span>
                                                                </td>
                                                                <td className="p-4 text-right">
                                                                    <div className="flex justify-end gap-2">
                                                                        <button 
                                                                            onClick={() => {
                                                                                setPoItems([{
                                                                                    productId: product.id,
                                                                                    productName: product.name,
                                                                                    qty: Math.max(minStock * 2 - stock, minStock),
                                                                                    price: product.franchisePrice || product.price || 0
                                                                                }]);
                                                                                setPoSupplier(product.supplier || '');
                                                                                setIsPOModalOpen(true);
                                                                            }}
                                                                            className="p-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-xs flex items-center gap-1 font-bold"
                                                                        >
                                                                            <Icon icon="fa-shopping-cart" /> สร้าง PO
                                                                        </button>
                                                                        <button 
                                                                            onClick={() => {
                                                                                Swal.fire({ 
                                                                                    title: `แก้ไขสต็อก: ${product.name}`, 
                                                                                    input: 'number', 
                                                                                    inputValue: product.stock, 
                                                                                    showCancelButton: true, 
                                                                                    confirmButtonColor: THEME_COLOR 
                                                                                }).then((res) => { 
                                                                                    if (res.isConfirmed) {
                                                                                        Swal.fire({ title: 'กำลังทำรายการ...', text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                                                                                        callAPI({ action: 'updateFranchiseStock', productId: product.id, newStock: parseInt(res.value), userEmail: user.email }).then(async r => {
                                                                                            if(r.success) { 
                                                                                                Swal.fire({
                                                                                                    icon: 'success',
                                                                                                    title: 'ทำรายการเสร็จแล้ว',
                                                                                                    text: 'สต็อกอัปเดตแล้ว',
                                                                                                    confirmButtonText: 'เสร็จสิ้น',
                                                                                                    allowOutsideClick: false
                                                                                                }).then(async (result) => {
                                                                                                    if (result.isConfirmed) {
                                                                                                        Swal.fire({
                                                                                                            title: 'กำลังอัพเดทข้อมูล...',
                                                                                                            text: 'กรุณารอสักครู่',
                                                                                                            allowOutsideClick: false,
                                                                                                            didOpen: () => Swal.showLoading()
                                                                                                        });
                                                                                                        await fetchFranchiseStock(true, true);
                                                                                                        Swal.close();
                                                                                                    }
                                                                                                });
                                                                                            } else { 
                                                                                                Swal.close();
                                                                                                showError('เกิดข้อผิดพลาดในการอัปเดตสต็อก'); 
                                                                                            }
                                                                                        }).catch(error => {
                                                                                            Swal.close();
                                                                                            showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
                                                                                        });
                                                                                    }
                                                                                }); 
                                                                            }}
                                                                            className="p-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-xs flex items-center gap-1 font-bold"
                                                                        >
                                                                            <Icon icon="fa-plus" /> เติมสต็อก
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })} 
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                    
                                    {/* Pagination for Franchise Stock Alert */}
                                    {filteredLowStockFranchiseProducts.length > itemsPerPage && (
                                        <div className="mt-4">
                                            <Pagination 
                                                totalItems={filteredLowStockFranchiseProducts.length} 
                                                itemsPerPage={itemsPerPage} 
                                                currentPage={franchiseStockAlertPage} 
                                                onPageChange={(page) => {
                                                    setFranchiseStockAlertPage(page);
                                                    window.scrollTo({ top: 0, behavior: 'smooth' });
                                                }} 
                                            />
                                        </div>
                                    )}

                                    {/* Summary Card */}
                                    {filteredLowStockFranchiseProducts.length > 0 && (
                                        <div className="bg-gradient-to-r from-red-50 to-orange-50 p-6 rounded-xl border-2 border-red-200">
                                            <div className="flex justify-between items-center">
                                                <div>
                                                    <h4 className="font-bold text-lg text-red-800 mb-2">
                                                        <Icon icon="fa-exclamation-triangle" className="mr-2" />
                                                        สรุปสินค้าที่ต้องเติม
                                                    </h4>
                                                    <p className="text-sm text-gray-700">
                                                        พบสินค้าที่สต็อกต่ำ <span className="font-bold text-red-600">{filteredLowStockFranchiseProducts.length}</span> รายการ
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {page === 'purchase_order' && (
                                <div className="fade-in max-w-6xl mx-auto space-y-4 text-gray-800 font-normal">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-bold">Purchase Order (PO)</h3>
                                        <div className="flex gap-2">
                                            <button onClick={() => fetchPOs(true, true)} className="text-sm text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded hover:bg-blue-100 transition">
                                                <Icon icon="fa-sync" /> Refresh
                                            </button>
                                            <button onClick={openCreatePOModal} className="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 transition shadow-sm">
                                                <Icon icon="fa-plus" className="mr-1" /> สร้าง PO ใหม่
                                            </button>
                                        </div>
                                    </div>

                                    {/* Search & Filter */}
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4 space-y-3">
                                        {/* Search */}
                                        <div className="relative">
                                            <span className="absolute left-3 top-3 text-gray-400"><Icon icon="fa-search"/></span>
                                            <input 
                                                className="w-full pl-10 p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-gray-800 outline-none transition font-normal" 
                                                placeholder="ค้นหา PO ID, ซัพพลายเออร์, หรือหมายเหตุ..." 
                                                value={poSearchTerm} 
                                                onChange={e => setPoSearchTerm(e.target.value)} 
                                            />
                                        </div>
                                        {/* Status Filter */}
                                        <div className="flex gap-2 flex-wrap">
                                            {['All', 'รออนุมัติ', 'อนุมัติแล้ว', 'กำลังจัดส่ง', 'รับสินค้าแล้ว'].map(status => (
                                                <button
                                                    key={status}
                                                    onClick={() => setPoStatusFilter(status)}
                                                    className={`px-4 py-2 rounded-lg text-sm font-bold transition ${
                                                        poStatusFilter === status
                                                            ? 'bg-green-600 text-white'
                                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                    }`}
                                                >
                                                    {status}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* PO List - Grouped by Supplier */}
                                    {(() => {
                                        // จัดกลุ่ม PO ตามซัพพลายเออร์
                                        const posBySupplier = {};
                                        filteredPOs.forEach(po => {
                                            const supplier = po.supplier || 'ไม่ระบุ';
                                            if (!posBySupplier[supplier]) {
                                                posBySupplier[supplier] = [];
                                            }
                                            posBySupplier[supplier].push(po);
                                        });

                                        const suppliers = Object.keys(posBySupplier).sort();

                                        if (filteredPOs.length === 0) {
                                            return (
                                                <div className="text-center py-20 text-gray-400 bg-white rounded-xl border border-dashed">
                                                    ยังไม่มี Purchase Order
                                                </div>
                                            );
                                        }

                                        return (
                                            <div className="space-y-6">
                                                {suppliers.map(supplier => (
                                                    <div key={supplier} className="bg-gradient-to-r from-gray-50 to-white rounded-xl border-2 border-gray-200 overflow-hidden">
                                                        {/* Supplier Header */}
                                                        <div className="bg-green-700 text-white p-4">
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex items-center gap-3">
                                                                    <Icon icon="fa-building" className="text-xl" />
                                                                    <div>
                                                                        <h3 className="font-bold text-lg">{supplier}</h3>
                                                                        <p className="text-xs text-gray-300 mt-1">
                                                                            {posBySupplier[supplier].length} PO
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                                <div className="text-right">
                                                                    <p className="text-xs text-gray-300">ยอดรวมทั้งหมด</p>
                                                                    <p className="text-xl font-bold">
                                                                        ฿{posBySupplier[supplier].reduce((sum, po) => sum + Number(po.totalAmount || 0), 0).toLocaleString()}
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* PO Items */}
                                                        <div className="p-4 space-y-3">
                                                            {posBySupplier[supplier].map(po => (
                                                                <div key={po.id} className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition">
                                                                    <div className="flex justify-between items-start mb-3">
                                                                        <div className="flex-1">
                                                                            <div className="flex items-center gap-2 mb-2">
                                                                                <h4 className="font-bold text-base text-gray-800 uppercase">{po.id}</h4>
                                                                                <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                                                    po.status === 'รออนุมัติ' ? 'bg-yellow-100 text-yellow-800' :
                                                                                    po.status === 'อนุมัติแล้ว' ? 'bg-blue-100 text-blue-800' :
                                                                                    po.status === 'กำลังจัดส่ง' ? 'bg-purple-100 text-purple-800' :
                                                                                    'bg-green-100 text-green-800'
                                                                                }`}>
                                                                                    {po.status}
                                                                                </span>
                                                                            </div>
                                                                            <div className="text-xs text-gray-500 space-y-1">
                                                                                <p>สร้างเมื่อ: {po.createdDate} | โดย: {po.createdBy}</p>
                                                                                {po.expectedDate && (
                                                                                    <p>วันที่คาดว่าจะได้รับ: {po.expectedDate}</p>
                                                                                )}
                                                                                {po.notes && (
                                                                                    <p className="text-gray-400 italic">หมายเหตุ: {po.notes}</p>
                                                                                )}
                                                                            </div>
                                                                        </div>
                                                                        <div className="text-right ml-4">
                                                                            <div className="text-lg font-bold text-emerald-700 mb-2">
                                                                                ฿{Number(po.totalAmount).toLocaleString()}
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    <div className="flex flex-wrap gap-2 justify-end pt-3 border-t mt-3">
                                                                        {po.status === 'รออนุมัติ' && (
                                                                            <>
                                                                                <button
                                                                                    onClick={() => handleUpdatePOStatus(po.id, 'อนุมัติแล้ว')}
                                                                                    className="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 transition"
                                                                                >
                                                                                    <Icon icon="fa-check" className="mr-1" /> อนุมัติ
                                                                                </button>
                                                                                <button
                                                                                    onClick={() => handleUpdatePOStatus(po.id, 'ยกเลิก')}
                                                                                    className="bg-red-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-red-700 transition"
                                                                                >
                                                                                    <Icon icon="fa-times" className="mr-1" /> ยกเลิก
                                                                                </button>
                                                                            </>
                                                                        )}
                                                                        {po.status === 'อนุมัติแล้ว' && (
                                                                            <button
                                                                                onClick={() => handleUpdatePOStatus(po.id, 'กำลังจัดส่ง')}
                                                                                className="bg-purple-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-purple-700 transition"
                                                                            >
                                                                                <Icon icon="fa-truck" className="mr-1" /> กำลังจัดส่ง
                                                                            </button>
                                                                        )}
                                                                        {po.status === 'กำลังจัดส่ง' && (
                                                                            <button
                                                                                onClick={() => handleReceivePO(po)}
                                                                                className="bg-green-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-green-700 transition"
                                                                            >
                                                                                <Icon icon="fa-check-circle" className="mr-1" /> รับสินค้า
                                                                            </button>
                                                                        )}
                                                                        <button
                                                                            onClick={async () => {
                                                                                Swal.fire({ 
                                                                                    title: 'กำลังโหลด...', 
                                                                                    allowOutsideClick: false, 
                                                                                    didOpen: () => Swal.showLoading() 
                                                                                });
                                                                                try {
                                                                                    const res = await callAPI({ action: 'getPO', poId: po.id });
                                                                                    Swal.close();
                                                                                    if (res.success) {
                                                                                        Swal.fire({
                                                                                            title: `รายละเอียด ${po.id}`,
                                                                                            html: `
                                                                                                <div class="text-left">
                                                                                                    <p><strong>ซัพพลายเออร์หลัก:</strong> ${res.po.supplier}</p>
                                                                                                    <p><strong>สถานะ:</strong> ${res.po.status}</p>
                                                                                                    <p><strong>ยอดรวม:</strong> ฿${Number(res.po.totalAmount).toLocaleString()}</p>
                                                                                                    <hr class="my-3">
                                                                                                    <p><strong>รายการสินค้า (แยกตามซัพพลายเออร์):</strong></p>
                                                                                                    ${(() => {
                                                                                                        // จัดกลุ่มสินค้าตาม supplier
                                                                                                        const itemsBySupplier = {};
                                                                                                        res.po.items.forEach(item => {
                                                                                                            const supplier = item.supplier || 'ไม่ระบุ';
                                                                                                            if (!itemsBySupplier[supplier]) {
                                                                                                                itemsBySupplier[supplier] = [];
                                                                                                            }
                                                                                                            itemsBySupplier[supplier].push(item);
                                                                                                        });
                                                                                                        
                                                                                                        // สร้าง HTML แยกตาม supplier
                                                                                                        return Object.keys(itemsBySupplier).map(supplier => {
                                                                                                            const items = itemsBySupplier[supplier];
                                                                                                            const total = items.reduce((sum, item) => sum + Number(item.total || 0), 0);
                                                                                                            return `
                                                                                                                <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                                                                                                                    <p style="font-weight: bold; color: #333; margin-bottom: 8px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                                                                                                                        📦 ${supplier} (${items.length} รายการ) - รวม: ฿${total.toLocaleString()}
                                                                                                                    </p>
                                                                                                                    <ul class="list-disc list-inside" style="margin-left: 10px;">
                                                                                                                        ${items.map(item => `<li>${item.productName} x${item.qty} @ ฿${Number(item.price).toLocaleString()} = ฿${Number(item.total).toLocaleString()}</li>`).join('')}
                                                                                                                    </ul>
                                                                                                                </div>
                                                                                                            `;
                                                                                                        }).join('');
                                                                                                    })()}
                                                                                                </div>
                                                                                            `,
                                                                                            confirmButtonColor: THEME_COLOR
                                                                                        });
                                                                                    } else {
                                                                                        showError(res.message || 'ไม่สามารถดึงข้อมูล PO ได้');
                                                                                    }
                                                                                } catch (error) {
                                                                                    Swal.close();
                                                                                    showError('เกิดข้อผิดพลาด: ' + (error.message || 'Unknown error'));
                                                                                }
                                                            }}
                                                                            className="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-xs font-bold hover:bg-gray-200 transition"
                                                                        >
                                                                            <Icon icon="fa-eye" className="mr-1" /> ดูรายละเอียด
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        );
                                    })()}
                                </div>
                            )}
                        </main>
                    </div>
                </div>

                {/* MOBILE BOTTOM NAVIGATION */}
                <div className="lg:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 flex justify-around items-center h-16 pb-safe z-30 shadow-[0_-4px_20px_rgba(0,0,0,0.08)]">
                    {user?.role === 'admin' ? (
                        <>
                            <button onClick={()=>changePage('admin_dashboard')} className={`flex flex-col items-center flex-1 py-1 transition ${page==='admin_dashboard'?'text-gray-900 font-bold':'text-gray-400 font-normal'}`}><Icon icon="fa-chart-line" className="text-lg"/><span className="text-[10px] mt-0.5 font-medium">Dashboard</span></button>
                            <button onClick={()=>changePage('admin_orders')} className={`flex flex-col items-center flex-1 py-1 transition ${page==='admin_orders'?'text-gray-900 font-bold':'text-gray-400 font-normal'}`}><Icon icon="fa-list-alt" className="text-lg"/><span className="text-[10px] mt-0.5 font-medium">Orders</span></button>
                            <button onClick={()=>changePage('admin_stock')} className={`flex flex-col items-center flex-1 py-1 transition ${page==='admin_stock'?'text-gray-900 font-bold':'text-gray-400 font-normal'}`}><Icon icon="fa-box" className="text-lg"/><span className="text-[10px] mt-0.5 font-medium">Stock</span></button>
                            {/* Admin Logout Button */}
                            <button onClick={handleLogout} className="flex flex-col items-center flex-1 py-1 transition text-red-500 font-bold"><Icon icon="fa-sign-out-alt" className="text-lg"/><span className="text-[10px] mt-0.5">Logout</span></button>
                        </>
                    ) : (
                        <>
                            <button onClick={()=>changePage('tax_invoice')} className={`flex flex-col items-center flex-1 py-1 transition ${page==='tax_invoice'?'text-gray-900 font-bold':'text-gray-400 font-normal'}`}><Icon icon="fa-receipt" className="text-lg"/><span className="text-[10px] mt-0.5 font-medium">Tax Info</span></button>
                            <button onClick={()=>changePage('home')} className={`flex flex-col items-center flex-1 py-1 relative z-10 transition ${page==='home'?'text-gray-900':'text-gray-400'}`}><div className={`bg-green-600 text-white rounded-full w-14 h-14 flex items-center justify-center -mt-10 shadow-xl border-4 border-white active:scale-90 transition duration-300 hover:bg-green-700 ${page==='home' ? 'ring-2 ring-green-400' : ''}`}><Icon icon="fa-shopping-bag" className="text-xl"/></div><span className={`text-[10px] mt-1 font-bold ${page==='home'?'text-gray-900':'text-gray-400'} uppercase tracking-wider`}>Shop</span></button>
                            <button onClick={()=>changePage('history')} className={`flex flex-col items-center flex-1 py-1 transition ${page==='history'?'text-gray-900 font-bold':'text-gray-400 font-normal'}`}><Icon icon="fa-history" className="text-lg"/><span className="text-[10px] mt-0.5 font-medium">History</span></button>
                        </>
                    )}
                </div>
                
                {/* Cart Modal */}
                {isCartOpen && (
                    <div className="fixed inset-0 z-50 flex items-end justify-center sm:items-center text-gray-800 font-normal">
                        <div className="absolute inset-0 bg-black bg-opacity-60 transition-opacity" onClick={() => setIsCartOpen(false)}></div>
                        <div className="bg-white w-full sm:max-w-md h-[85vh] sm:h-auto sm:max-h-[90vh] rounded-t-3xl sm:rounded-2xl z-10 flex flex-col slide-up-modal overflow-hidden shadow-2xl">
                            <div className="p-5 bg-green-600 text-white flex justify-between items-center shrink-0 shadow-lg font-bold"><h2 className="font-bold text-lg flex items-center"><Icon icon="fa-shopping-cart" className="mr-2"/> ตะกร้าสินค้า ({cart.length})</h2><button onClick={()=>setIsCartOpen(false)} className="p-1 hover:bg-white/10 rounded-lg transition"><Icon icon="fa-times" className="text-xl"/></button></div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 text-sm">
                                {cart.length === 0 ? <div className="text-center py-20 text-gray-400 font-normal">ยังไม่มีสินค้าในตะกร้า</div> : cart.map(item => (
                                    <div key={item.id} className="flex gap-4 bg-white p-4 rounded-2xl border border-gray-100 shadow-sm transition transform font-normal">
                                        <img src={item.image} className="w-20 h-20 object-cover rounded-xl bg-gray-100 border"/>
                                        <div className="flex-1 flex flex-col justify-between py-0.5">
                                            <div>
                                                <div className="font-bold line-clamp-1 text-gray-800 text-sm font-bold">{item.name}</div>
                                                <div className="text-[11px] text-gray-400 mt-1 font-medium bg-gray-50 inline-block px-2 py-0.5 rounded-md font-normal">฿{item.price.toLocaleString()} / {item.unit || 'ชิ้น'}</div>
                                            </div>
                                            <div className="flex justify-between items-end font-normal">
                                                <div className="font-bold text-emerald-700 text-base font-bold">฿{(item.price*item.qty).toLocaleString()}</div>
                                                <div className="flex items-center gap-2 bg-gray-100 px-2 py-1 rounded-lg border font-bold">
                                                    <button 
                                                        onClick={()=>updateQty(item.id,-1)} 
                                                        className="font-bold text-gray-500 hover:text-gray-800 transition px-2 text-lg"
                                                    >
                                                        -
                                                    </button>
                                                    <input
                                                        type="number"
                                                        min="1"
                                                        max={products.find(p => p.id === item.id)?.stock || 999}
                                                        value={item.qty}
                                                        onChange={(e) => updateQtyDirect(item.id, e.target.value)}
                                                        onBlur={(e) => {
                                                            const value = parseInt(e.target.value) || 1;
                                                            if (value < 1) {
                                                                updateQtyDirect(item.id, 1);
                                                            }
                                                        }}
                                                        className="text-xs font-bold w-12 text-center font-bold text-gray-800 bg-transparent border-none outline-none focus:ring-0 p-0"
                                                        style={{ WebkitAppearance: 'textfield', MozAppearance: 'textfield' }}
                                                    />
                                                    <button 
                                                        onClick={()=>updateQty(item.id,1)} 
                                                        className="font-bold text-gray-500 hover:text-gray-800 transition px-2 text-lg"
                                                    >
                                                        +
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            {cart.length > 0 && (
                                <div className="p-5 border-t bg-white shadow-[0_-4px_15px_rgba(0,0,0,0.05)] shrink-0 font-bold">
                                    <div className="flex justify-between font-bold text-lg mb-4 text-gray-800"><span>ยอดรวมสินค้า</span><span className="text-emerald-700 font-bold">฿{calculateSubtotal().toLocaleString()}</span></div>
                                    <button onClick={()=>{setIsCheckoutOpen(true);setIsCartOpen(false)}} className="w-full bg-green-600 text-white py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition-all hover:bg-green-700 uppercase">ดำเนินการชำระเงิน</button>
                                </div>
                            )}
                        </div>
                    </div>
                )}
                
                {/* Checkout Modal */}
                {isCheckoutOpen && (
                    <div className="fixed inset-0 z-[60] flex items-end justify-center sm:items-center text-gray-800 font-normal">
                         <div className="absolute inset-0 bg-black bg-opacity-75 backdrop-blur-sm" onClick={() => setIsCheckoutOpen(false)}></div>
                         <div className="bg-white w-full sm:max-w-lg h-[90vh] sm:h-auto sm:max-h-[90vh] rounded-t-3xl sm:rounded-2xl shadow-2xl z-10 flex flex-col slide-up-modal overflow-hidden text-sm text-gray-800 font-normal">
                             <div className="p-5 bg-green-600 text-white font-bold flex justify-between items-center shrink-0 shadow-lg"><span>ยืนยันข้อมูลการสั่งซื้อ</span><button onClick={()=>setIsCheckoutOpen(false)} className="p-1 hover:bg-white/10 rounded-lg transition"><Icon icon="fa-times" className="text-lg"/></button></div>
                             <div className="flex-1 overflow-y-auto p-5 space-y-5 bg-gray-50">
                                 <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 font-normal">
                                     <h4 className="font-bold text-xs mb-3 border-b pb-2 text-gray-400 uppercase tracking-widest flex items-center font-bold"><Icon icon="fa-shopping-basket" className="mr-2"/> สรุปรายการสั่งซื้อ</h4>
                                     <div className="space-y-3 max-h-40 overflow-y-auto mb-4 pr-1 font-normal">
                                        {cart.map(i => (
                                            <div key={i.id} className="flex justify-between text-xs text-gray-600 font-normal">
                                                <span className="truncate w-2/3">{i.name} x{i.qty} {i.unit || 'ชิ้น'}</span>
                                                <span className="font-bold text-gray-800">฿{(i.price*i.qty).toLocaleString()}</span>
                                            </div>
                                        ))}
                                     </div>
                                     <div className="border-t pt-3 space-y-1.5 font-normal">
                                         <div className="flex justify-between text-gray-500 font-normal"><span>ค่าสินค้า</span><span>฿{calculateSubtotal().toLocaleString()}</span></div>
                                         <div className="flex justify-between text-blue-500 font-bold"><span>ค่าจัดส่ง</span><span>฿{shippingCost.toLocaleString()}</span></div>
                                         {discountAmount > 0 && <div className="flex justify-between text-rose-500 font-bold"><span>ส่วนลดคูปอง</span><span>-฿{discountAmount.toLocaleString()}</span></div>}
                                         <div className="flex justify-between font-bold text-lg pt-3 border-t border-dashed mt-3 text-emerald-800 uppercase tracking-wide"><span>ยอดชำระสุทธิ</span><span>฿{calculateNetTotal().toLocaleString()}</span></div>
                                     </div>
                                     <div className="mt-4 pt-4 border-t border-gray-100 font-normal">
                                         {!appliedCoupon ? (
                                            <button onClick={openCouponPopup} className="w-full py-2.5 bg-gray-50 text-gray-500 rounded-xl text-xs font-bold border border-dashed border-gray-300 hover:bg-white transition font-bold uppercase tracking-wider">ใช้รหัสส่วนลด</button>
                                         ) : (
                                            <div className="flex justify-between items-center bg-emerald-50 px-3 py-2 rounded-lg text-xs text-emerald-700 border border-emerald-200 font-bold">
                                                <span>ใช้โค้ด <b>{appliedCoupon}</b> แล้ว</span>
                                                <button onClick={()=>{setAppliedCoupon(null);setDiscountAmount(0)}} className="text-emerald-900 font-bold underline">ลบออก</button>
                                            </div>
                                         )}
                                     </div>
                                 </div>
                                 <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-200">
                                    <label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest block mb-2 font-bold">ที่อยู่จัดส่งสินค้า</label>
                                    <div className="flex gap-2 items-start font-normal"><Icon icon="fa-map-marker-alt" className="text-rose-500 mt-1 shrink-0"/><div className="text-gray-700 leading-relaxed text-xs">{user?.address || "กรุณากรอกข้อมูลที่อยู่ในเมนูโปรไฟล์"}</div></div>
                                 </div>
                                 <div className="bg-green-700 p-5 rounded-3xl text-white relative overflow-hidden shadow-xl border-t border-white/10 font-bold">
                                    <div className="relative z-10 text-center">
                                        <div className="flex justify-between items-center mb-4 text-gray-800"><span className="text-[10px] opacity-80 uppercase tracking-widest font-bold font-mono text-white">Kasikorn Bank</span><Icon icon="fa-wifi" className="rotate-90 opacity-50 text-white"/></div>
                                        <div className="text-2xl font-mono font-bold tracking-[3px] mb-4 flex items-center justify-center gap-2 font-bold" onClick={() => { navigator.clipboard.writeText('189-2-88192-4'); Toast.fire({ icon: 'success', title: 'คัดลอกเลขบัญชีแล้ว' }); }}>189-2-88192-4 <Icon icon="fa-copy" className="opacity-50 text-sm cursor-pointer hover:opacity-100 transition"/></div>
                                        <div className="text-sm font-bold opacity-90 uppercase tracking-wide">บจก. ไชยจันลา</div>
                                    </div>
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-10 -mt-10 blur-2xl font-normal"></div>
                                 </div>
                                 <div className="border-2 border-dashed border-gray-300 p-8 rounded-3xl text-center bg-white cursor-pointer hover:border-gray-800 transition-colors group relative shadow-inner font-normal" onClick={()=>document.getElementById('final-slip-input-v23').click()}>
                                    <input id="final-slip-input-v23" type="file" accept="image/*" hidden onChange={(e)=>setSlipFile(e.target.files[0])} />
                                    {slipFile ? <div className="text-emerald-600 font-bold flex flex-col items-center gap-2"><Icon icon="fa-check-circle" className="text-3xl font-bold"/><span>แนบหลักฐานแล้ว</span><span className="text-[10px] font-normal text-gray-400 truncate w-40 px-4">{slipFile.name}</span></div> : <div className="text-gray-400 flex flex-col items-center gap-2 group-hover:text-gray-600 font-normal"><Icon icon="fa-cloud-upload-alt" className="text-4xl mb-1"/><span>แตะที่นี่เพื่อแนบสลิปโอนเงิน</span></div>}
                                 </div>
                             </div>
                             <div className="p-5 bg-white border-t pb-safe shadow-[0_-10px_20px_rgba(0,0,0,0.05)] shrink-0 font-bold"><button onClick={handlePlaceOrder} className="w-full bg-green-600 text-white py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition-all hover:bg-green-700 uppercase tracking-widest">ยืนยันการสั่งซื้อ</button></div>
                         </div>
                    </div>
                )}

                {/* Edit Order Modal (Admin Only) */}
                {isEditModalOpen && editingOrder && (
                    <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 text-gray-800 font-normal">
                        <div className="absolute inset-0 bg-black bg-opacity-70 font-normal" onClick={() => setIsEditModalOpen(false)}></div>
                        <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl z-10 overflow-hidden flex flex-col max-h-[90vh] font-normal">
                            <div className="p-4 bg-green-700 text-white font-bold flex justify-between items-center font-bold">
                                <span><Icon icon="fa-edit" className="mr-2 font-bold"/>แก้ไขออเดอร์ {editingOrder.id}</span>
                                <button onClick={() => setIsEditModalOpen(false)}><Icon icon="fa-times"/></button>
                            </div>
                            <div className="p-4 overflow-y-auto flex-1 bg-gray-50 font-normal">
                                {editingOrder.items.map((item, idx) => (
                                    <div key={idx} className="bg-white p-4 rounded-xl shadow-sm mb-3 border border-gray-100 font-normal">
                                        <div className="flex justify-between items-start mb-2">
                                            <div className="flex-1">
                                                <div className="font-bold text-sm text-gray-800 font-bold">{item.name}</div>
                                                {user?.role === 'admin' && (
                                                    <div className="mt-2 flex items-center gap-2">
                                                        <span className="text-xs text-gray-500">ราคา:</span>
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            step="0.01"
                                                            value={item.price}
                                                            onChange={(e) => {
                                                                const newItems = [...editingOrder.items];
                                                                newItems[idx].price = Number(e.target.value) || 0;
                                                                setEditingOrder({ ...editingOrder, items: newItems });
                                                            }}
                                                            onBlur={(e) => {
                                                                const newPrice = Number(e.target.value) || 0;
                                                                if (newPrice !== item.price && newPrice >= 0) {
                                                                    updateEditPrice(idx, newPrice);
                                                                }
                                                            }}
                                                            className="w-24 text-sm text-center font-bold text-gray-800 bg-gray-50 border border-gray-300 rounded-lg px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                            style={{ WebkitAppearance: 'textfield', MozAppearance: 'textfield' }}
                                                        />
                                                        <span className="text-xs text-gray-500">บาท</span>
                                                    </div>
                                                )}
                                                {user?.role !== 'admin' && (
                                                    <div className="text-xs text-gray-400 mt-1">฿{item.price.toLocaleString()}</div>
                                                )}
                                            </div>
                                        </div>
                                        <div className="flex items-center justify-end gap-2">
                                            <button onClick={() => updateEditQty(idx, -1)} className="w-8 h-8 bg-gray-100 rounded-lg text-gray-500 font-bold hover:bg-red-50 hover:text-red-600 transition font-bold">-</button>
                                            <input
                                                type="number"
                                                min="1"
                                                value={item.qty}
                                                onChange={(e) => updateEditQtyDirect(idx, e.target.value)}
                                                onBlur={(e) => {
                                                    const value = parseInt(e.target.value) || 1;
                                                    if (value < 1) {
                                                        updateEditQtyDirect(idx, 1);
                                                    }
                                                }}
                                                className="w-14 text-center font-bold text-gray-800 bg-transparent border border-gray-200 rounded-lg px-2 py-1 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                                style={{ WebkitAppearance: 'textfield', MozAppearance: 'textfield' }}
                                            />
                                            <button onClick={() => updateEditQty(idx, 1)} className="w-8 h-8 bg-gray-100 rounded-lg text-gray-500 font-bold hover:bg-green-50 hover:text-green-600 transition font-bold">+</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="p-5 border-t bg-white font-bold">
                                <div className="flex justify-between items-center mb-4 font-bold">
                                    <span className="text-sm font-bold text-gray-500 uppercase tracking-widest font-bold">ยอดส่วนต่าง</span>
                                    <div className={`text-lg font-bold ${editingOrderDiff > 0 ? 'text-emerald-600' : editingOrderDiff < 0 ? 'text-rose-600' : 'text-gray-400'}`}>
                                        {editingOrderDiff > 0 ? `+฿${editingOrderDiff.toLocaleString()}` : editingOrderDiff < 0 ? `-฿${Math.abs(editingOrderDiff).toLocaleString()}` : 'ไม่มีส่วนต่าง'}
                                    </div>
                                </div>
                                <button onClick={saveEditOrder} className="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition font-bold uppercase tracking-widest">ยืนยันการเปลี่ยนแปลง</button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Create PO Modal */}
                {isPOModalOpen && (
                    <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 text-gray-800 font-normal">
                        <div className="absolute inset-0 bg-black bg-opacity-70" onClick={() => setIsPOModalOpen(false)}></div>
                        <div className="bg-white w-full max-w-4xl rounded-2xl shadow-2xl z-10 overflow-hidden flex flex-col max-h-[90vh] font-normal">
                            <div className="p-4 bg-green-700 text-white font-bold flex justify-between items-center">
                                <span><Icon icon="fa-shopping-cart" className="mr-2" />สร้าง Purchase Order ใหม่</span>
                                <button onClick={() => setIsPOModalOpen(false)}><Icon icon="fa-times" /></button>
                            </div>
                            <div className="p-6 overflow-y-auto flex-1 bg-gray-50">
                                <div className="space-y-4 mb-4">
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">ชื่อซัพพลายเออร์ *</label>
                                        <div className="relative">
                                            <select
                                                className="w-full border rounded p-3 outline-none focus:ring-2 focus:ring-gray-800 appearance-none bg-white"
                                                value={poSupplier}
                                                onChange={e => {
                                                    const value = e.target.value;
                                                    if (value === '__custom__') {
                                                        Swal.fire({
                                                            title: 'ระบุชื่อซัพพลายเออร์',
                                                            input: 'text',
                                                            inputPlaceholder: 'กรอกชื่อซัพพลายเออร์',
                                                            showCancelButton: true,
                                                            confirmButtonText: 'ยืนยัน',
                                                            confirmButtonColor: THEME_COLOR,
                                                            inputValidator: (value) => {
                                                                if (!value || value.trim() === '') {
                                                                    return 'กรุณาระบุชื่อซัพพลายเออร์';
                                                                }
                                                            }
                                                        }).then((result) => {
                                                            if (result.isConfirmed && result.value) {
                                                                setPoSupplier(result.value.trim());
                                                            }
                                                        });
                                                    } else {
                                                        setPoSupplier(value);
                                                    }
                                                }}
                                            >
                                                <option value="">-- เลือกซัพพลายเออร์ --</option>
                                                {uniqueSuppliers.filter(sup => sup !== 'All').map(supplier => (
                                                    <option key={supplier} value={supplier}>{supplier}</option>
                                                ))}
                                                <option value="__custom__">+ เพิ่มซัพพลายเออร์ใหม่</option>
                                            </select>
                                            <div className="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                                                <Icon icon="fa-chevron-down" />
                                            </div>
                                        </div>
                                        {poSupplier && poSupplier !== '' && (
                                            <div className="mt-2 text-sm text-gray-600">
                                                <Icon icon="fa-check-circle" className="text-green-500 mr-1" />
                                                เลือก: <strong>{poSupplier}</strong>
                                            </div>
                                        )}
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">วันที่คาดว่าจะได้รับ</label>
                                            <input
                                                type="date"
                                                className="w-full border rounded p-3 outline-none focus:ring-2 focus:ring-gray-800"
                                                value={poExpectedDate}
                                                onChange={e => setPoExpectedDate(e.target.value)}
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">หมายเหตุ</label>
                                        <textarea
                                            className="w-full border rounded p-3 outline-none focus:ring-2 focus:ring-gray-800"
                                            rows="2"
                                            value={poNotes}
                                            onChange={e => setPoNotes(e.target.value)}
                                            placeholder="หมายเหตุเพิ่มเติม..."
                                        />
                                    </div>
                                </div>

                                    <div className="mb-4">
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="block text-sm font-bold text-gray-700">รายการสินค้า</label>
                                    </div>
                                    
                                    {/* ช่องค้นหาสินค้า */}
                                    <div className="mb-3">
                                        <div className="relative">
                                            <span className="absolute left-3 top-3 text-gray-400"><Icon icon="fa-search"/></span>
                                            <input
                                                className="w-full pl-10 p-3 border rounded-lg bg-white focus:ring-2 focus:ring-gray-800 outline-none transition"
                                                placeholder="ค้นหาสินค้าเพื่อเพิ่มในรายการ..."
                                                value={poProductSearch}
                                                onChange={e => setPoProductSearch(e.target.value)}
                                            />
                                        </div>
                                    </div>
                                    
                                    {/* รายการสินค้าที่ค้นหาได้ */}
                                    {poProductSearch.trim() !== '' && (
                                        <div className="mb-3 max-h-48 overflow-y-auto border rounded-lg bg-white">
                                            {products
                                                .filter(p => p.name.toLowerCase().includes(poProductSearch.toLowerCase()))
                                                .map(product => (
                                                    <div
                                                        key={product.id}
                                                        onClick={() => {
                                                            addPOItem(product);
                                                            setPoProductSearch('');
                                                        }}
                                                        className="p-3 border-b last:border-b-0 cursor-pointer hover:bg-gray-50 transition flex justify-between items-center"
                                                    >
                                                        <div className="flex-1">
                                                            <div className="font-bold text-sm">{product.name}</div>
                                                            <div className="text-xs text-gray-500 mt-1">
                                                                ฿{Number(product.price || 0).toLocaleString()} / {product.unit || 'ชิ้น'}
                                                                <span className={`ml-2 px-2 py-0.5 rounded text-xs font-bold ${product.stock <= 5 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>
                                                                    คงเหลือ: {product.stock} {product.unit || 'ชิ้น'}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <button className="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-700">
                                                            <Icon icon="fa-plus" className="mr-1" /> เพิ่ม
                                                        </button>
                                                    </div>
                                                ))
                                            }
                                            {products.filter(p => p.name.toLowerCase().includes(poProductSearch.toLowerCase())).length === 0 && (
                                                <div className="p-4 text-center text-gray-400 text-sm">ไม่พบสินค้า</div>
                                            )}
                                        </div>
                                    )}
                                    
                                    {/* ปุ่มเพิ่มสินค้า (ถ้าไม่ใช้ช่องค้นหา) */}
                                    {poProductSearch.trim() === '' && (
                                        <div className="mb-3">
                                            <button
                                                onClick={() => {
                                                    const productOptions = products.map(p => ({
                                                        value: p.id,
                                                        text: `${p.name} - ฿${Number(p.price || 0).toLocaleString()} (คงเหลือ: ${p.stock} ${p.unit || 'ชิ้น'})`
                                                    }));
                                                    
                                                    Swal.fire({
                                                        title: 'เลือกสินค้า',
                                                        input: 'select',
                                                        inputOptions: productOptions.reduce((acc, opt, idx) => {
                                                            acc[opt.value] = opt.text;
                                                            return acc;
                                                        }, {}),
                                                        showCancelButton: true,
                                                        confirmButtonText: 'เพิ่ม',
                                                        confirmButtonColor: THEME_COLOR,
                                                        inputValidator: (value) => {
                                                            if (!value) {
                                                                return 'กรุณาเลือกสินค้า';
                                                            }
                                                        }
                                                    }).then((result) => {
                                                        if (result.isConfirmed && result.value) {
                                                            const selectedProduct = products.find(p => p.id === result.value);
                                                            if (selectedProduct) {
                                                                addPOItem(selectedProduct);
                                                            }
                                                        }
                                                    });
                                                }}
                                                className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition w-full"
                                            >
                                                <Icon icon="fa-plus" className="mr-1" /> เพิ่มสินค้า
                                            </button>
                                        </div>
                                    )}
                                    {poItems.length === 0 ? (
                                        <div className="text-center py-8 text-gray-400 border-2 border-dashed rounded">
                                            ยังไม่มีสินค้าในรายการ
                                        </div>
                                    ) : (
                                        <div className="space-y-2 max-h-64 overflow-y-auto">
                                            {poItems.map((item, idx) => (
                                                <div key={idx} className="bg-white p-3 rounded border flex justify-between items-center">
                                                    <div className="flex-1">
                                                        <div className="font-bold">{item.productName}</div>
                                                        <div className="text-sm text-gray-500">฿{Number(item.price).toLocaleString()} / หน่วย</div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <button onClick={() => updatePOItemQty(item.productId, -1)} className="w-8 h-8 bg-gray-100 rounded text-gray-600 hover:bg-red-50 hover:text-red-600 transition">-</button>
                                                        <input
                                                            type="number"
                                                            min="1"
                                                            value={item.qty}
                                                            onChange={(e) => updatePOItemQtyDirect(item.productId, e.target.value)}
                                                            onBlur={(e) => {
                                                                const value = parseInt(e.target.value) || 1;
                                                                if (value < 1) {
                                                                    updatePOItemQtyDirect(item.productId, 1);
                                                                }
                                                            }}
                                                            className="w-14 text-center font-bold text-gray-800 bg-transparent border border-gray-200 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                                            style={{ WebkitAppearance: 'textfield', MozAppearance: 'textfield' }}
                                                        />
                                                        <button onClick={() => updatePOItemQty(item.productId, 1)} className="w-8 h-8 bg-gray-100 rounded text-gray-600 hover:bg-green-50 hover:text-green-600 transition">+</button>
                                                        <div className="w-24 text-right font-bold text-emerald-700">
                                                            ฿{(item.price * item.qty).toLocaleString()}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    {poItems.length > 0 && (
                                        <div className="mt-4 pt-4 border-t flex justify-between items-center font-bold text-lg">
                                            <span>ยอดรวม:</span>
                                            <span className="text-emerald-700">฿{poItems.reduce((sum, item) => sum + (item.price * item.qty), 0).toLocaleString()}</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="p-5 border-t bg-white">
                                <button
                                    onClick={handleCreatePO}
                                    className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition"
                                >
                                    สร้าง PO
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Receive PO Modal */}
                {isReceivePOModalOpen && selectedPO && (
                    <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 text-gray-800 font-normal">
                        <div className="absolute inset-0 bg-black bg-opacity-70" onClick={() => setIsReceivePOModalOpen(false)}></div>
                        <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl z-10 overflow-hidden flex flex-col max-h-[90vh] font-normal">
                            <div className="p-4 bg-green-700 text-white font-bold flex justify-between items-center">
                                <span><Icon icon="fa-check-circle" className="mr-2" />รับสินค้า {selectedPO.id}</span>
                                <button onClick={() => setIsReceivePOModalOpen(false)}><Icon icon="fa-times" /></button>
                            </div>
                            <div className="p-6 overflow-y-auto flex-1 bg-gray-50">
                                <div className="mb-4">
                                    <p className="text-sm text-gray-600 mb-2"><strong>ซัพพลายเออร์:</strong> {selectedPO.supplier}</p>
                                    <p className="text-sm text-gray-600"><strong>ยอดรวม:</strong> ฿{Number(selectedPO.totalAmount).toLocaleString()}</p>
                                </div>
                                <div className="space-y-3">
                                    {selectedPO.items.map((item, idx) => (
                                        <div key={idx} className="bg-white p-4 rounded border">
                                            <div className="flex justify-between items-center mb-2">
                                                <div>
                                                    <div className="font-bold">{item.productName}</div>
                                                    <div className="text-sm text-gray-500">สั่ง: {item.qty} หน่วย @ ฿{Number(item.price).toLocaleString()}</div>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <label className="text-sm font-bold">รับจริง:</label>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    max={item.qty}
                                                    className="w-24 border rounded p-2 text-center"
                                                    defaultValue={item.qty}
                                                    onChange={e => {
                                                        const newItems = [...selectedPO.items];
                                                        newItems[idx].receivedQty = parseInt(e.target.value) || 0;
                                                        setSelectedPO({ ...selectedPO, items: newItems });
                                                    }}
                                                />
                                                <span className="text-sm text-gray-500">/ {item.qty}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="p-5 border-t bg-white">
                                <button
                                    onClick={confirmReceivePO}
                                    className="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition"
                                >
                                    <Icon icon="fa-check" className="mr-2" /> ยืนยันรับสินค้า
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Add Product Modal */}
                {isAddProductModalOpen && (
                    <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 text-gray-800 font-normal">
                        <div className="absolute inset-0 bg-black bg-opacity-70" onClick={() => setIsAddProductModalOpen(false)}></div>
                        <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl z-10 overflow-hidden flex flex-col max-h-[90vh] font-normal">
                            <div className="p-4 bg-green-700 text-white font-bold flex justify-between items-center">
                                <span><Icon icon="fa-plus-circle" className="mr-2" />เพิ่มสินค้าใหม่</span>
                                <button onClick={() => setIsAddProductModalOpen(false)}><Icon icon="fa-times"/></button>
                            </div>
                            <div className="p-6 overflow-y-auto flex-1 bg-gray-50">
                                <div className="space-y-4">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">Product ID <span className="text-gray-400 text-xs">(ถ้าไม่กรอกจะสร้างอัตโนมัติ)</span></label>
                                            <input
                                                type="text"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="P001 หรือปล่อยว่าง"
                                                value={productForm.productId}
                                                onChange={e => setProductForm({...productForm, productId: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">ชื่อสินค้า *</label>
                                            <input
                                                type="text"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="ชื่อสินค้า"
                                                value={productForm.name}
                                                onChange={e => setProductForm({...productForm, name: e.target.value})}
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">ราคา *</label>
                                            <input
                                                type="number"
                                                min="0"
                                                step="0.01"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="0"
                                                value={productForm.price}
                                                onChange={e => setProductForm({...productForm, price: e.target.value})}
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">ราคาแฟรนไชส์</label>
                                            <input
                                                type="number"
                                                min="0"
                                                step="0.01"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="ถ้าไม่กรอกจะใช้ราคาปกติ"
                                                value={productForm.franchisePrice}
                                                onChange={e => setProductForm({...productForm, franchisePrice: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">ต้นทุนสินค้า</label>
                                            <input
                                                type="number"
                                                min="0"
                                                step="0.01"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="0"
                                                value={productForm.cost}
                                                onChange={e => setProductForm({...productForm, cost: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">สต็อกเริ่มต้น</label>
                                            <input
                                                type="number"
                                                min="0"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="0"
                                                value={productForm.stock}
                                                onChange={e => setProductForm({...productForm, stock: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">หมวดหมู่</label>
                                            <input
                                                type="text"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="หมวดหมู่สินค้า"
                                                value={productForm.category}
                                                onChange={e => setProductForm({...productForm, category: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">ซัพพลายเออร์</label>
                                            <input
                                                type="text"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="ชื่อซัพพลายเออร์"
                                                value={productForm.supplier}
                                                onChange={e => setProductForm({...productForm, supplier: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">หน่วย</label>
                                            <input
                                                type="text"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="ชิ้น, กล่อง, กิโลกรัม"
                                                value={productForm.unit}
                                                onChange={e => setProductForm({...productForm, unit: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">น้ำหนัก (กรัม)</label>
                                            <input
                                                type="number"
                                                min="0"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="0"
                                                value={productForm.weight}
                                                onChange={e => setProductForm({...productForm, weight: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">Min Stock (สต็อกต่ำสุด)</label>
                                            <input
                                                type="number"
                                                min="0"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="5"
                                                value={productForm.minStock}
                                                onChange={e => setProductForm({...productForm, minStock: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">URL รูปภาพ</label>
                                            <input
                                                type="url"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="https://..."
                                                value={productForm.image}
                                                onChange={e => setProductForm({...productForm, image: e.target.value})}
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">รายละเอียด</label>
                                        <textarea
                                            className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                            rows="3"
                                            placeholder="รายละเอียดสินค้า..."
                                            value={productForm.detail}
                                            onChange={e => setProductForm({...productForm, detail: e.target.value})}
                                        />
                                    </div>
                                </div>
                            </div>
                            <div className="p-5 border-t bg-white flex justify-end gap-3">
                                <button
                                    onClick={() => setIsAddProductModalOpen(false)}
                                    className="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition font-bold"
                                >
                                    ยกเลิก
                                </button>
                                <button
                                    onClick={handleAddProduct}
                                    className="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition font-bold"
                                >
                                    <Icon icon="fa-check" className="mr-2" /> เพิ่มสินค้า
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Edit Product Modal */}
                {isEditProductModalOpen && editingProduct && (
                    <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 text-gray-800 font-normal">
                        <div className="absolute inset-0 bg-black bg-opacity-70" onClick={() => setIsEditProductModalOpen(false)}></div>
                        <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl z-10 overflow-hidden flex flex-col max-h-[90vh] font-normal">
                            <div className="p-4 bg-green-700 text-white font-bold flex justify-between items-center">
                                <span><Icon icon="fa-edit" className="mr-2" />แก้ไขสินค้า: {editingProduct.id}</span>
                                <button onClick={() => setIsEditProductModalOpen(false)}><Icon icon="fa-times"/></button>
                            </div>
                            <div className="p-6 overflow-y-auto flex-1 bg-gray-50">
                                <div className="space-y-4">
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                                        <p className="text-sm text-blue-800 font-bold">
                                            <Icon icon="fa-info-circle" className="mr-1" />
                                            Product ID: <span className="font-mono">{editingProduct.id}</span> (ไม่สามารถแก้ไขได้)
                                        </p>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">ชื่อสินค้า *</label>
                                            <input
                                                type="text"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="ชื่อสินค้า"
                                                value={editProductForm.name}
                                                onChange={e => setEditProductForm({...editProductForm, name: e.target.value})}
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">ราคา *</label>
                                            <input
                                                type="number"
                                                min="0"
                                                step="0.01"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="0"
                                                value={editProductForm.price}
                                                onChange={e => setEditProductForm({...editProductForm, price: e.target.value})}
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">ราคาแฟรนไชส์</label>
                                            <input
                                                type="number"
                                                min="0"
                                                step="0.01"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="ถ้าไม่กรอกจะใช้ราคาปกติ"
                                                value={editProductForm.franchisePrice}
                                                onChange={e => setEditProductForm({...editProductForm, franchisePrice: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">ต้นทุนสินค้า</label>
                                            <input
                                                type="number"
                                                min="0"
                                                step="0.01"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="0"
                                                value={editProductForm.cost}
                                                onChange={e => setEditProductForm({...editProductForm, cost: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">สต็อก</label>
                                            <input
                                                type="number"
                                                min="0"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="0"
                                                value={editProductForm.stock}
                                                onChange={e => setEditProductForm({...editProductForm, stock: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">หมวดหมู่</label>
                                            <input
                                                type="text"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="หมวดหมู่สินค้า"
                                                value={editProductForm.category}
                                                onChange={e => setEditProductForm({...editProductForm, category: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">ซัพพลายเออร์</label>
                                            <input
                                                type="text"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="ชื่อซัพพลายเออร์"
                                                value={editProductForm.supplier}
                                                onChange={e => setEditProductForm({...editProductForm, supplier: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">หน่วย</label>
                                            <input
                                                type="text"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="ชิ้น, กล่อง, กิโลกรัม"
                                                value={editProductForm.unit}
                                                onChange={e => setEditProductForm({...editProductForm, unit: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">น้ำหนัก (กรัม)</label>
                                            <input
                                                type="number"
                                                min="0"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="0"
                                                value={editProductForm.weight}
                                                onChange={e => setEditProductForm({...editProductForm, weight: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">Min Stock (สต็อกต่ำสุด)</label>
                                            <input
                                                type="number"
                                                min="0"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="5"
                                                value={editProductForm.minStock}
                                                onChange={e => setEditProductForm({...editProductForm, minStock: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">URL รูปภาพ</label>
                                            <input
                                                type="url"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="https://..."
                                                value={editProductForm.image}
                                                onChange={e => setEditProductForm({...editProductForm, image: e.target.value})}
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">รายละเอียด</label>
                                        <textarea
                                            className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                            rows="3"
                                            placeholder="รายละเอียดสินค้า..."
                                            value={editProductForm.detail}
                                            onChange={e => setEditProductForm({...editProductForm, detail: e.target.value})}
                                        />
                                    </div>
                                </div>
                            </div>
                            <div className="p-5 border-t bg-white flex justify-end gap-3">
                                <button
                                    onClick={() => {
                                        setIsEditProductModalOpen(false);
                                        setEditingProduct(null);
                                    }}
                                    className="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition font-bold"
                                >
                                    ยกเลิก
                                </button>
                                <button
                                    onClick={handleUpdateProduct}
                                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-bold"
                                >
                                    <Icon icon="fa-save" className="mr-2" /> บันทึกการแก้ไข
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Bulk Shipping Modal */}
                {isBulkShippingModalOpen && selectedOrdersForShipping.length > 0 && (
                    <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 text-gray-800 font-normal">
                        <div className="absolute inset-0 bg-black bg-opacity-70" onClick={() => setIsBulkShippingModalOpen(false)}></div>
                        <div className="bg-white w-full max-w-3xl rounded-2xl shadow-2xl z-10 overflow-hidden flex flex-col max-h-[90vh] font-normal">
                            <div className="p-4 bg-green-600 text-white font-bold flex justify-between items-center">
                                <span><Icon icon="fa-truck" className="mr-2" />ส่งสินค้าพร้อมกัน ({selectedOrdersForShipping.length} รายการ)</span>
                                <button onClick={() => setIsBulkShippingModalOpen(false)}><Icon icon="fa-times"/></button>
                            </div>
                            <div className="p-6 overflow-y-auto flex-1 bg-gray-50">
                                <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <p className="text-sm text-blue-800 font-bold">
                                        <Icon icon="fa-info-circle" className="mr-1" />
                                        กรุณากรอกเลขพัสดุสำหรับแต่ละออเดอร์ที่เลือก
                                    </p>
                                </div>
                                <div className="space-y-3">
                                    {selectedOrdersForShipping.map(orderId => {
                                        const order = allOrders.find(o => o.id === orderId);
                                        if (!order) return null;
                                        return (
                                            <div key={orderId} className="bg-white p-4 rounded-lg border border-gray-200">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div>
                                                        <div className="font-bold text-gray-800">{order.id}</div>
                                                        <div className="text-xs text-gray-500 mt-1">{order.user}</div>
                                                        <div className="text-xs text-gray-500">ยอดรวม: ฿{(Number(order.total) || 0).toLocaleString()}</div>
                                                    </div>
                                                    <button
                                                        onClick={() => toggleOrderSelection(orderId)}
                                                        className="text-red-500 hover:text-red-700 text-sm font-bold"
                                                    >
                                                        <Icon icon="fa-times" />
                                                    </button>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold text-gray-700 mb-1">เลขพัสดุ *</label>
                                                    <input
                                                        type="text"
                                                        value={trackingNumbers[orderId] || ''}
                                                        onChange={e => handleTrackingNumberChange(orderId, e.target.value)}
                                                        placeholder="กรอกเลขพัสดุ..."
                                                        className="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none text-sm"
                                                        autoFocus={selectedOrdersForShipping.indexOf(orderId) === 0}
                                                    />
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            <div className="p-5 border-t bg-white flex justify-end gap-3">
                                <button
                                    onClick={() => {
                                        setIsBulkShippingModalOpen(false);
                                        setSelectedOrdersForShipping([]);
                                        setTrackingNumbers({});
                                    }}
                                    className="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition font-bold"
                                >
                                    ยกเลิก
                                </button>
                                <button
                                    onClick={handleBulkShipOrders}
                                    className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold"
                                >
                                    <Icon icon="fa-check" className="mr-2" /> ส่งสินค้าทั้งหมด
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Add Franchise Product Modal */}
                {isAddFranchiseProductModalOpen && (
                    <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 text-gray-800 font-normal">
                        <div className="absolute inset-0 bg-black bg-opacity-70" onClick={() => setIsAddFranchiseProductModalOpen(false)}></div>
                        <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl z-10 overflow-hidden flex flex-col max-h-[90vh] font-normal">
                            <div className="p-4 bg-emerald-600 text-white font-bold flex justify-between items-center">
                                <span><Icon icon="fa-plus-circle" className="mr-2" />เพิ่มสินค้าในสต็อกแฟรนไชส์</span>
                                <button onClick={() => setIsAddFranchiseProductModalOpen(false)}><Icon icon="fa-times"/></button>
                            </div>
                            <div className="p-6 overflow-y-auto flex-1 bg-gray-50">
                                <div className="space-y-4">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">Product ID <span className="text-gray-400 text-xs">(ถ้าไม่กรอกจะสร้างอัตโนมัติ)</span></label>
                                            <input
                                                type="text"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="FP-SA001-001 หรือปล่อยว่าง"
                                                value={franchiseProductForm.productId}
                                                onChange={e => setFranchiseProductForm({...franchiseProductForm, productId: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">ชื่อสินค้า *</label>
                                            <input
                                                type="text"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="ชื่อสินค้า"
                                                value={franchiseProductForm.name}
                                                onChange={e => setFranchiseProductForm({...franchiseProductForm, name: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">รูปภาพ (URL)</label>
                                            <input
                                                type="text"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="https://..."
                                                value={franchiseProductForm.image}
                                                onChange={e => setFranchiseProductForm({...franchiseProductForm, image: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">ราคา *</label>
                                            <input
                                                type="number"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="0"
                                                value={franchiseProductForm.franchisePrice}
                                                onChange={e => setFranchiseProductForm({...franchiseProductForm, franchisePrice: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">สต็อกเริ่มต้น</label>
                                            <input
                                                type="number"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="0"
                                                value={franchiseProductForm.stock}
                                                onChange={e => setFranchiseProductForm({...franchiseProductForm, stock: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">หมวดหมู่</label>
                                            <input
                                                type="text"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="เช่น เมล็ดกาแฟ"
                                                value={franchiseProductForm.category}
                                                onChange={e => setFranchiseProductForm({...franchiseProductForm, category: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">หน่วย</label>
                                            <input
                                                type="text"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="ชิ้น"
                                                value={franchiseProductForm.unit}
                                                onChange={e => setFranchiseProductForm({...franchiseProductForm, unit: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">น้ำหนัก (กรัม)</label>
                                            <input
                                                type="number"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="0"
                                                value={franchiseProductForm.weight}
                                                onChange={e => setFranchiseProductForm({...franchiseProductForm, weight: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">สต็อกขั้นต่ำ</label>
                                            <input
                                                type="number"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="5"
                                                value={franchiseProductForm.minStock}
                                                onChange={e => setFranchiseProductForm({...franchiseProductForm, minStock: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">ซัพพลายเออร์</label>
                                            <input
                                                type="text"
                                                className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="ชื่อซัพพลายเออร์"
                                                value={franchiseProductForm.supplier}
                                                onChange={e => setFranchiseProductForm({...franchiseProductForm, supplier: e.target.value})}
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">รายละเอียด</label>
                                        <textarea
                                            className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none"
                                            rows="3"
                                            placeholder="รายละเอียดสินค้า"
                                            value={franchiseProductForm.detail}
                                            onChange={e => setFranchiseProductForm({...franchiseProductForm, detail: e.target.value})}
                                        />
                                    </div>
                                </div>
                            </div>
                            <div className="p-5 border-t bg-white">
                                <button
                                    onClick={handleAddFranchiseProduct}
                                    className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition"
                                >
                                    เพิ่มสินค้า
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Bulk Edit Modal */}
                {isBulkEditModalOpen && (
                    <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 text-gray-800 font-normal">
                        <div className="absolute inset-0 bg-black bg-opacity-70" onClick={() => setIsBulkEditModalOpen(false)}></div>
                        <div className="bg-white w-full max-w-4xl rounded-2xl shadow-2xl z-10 overflow-hidden flex flex-col max-h-[90vh] font-normal">
                            <div className="p-4 bg-orange-600 text-white font-bold flex justify-between items-center">
                                <span><Icon icon="fa-edit" className="mr-2" />แก้ไขสต็อกหลายรายการ</span>
                                <button onClick={() => setIsBulkEditModalOpen(false)}><Icon icon="fa-times"/></button>
                            </div>
                            <div className="p-6 overflow-y-auto flex-1 bg-gray-50">
                                <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <p className="text-sm text-blue-800 font-bold">
                                        <Icon icon="fa-info-circle" className="mr-1" />
                                        แก้ไขสต็อกหลายรายการพร้อมกัน - เลือกการกระทำ: ตั้งค่า, เพิ่ม, หรือ ลด
                                    </p>
                                </div>
                                <div className="bg-white rounded-lg border overflow-hidden">
                                    <table className="w-full text-sm">
                                        <thead className="bg-gray-100 font-bold uppercase text-xs text-gray-600">
                                            <tr>
                                                <th className="p-3 text-left">สินค้า</th>
                                                <th className="p-3 text-center">สต็อกปัจจุบัน</th>
                                                <th className="p-3 text-center">การกระทำ</th>
                                                <th className="p-3 text-center">จำนวน</th>
                                                <th className="p-3 text-left">หมายเหตุ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {bulkEditItems.map((item, idx) => (
                                                <tr key={item.productId} className="hover:bg-gray-50">
                                                    <td className="p-3 font-bold">{item.name}</td>
                                                    <td className="p-3 text-center font-bold">{item.currentStock}</td>
                                                    <td className="p-3">
                                                        <select
                                                            value={item.action}
                                                            onChange={(e) => {
                                                                const newItems = [...bulkEditItems];
                                                                newItems[idx].action = e.target.value;
                                                                if (e.target.value === 'set') {
                                                                    newItems[idx].value = item.currentStock;
                                                                } else {
                                                                    newItems[idx].value = 0;
                                                                }
                                                                setBulkEditItems(newItems);
                                                            }}
                                                            className="w-full border rounded p-2 text-sm focus:ring-2 focus:ring-orange-500 outline-none"
                                                        >
                                                            <option value="set">ตั้งค่า</option>
                                                            <option value="add">เพิ่ม</option>
                                                            <option value="subtract">ลด</option>
                                                        </select>
                                                    </td>
                                                    <td className="p-3">
                                                        <input
                                                            type="number"
                                                            value={item.value}
                                                            onChange={(e) => {
                                                                const newItems = [...bulkEditItems];
                                                                newItems[idx].value = e.target.value;
                                                                setBulkEditItems(newItems);
                                                            }}
                                                            className="w-full border rounded p-2 text-sm focus:ring-2 focus:ring-orange-500 outline-none"
                                                            min="0"
                                                        />
                                                    </td>
                                                    <td className="p-3">
                                                        <input
                                                            type="text"
                                                            value={item.note}
                                                            onChange={(e) => {
                                                                const newItems = [...bulkEditItems];
                                                                newItems[idx].note = e.target.value;
                                                                setBulkEditItems(newItems);
                                                            }}
                                                            placeholder="หมายเหตุ (ถ้ามี)"
                                                            className="w-full border rounded p-2 text-sm focus:ring-2 focus:ring-orange-500 outline-none"
                                                        />
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div className="p-5 border-t bg-white flex gap-2">
                                <button
                                    onClick={handleBulkUpdateStock}
                                    className="flex-1 bg-orange-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-orange-700 transition"
                                >
                                    บันทึกการแก้ไข
                                </button>
                                <button
                                    onClick={() => setIsBulkEditModalOpen(false)}
                                    className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300 transition"
                                >
                                    ยกเลิก
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Import From Order Modal */}
                {isImportFromOrderModalOpen && (
                    <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 text-gray-800 font-normal">
                        <div className="absolute inset-0 bg-black bg-opacity-70" onClick={() => setIsImportFromOrderModalOpen(false)}></div>
                        <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl z-10 overflow-hidden flex flex-col max-h-[90vh] font-normal">
                            <div className="p-4 bg-purple-600 text-white font-bold flex justify-between items-center">
                                <span><Icon icon="fa-download" className="mr-2" />ดึงสินค้าจากออเดอร์</span>
                                <button onClick={() => setIsImportFromOrderModalOpen(false)}><Icon icon="fa-times"/></button>
                            </div>
                            <div className="p-6 overflow-y-auto flex-1 bg-gray-50">
                                <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <p className="text-sm text-blue-800 font-bold">
                                        <Icon icon="fa-info-circle" className="mr-1" />
                                        เลือกออเดอร์ที่ต้องการนำเข้าสินค้าเข้าสต็อก
                                    </p>
                                </div>
                                <div className="space-y-3">
                                    {ordersWithImportStatus.length === 0 ? (
                                        <div className="text-center py-8 text-gray-400">ยังไม่มีออเดอร์</div>
                                    ) : (
                                        ordersWithImportStatus.map(order => (
                                            <div key={order.id} className={`bg-white p-4 rounded-lg border ${order.isImported ? 'border-green-300 bg-green-50' : 'border-gray-200'}`}>
                                                <div className="flex justify-between items-start mb-2">
                                                    <div>
                                                        <div className="font-bold text-gray-800 flex items-center gap-2">
                                                            {order.id}
                                                            {order.isImported && (
                                                                <span className="px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-800">
                                                                    <Icon icon="fa-check-circle" className="mr-1" /> ดึงเข้ามาแล้ว
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div className="text-sm text-gray-500 mt-1">{order.date}</div>
                                                        <div className="text-sm text-gray-500">ยอดรวม: ฿{(Number(order.total) || 0).toLocaleString()}</div>
                                                        <div className="text-xs text-gray-400 mt-1">
                                                            {order.items.length} รายการ: {order.items.map((it, idx) => (
                                                                <span key={idx}>{it.name} x{it.qty}{idx < order.items.length - 1 ? ', ' : ''}</span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                        order.status === 'รอตรวจสอบ' ? 'bg-yellow-100 text-yellow-800' :
                                                        order.status === 'ชำระเงินแล้ว' ? 'bg-blue-100 text-blue-800' :
                                                        'bg-green-100 text-green-800'
                                                    }`}>
                                                        {order.status}
                                                    </span>
                                                </div>
                                                <button
                                                    onClick={() => handleImportFromOrder(order.id)}
                                                    disabled={order.isImported}
                                                    className={`w-full mt-3 px-4 py-2 rounded-lg text-sm font-bold transition ${
                                                        order.isImported 
                                                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                                                            : 'bg-purple-600 text-white hover:bg-purple-700'
                                                    }`}
                                                >
                                                    <Icon icon="fa-download" className="mr-1" /> 
                                                    {order.isImported ? 'ดึงเข้ามาแล้ว' : 'นำเข้าสินค้าจากออเดอร์นี้'}
                                                </button>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                            <div className="p-5 border-t bg-white">
                                <button
                                    onClick={() => setIsImportFromOrderModalOpen(false)}
                                    className="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300 transition"
                                >
                                    ยกเลิก
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Tax Invoice Data Modal (Admin) */}
                {isTaxInvoiceModalOpen && editingOrderForTax && (
                    <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 text-gray-800 font-normal">
                        <div className="absolute inset-0 bg-black bg-opacity-70" onClick={() => setIsTaxInvoiceModalOpen(false)}></div>
                        <div className="bg-white w-full max-w-4xl rounded-2xl shadow-2xl z-10 overflow-hidden flex flex-col max-h-[90vh] font-normal">
                            <div className="p-4 bg-emerald-600 text-white font-bold flex justify-between items-center">
                                <span><Icon icon="fa-file-invoice-dollar" className="mr-2" />บันทึกข้อมูลภาษี - {editingOrderForTax.id}</span>
                                <button onClick={() => setIsTaxInvoiceModalOpen(false)}><Icon icon="fa-times"/></button>
                            </div>
                            <div className="p-6 overflow-y-auto flex-1 bg-gray-50">
                                <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <p className="text-sm text-blue-800 font-bold">
                                        <Icon icon="fa-info-circle" className="mr-1" />
                                        กรอกข้อมูลผู้เสียภาษีและตรวจสอบรายการสินค้า สามารถแก้ไขราคาได้
                                    </p>
                                </div>
                                
                                {/* Tax Information */}
                                <div className="bg-white rounded-lg border p-4 mb-4">
                                    <h3 className="font-bold text-lg mb-3 text-emerald-800">ข้อมูลผู้เสียภาษี</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ชื่อบริษัท / ผู้เสียภาษี *</label>
                                            <input
                                                type="text"
                                                value={taxInvoiceForm.taxName}
                                                onChange={(e) => setTaxInvoiceForm({...taxInvoiceForm, taxName: e.target.value})}
                                                className="w-full border rounded p-2 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="ระบุชื่อตามใบ ภ.พ. 20..."
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">เลขประจำตัวผู้เสียภาษี *</label>
                                            <input
                                                type="text"
                                                value={taxInvoiceForm.taxId}
                                                onChange={(e) => setTaxInvoiceForm({...taxInvoiceForm, taxId: e.target.value})}
                                                className="w-full border rounded p-2 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                placeholder="ระบุเลข 13 หลัก"
                                            />
                                        </div>
                                        <div className="md:col-span-2">
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ที่อยู่ (ตามหน้าบัตรหรือ ภ.พ. 20)</label>
                                            <textarea
                                                value={taxInvoiceForm.taxAddress}
                                                onChange={(e) => setTaxInvoiceForm({...taxInvoiceForm, taxAddress: e.target.value})}
                                                className="w-full border rounded p-2 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                rows="3"
                                                placeholder="ที่อยู่ (ตามหน้าบัตรหรือ ภ.พ. 20)"
                                            />
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Items List */}
                                <div className="bg-white rounded-lg border p-4 mb-4">
                                    <h3 className="font-bold text-lg mb-3 text-emerald-800">รายการสินค้า</h3>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead className="bg-gray-100 font-bold">
                                                <tr>
                                                    <th className="p-2 text-left">#</th>
                                                    <th className="p-2 text-left">รายการ</th>
                                                    <th className="p-2 text-center">จำนวน</th>
                                                    <th className="p-2 text-right">ราคา/หน่วย</th>
                                                    <th className="p-2 text-right">รวม</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y">
                                                {taxInvoiceForm.items.map((item, idx) => (
                                                    <tr key={idx}>
                                                        <td className="p-2">{idx + 1}</td>
                                                        <td className="p-2 font-bold">{item.name}</td>
                                                        <td className="p-2 text-center">{item.qty}</td>
                                                        <td className="p-2">
                                                            <input
                                                                type="number"
                                                                min="0"
                                                                step="0.01"
                                                                value={item.price}
                                                                onChange={(e) => {
                                                                    const newItems = [...taxInvoiceForm.items];
                                                                    newItems[idx].price = parseFloat(e.target.value) || 0;
                                                                    newItems[idx].total = newItems[idx].price * newItems[idx].qty;
                                                                    const newSubtotal = newItems.reduce((sum, i) => sum + i.total, 0);
                                                                    const newTotal = newSubtotal - taxInvoiceForm.discount + taxInvoiceForm.shipping;
                                                                    const newVat = newTotal * 7 / 107;
                                                                    const newPreVat = newTotal - newVat;
                                                                    setTaxInvoiceForm({
                                                                        ...taxInvoiceForm,
                                                                        items: newItems,
                                                                        subtotal: newSubtotal,
                                                                        total: newTotal,
                                                                        vat: newVat,
                                                                        preVat: newPreVat
                                                                    });
                                                                }}
                                                                className="w-24 border rounded p-1 text-right focus:ring-2 focus:ring-emerald-500 outline-none"
                                                            />
                                                        </td>
                                                        <td className="p-2 text-right font-bold">{item.total.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                {/* Summary */}
                                <div className="bg-white rounded-lg border p-4">
                                    <h3 className="font-bold text-lg mb-3 text-emerald-800">สรุปยอด</h3>
                                    <div className="space-y-2">
                                        <div className="flex justify-between">
                                            <span>รวมเงิน:</span>
                                            <span className="font-bold">{taxInvoiceForm.subtotal.toLocaleString(undefined, {minimumFractionDigits: 2})} บาท</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>ส่วนลด:</span>
                                            <span className="font-bold text-red-600">-{taxInvoiceForm.discount.toLocaleString(undefined, {minimumFractionDigits: 2})} บาท</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>ค่าขนส่ง:</span>
                                            <input
                                                type="number"
                                                min="0"
                                                step="0.01"
                                                value={taxInvoiceForm.shipping}
                                                onChange={(e) => {
                                                    const newShipping = parseFloat(e.target.value) || 0;
                                                    const newTotal = taxInvoiceForm.subtotal - taxInvoiceForm.discount + newShipping;
                                                    const newVat = newTotal * 7 / 107;
                                                    const newPreVat = newTotal - newVat;
                                                    setTaxInvoiceForm({
                                                        ...taxInvoiceForm,
                                                        shipping: newShipping,
                                                        total: newTotal,
                                                        vat: newVat,
                                                        preVat: newPreVat
                                                    });
                                                }}
                                                className="w-32 border rounded p-1 text-right focus:ring-2 focus:ring-emerald-500 outline-none"
                                            />
                                        </div>
                                        <div className="flex justify-between">
                                            <span>มูลค่าก่อนภาษี:</span>
                                            <span className="font-bold">{taxInvoiceForm.preVat.toLocaleString(undefined, {minimumFractionDigits: 2})} บาท</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>ภาษีมูลค่าเพิ่ม 7%:</span>
                                            <span className="font-bold">{taxInvoiceForm.vat.toLocaleString(undefined, {minimumFractionDigits: 2})} บาท</span>
                                        </div>
                                        <div className="flex justify-between pt-2 border-t-2 border-emerald-600">
                                            <span className="font-bold text-lg">ยอดสุทธิ:</span>
                                            <span className="font-bold text-lg text-emerald-700">{taxInvoiceForm.total.toLocaleString(undefined, {minimumFractionDigits: 2})} บาท</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="p-5 border-t bg-white flex justify-end gap-3">
                                <button
                                    onClick={() => setIsTaxInvoiceModalOpen(false)}
                                    className="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition"
                                >
                                    ยกเลิก
                                </button>
                                {taxInvoiceRecordedStatus[editingOrderForTax.id]?.recorded && (
                                    <button
                                        onClick={() => {
                                            setIsTaxInvoiceModalOpen(false);
                                            handlePrintFullInvoice(editingOrderForTax);
                                        }}
                                        className="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition"
                                    >
                                        <Icon icon="fa-print" className="mr-1" /> สั่งพิมพ์ใบกำกับ
                                    </button>
                                )}
                                <button
                                    onClick={handleSubmitTaxInvoiceData}
                                    className="px-6 py-2 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700 transition"
                                >
                                    <Icon icon="fa-save" className="mr-1" /> บันทึกข้อมูลภาษี
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
      };

      // Helper function for PO modal - ต้องใช้วิธีอื่นเพราะ React state

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>